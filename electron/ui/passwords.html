<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="design-tokens.css" />
<link rel="stylesheet" href="components.css" />
<style>
/* Unlock view */
.unlock-view {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 100vh; padding: var(--space-2xl);
}
.lock-icon { font-size: 48px; margin-bottom: var(--space-lg); animation: scaleIn var(--duration-normal) var(--spring); }
.unlock-title { font-size: var(--text-2xl); font-weight: 600; margin-bottom: var(--space-sm); }
.unlock-desc { color: var(--fg-muted); font-size: var(--text-md); margin-bottom: var(--space-xl); text-align: center; line-height: 1.5; }
.unlock-input {
  width: 320px; padding: 12px 16px; text-align: center; margin-bottom: var(--space-md);
}
.unlock-error { color: var(--danger-fg); font-size: var(--text-base); margin-top: var(--space-sm); min-height: 20px; }

/* Main view */
.toolbar-row { display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg); align-items: center; animation: itemSlideIn var(--duration-normal) var(--ease-out) 0.1s both; }
.toolbar-row .input { flex: 1; }

.cred-list { display: flex; flex-direction: column; gap: var(--space-sm); }
.cred-card {
  display: flex; align-items: center; padding: var(--space-lg); gap: var(--space-md);
  background: var(--glass-bg-solid); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border); border-radius: var(--radius-md);
  transition: all var(--duration-fast) var(--ease-out);
  animation: itemSlideIn var(--duration-normal) var(--ease-out) both;
}
.cred-card:hover { border-color: var(--accent-fg); background: var(--bg-subtle); }
.cred-icon {
  width: 36px; height: 36px; border-radius: var(--radius-sm); background: var(--bg-subtle);
  display: flex; align-items: center; justify-content: center; font-size: var(--text-md); flex-shrink: 0; overflow: hidden;
}
.cred-icon img { width: 20px; height: 20px; }
.cred-info { flex: 1; min-width: 0; }
.cred-url { font-size: var(--text-base); font-weight: 500; color: var(--accent-fg); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cred-user { font-size: var(--text-sm); color: var(--fg-muted); margin-top: 2px; }
.cred-actions { display: flex; gap: var(--space-xs); }
.cred-btn {
  padding: 4px 10px; border: 1px solid var(--border-muted); border-radius: var(--radius-sm);
  background: none; color: var(--fg-muted); cursor: pointer; font-size: var(--text-xs);
  font-family: var(--font-sans); transition: all var(--duration-fast);
}
.cred-btn:hover { border-color: var(--accent-fg); color: var(--accent-fg); }
.cred-btn.del:hover { border-color: var(--danger-fg); color: var(--danger-fg); }

/* Gen row in dialog */
.gen-row { display: flex; gap: var(--space-sm); align-items: center; margin-bottom: 10px; }
.gen-row .input { flex: 1; margin-bottom: 0; }
.gen-btn {
  padding: 8px 12px; border: 1px solid var(--border-default); border-radius: var(--radius-sm);
  background: var(--bg-subtle); color: var(--fg-muted); cursor: pointer; font-size: var(--text-sm); font-family: var(--font-sans);
}
.gen-btn:hover { color: var(--accent-fg); border-color: var(--accent-fg); }
</style>
</head>
<body>

<div id="unlock-view" class="unlock-view">
  <div class="lock-icon">üîí</div>
  <div class="unlock-title">Password Manager</div>
  <div class="unlock-desc">Enter your master password to unlock saved credentials.<br>First time? This will set your master password.</div>
  <input id="master-pw" class="input input-glass unlock-input" type="password" placeholder="Master password..." autofocus />
  <button class="btn btn-primary btn-pill" id="btn-unlock">Unlock</button>
  <div class="unlock-error" id="unlock-error"></div>
</div>

<div id="main-view" style="display:none">
  <div class="page-container" style="max-width:640px">
    <div class="page-header"><div class="page-title">üîë Password Manager</div></div>
    <div class="page-desc">Manage your saved credentials securely.</div>
    <div class="toolbar-row">
      <input class="input input-glass" id="pw-search" type="text" placeholder="Search by URL..." />
      <button class="btn btn-primary btn-pill" id="btn-add">+ Add</button>
      <button class="btn btn-pill" id="btn-gen">Generate</button>
      <button class="btn btn-danger btn-pill" id="btn-lock">Lock</button>
    </div>
    <div class="cred-list" id="cred-list"></div>
  </div>
</div>

<script>
const gb = window.gitbrowser;
let allCreds = [];
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

document.getElementById('btn-unlock').onclick = doUnlock;
document.getElementById('master-pw').addEventListener('keydown', (e) => { if (e.key === 'Enter') doUnlock(); });

async function doUnlock() {
  const pw = document.getElementById('master-pw').value;
  if (!pw) return;
  const errEl = document.getElementById('unlock-error');
  errEl.textContent = '';
  const res = await gb.passwordUnlock({ masterPassword: pw });
  if (res && res.error) { errEl.textContent = res.error; return; }
  if (res && res.ok === false) { errEl.textContent = 'Wrong master password'; return; }
  document.getElementById('unlock-view').style.display = 'none';
  document.getElementById('main-view').style.display = '';
  loadCredentials();
}

gb.passwordIsUnlocked().then(res => {
  if (res && res.unlocked) {
    document.getElementById('unlock-view').style.display = 'none';
    document.getElementById('main-view').style.display = '';
    loadCredentials();
  }
}).catch(() => {});

async function loadCredentials(query) {
  const res = await gb.passwordList({ url: query || '' });
  if (res && res.error) { document.getElementById('cred-list').innerHTML = '<div class="empty-state">Error: ' + esc(res.error) + '</div>'; return; }
  allCreds = Array.isArray(res) ? res : [];
  renderCreds(allCreds);
}

function renderCreds(creds) {
  const el = document.getElementById('cred-list');
  if (!creds.length) { el.innerHTML = '<div class="empty-state">No saved passwords</div>'; return; }
  el.innerHTML = '';
  creds.forEach((c, i) => {
    const div = document.createElement('div');
    div.className = 'cred-card';
    div.style.animationDelay = i * 30 + 'ms';
    let fav = '';
    try { fav = 'https://www.google.com/s2/favicons?sz=32&domain=' + new URL(c.url).hostname; } catch {}
    const ic = fav ? `<img src="${esc(fav)}" onerror="this.parentElement.textContent='üîë'" />` : 'üîë';
    div.innerHTML = `<div class="cred-icon">${ic}</div>
      <div class="cred-info"><div class="cred-url">${esc(c.url)}</div><div class="cred-user">${esc(c.username)}</div></div>
      <div class="cred-actions">
        <button class="cred-btn" onclick="copyPw(${i})" title="Copy password">üìã</button>
        <button class="cred-btn" onclick="editCred(${i})" title="Edit">‚úèÔ∏è</button>
        <button class="cred-btn del" onclick="deleteCred('${esc(c.id)}')" title="Delete">üóëÔ∏è</button>
      </div>`;
    el.appendChild(div);
  });
}

async function copyPw(idx) { const c = allCreds[idx]; if (c && c.password) try { await navigator.clipboard.writeText(c.password); } catch {} }
async function deleteCred(id) { await gb.passwordDelete({ id }); loadCredentials(document.getElementById('pw-search').value.trim()); }

let searchTimer;
document.getElementById('pw-search').addEventListener('input', (e) => { clearTimeout(searchTimer); searchTimer = setTimeout(() => loadCredentials(e.target.value.trim()), 300); });

document.getElementById('btn-lock').onclick = async () => {
  await gb.passwordLock();
  document.getElementById('main-view').style.display = 'none';
  document.getElementById('unlock-view').style.display = '';
  document.getElementById('master-pw').value = '';
  document.getElementById('unlock-error').textContent = '';
};

function showCredDialog(title, defaults, onSave) {
  const overlay = document.createElement('div');
  overlay.className = 'dialog-overlay';
  overlay.innerHTML = `<div class="dialog" style="animation:scaleIn var(--duration-normal) var(--spring)">
    <h3>${esc(title)}</h3>
    <input class="input" id="d-url" value="${esc(defaults.url || '')}" placeholder="https://..." style="margin-bottom:10px" />
    <input class="input" id="d-user" value="${esc(defaults.username || '')}" placeholder="user@example.com" style="margin-bottom:10px" />
    <div class="gen-row">
      <input class="input" id="d-pw" type="text" value="${esc(defaults.password || '')}" placeholder="password" />
      <button class="gen-btn" id="d-gen">üé≤</button>
    </div>
    <div class="dialog-actions">
      <button class="btn btn-ghost" id="d-cancel">Cancel</button>
      <button class="btn btn-primary btn-pill" id="d-save">Save</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('#d-cancel').onclick = () => overlay.remove();
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
  overlay.querySelector('#d-gen').onclick = async () => {
    const res = await gb.passwordGenerate({ length: 20, uppercase: true, lowercase: true, numbers: true, symbols: true });
    if (res && res.password) overlay.querySelector('#d-pw').value = res.password;
  };
  overlay.querySelector('#d-save').onclick = () => {
    const url = overlay.querySelector('#d-url').value.trim(), username = overlay.querySelector('#d-user').value.trim(), password = overlay.querySelector('#d-pw').value;
    if (!url || !username || !password) return;
    onSave({ url, username, password }); overlay.remove();
  };
  overlay.querySelector('#d-url').focus();
}

document.getElementById('btn-add').onclick = () => {
  showCredDialog('Add Credential', {}, async (data) => { await gb.passwordSave(data); loadCredentials(document.getElementById('pw-search').value.trim()); });
};

function editCred(idx) {
  const c = allCreds[idx]; if (!c) return;
  showCredDialog('Edit Credential', c, async (data) => { await gb.passwordUpdate({ id: c.id, username: data.username, password: data.password }); loadCredentials(document.getElementById('pw-search').value.trim()); });
}

document.getElementById('btn-gen').onclick = async () => {
  const res = await gb.passwordGenerate({ length: 20, uppercase: true, lowercase: true, numbers: true, symbols: true });
  if (res && res.password) { try { await navigator.clipboard.writeText(res.password); } catch {} alert('Generated password copied to clipboard:\n' + res.password); }
};

function applyTheme(t) { document.documentElement.classList.toggle('light', t === 'Light'); }
if (gb) { gb.onThemeChanged((d) => applyTheme(d.theme)); gb.getSettings().then(s => { if(s&&s.appearance){let t=s.appearance.theme;if(t==='System')t=window.matchMedia('(prefers-color-scheme:light)').matches?'Light':'Dark';applyTheme(t)} }).catch(()=>{}); }
</script>
</body>
</html>