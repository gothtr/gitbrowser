<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="design-tokens.css" />
<link rel="stylesheet" href="components.css" />
<style>
.center { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
.container { text-align: center; max-width: 480px; padding: var(--space-2xl); }
.gh-icon { margin-bottom: var(--space-xl); color: var(--fg-default); }
.title { font-size: var(--text-2xl); font-weight: 600; margin-bottom: var(--space-sm); }
.desc { color: var(--fg-muted); font-size: var(--text-md); line-height: 1.6; margin-bottom: var(--space-xl); }
.login-btn {
  display: inline-flex; align-items: center; gap: var(--space-sm);
  padding: var(--space-md) var(--space-xl); border: 1px solid var(--glass-border); border-radius: var(--radius-md);
  background: rgba(255, 255, 255, 0.04); color: var(--fg-default); cursor: pointer;
  font-family: var(--font-sans); font-size: var(--text-md); font-weight: 500;
  transition: all var(--duration-fast); box-shadow: var(--glass-inner-glow);
}
.login-btn:hover { background: var(--glass-bg-active); border-color: var(--accent-emphasis); color: var(--accent-fg); box-shadow: 0 0 0 3px var(--accent-glow), var(--glass-inner-glow); }
.input-row { margin-bottom: var(--space-lg); }
.input-row input {
  width: 100%; max-width: 320px; padding: var(--space-sm) var(--space-md);
  border: 1px solid var(--glass-border); border-radius: var(--radius-md);
  background: rgba(255, 255, 255, 0.04); color: var(--fg-default);
  font-family: var(--font-sans); font-size: var(--text-base); outline: none; text-align: center;
  box-shadow: var(--glass-inner-glow);
  transition: all var(--duration-fast) var(--ease-out);
}
.input-row input:focus { border-color: var(--accent-emphasis); box-shadow: 0 0 0 3px var(--accent-glow), var(--glass-inner-glow); }
.input-row label { display: block; font-size: var(--text-sm); color: var(--fg-muted); margin-bottom: 6px; }
.device-code { font-size: 32px; font-weight: 700; letter-spacing: 4px; color: var(--accent-fg); margin: var(--space-lg) 0; }
.device-link { color: var(--accent-fg); text-decoration: underline; cursor: pointer; font-size: var(--text-md); }
.spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--fg-subtle); border-top-color: var(--accent-fg); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 8px; vertical-align: middle; }
.status { color: var(--fg-muted); font-size: var(--text-base); margin-top: var(--space-md); }
.features { margin-top: var(--space-xl); text-align: left; }
.feature { display: flex; align-items: flex-start; gap: var(--space-sm); padding: var(--space-sm) 0; border-bottom: 1px solid var(--glass-border); }
.feature:last-child { border-bottom: none; }
.feature-icon { color: var(--success-fg); flex-shrink: 0; margin-top: 2px; }
.feature-text { font-size: var(--text-base); color: var(--fg-muted); }
.feature-text strong { color: var(--fg-default); }

/* Profile view */
.profile-view { max-width: 700px; margin: 0 auto; padding: var(--space-xl); }
.profile-header { display: flex; align-items: center; gap: var(--space-lg); margin-bottom: var(--space-sm); }
.avatar { width: 56px; height: 56px; border-radius: 50%; border: 2px solid var(--glass-border); }
.profile-info { flex: 1; }
.profile-name { font-size: var(--text-xl); font-weight: 600; }
.profile-login { font-size: var(--text-md); color: var(--fg-muted); }
.profile-bio { font-size: var(--text-base); color: var(--fg-muted); margin-top: 2px; }
.profile-stats { display: flex; gap: var(--space-lg); margin: var(--space-md) 0 var(--space-lg); font-size: var(--text-base); color: var(--fg-muted); }
.profile-stats span { cursor: pointer; } .profile-stats span:hover { color: var(--accent-fg); }
.profile-stats strong { color: var(--fg-default); }

.tab-bar { display: flex; gap: 0; border-bottom: 1px solid var(--glass-border); margin-bottom: var(--space-lg); }
.tab-btn {
  padding: var(--space-sm) var(--space-lg); font-size: var(--text-base); font-weight: 500; color: var(--fg-muted);
  background: none; border: none; border-bottom: 2px solid transparent;
  cursor: pointer; font-family: var(--font-sans); transition: all var(--duration-fast); position: relative;
}
.tab-btn:hover { color: var(--fg-default); }
.tab-btn.active { color: var(--fg-default); border-bottom-color: var(--accent-emphasis); }
.tab-btn .badge { margin-left: 6px; }
.tab-content { min-height: 300px; }

.item-card {
  display: flex; align-items: flex-start; padding: var(--space-md);
  background: var(--glass-bg-solid); backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border); border-radius: var(--radius-md);
  margin-bottom: var(--space-sm); cursor: pointer; transition: all var(--duration-fast); gap: var(--space-sm);
}
.item-card:hover { border-color: var(--accent-fg); transform: translateY(-1px); box-shadow: var(--glass-shadow); }
.item-title { font-size: var(--text-base); font-weight: 500; color: var(--accent-fg); }
.item-desc { font-size: var(--text-sm); color: var(--fg-muted); margin-top: 2px; }
.item-meta { font-size: var(--text-xs); color: var(--fg-subtle); margin-top: var(--space-xs); display: flex; gap: var(--space-md); align-items: center; }
.state-badge { display: inline-block; padding: 2px 8px; border-radius: var(--radius-pill); font-size: var(--text-xs); font-weight: 500; }
.state-open { background: rgba(63,185,80,0.15); color: var(--open-fg); }
.state-closed { background: rgba(248,81,73,0.15); color: var(--closed-fg); }
.state-merged { background: rgba(163,113,247,0.15); color: var(--merged-fg); }
.notif-unread { border-left: 3px solid var(--accent-emphasis); }
.notif-reason { font-size: var(--text-xs); color: var(--fg-subtle); text-transform: capitalize; }
.loading-state { text-align: center; padding: var(--space-3xl) var(--space-lg); color: var(--fg-subtle); font-size: var(--text-base); }

.quick-actions { display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg); flex-wrap: wrap; }
.quick-action {
  padding: 6px 14px; border: 1px solid var(--glass-border); border-radius: var(--radius-pill);
  background: rgba(255, 255, 255, 0.04); color: var(--fg-muted); cursor: pointer;
  font-family: var(--font-sans); font-size: var(--text-sm); transition: all var(--duration-fast);
}
.quick-action:hover { border-color: var(--accent-emphasis); color: var(--accent-fg); }
.logout-btn {
  margin-top: var(--space-lg); padding: var(--space-sm) var(--space-lg);
  border: 1px solid var(--glass-border); border-radius: var(--radius-md);
  background: none; color: var(--fg-muted); cursor: pointer;
  font-family: var(--font-sans); font-size: var(--text-sm); transition: all var(--duration-fast);
}
.logout-btn:hover { border-color: var(--danger-fg); color: var(--danger-fg); }
.filter-row { display: flex; gap: var(--space-sm); margin-bottom: var(--space-md); }
.filter-btn {
  padding: 4px 12px; border: 1px solid var(--glass-border); border-radius: var(--radius-pill);
  background: none; color: var(--fg-muted); cursor: pointer; font-family: var(--font-sans); font-size: var(--text-sm);
  transition: all var(--duration-fast);
}
.filter-btn:hover { border-color: var(--accent-fg); color: var(--accent-fg); }
.filter-btn.active { background: var(--accent-emphasis); color: #fff; border-color: var(--accent-emphasis); }
</style>
</head>
<body>

<div class="center" id="login-view">
<div class="container">
  <div class="gh-icon"><svg width="48" height="48" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg></div>
  <div class="title">GitHub Integration</div>
  <div class="desc">Connect via OAuth Device Flow — secure, no password needed.</div>
  <div class="input-row" style="display:none"><label>GitHub OAuth App Client ID</label><input id="client-id" type="text" value="Ov23licJwKwUSbHm9XF2" /></div>
  <button class="login-btn" id="btn-login"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg> Sign in with GitHub</button>
  <div class="features">
    <div class="feature"><div class="feature-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg></div><div class="feature-text"><strong>Quick access</strong> to repos, PRs, issues, notifications</div></div>
    <div class="feature"><div class="feature-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg></div><div class="feature-text"><strong>Secure OAuth</strong> — no tokens stored in browser</div></div>
    <div class="feature"><div class="feature-icon"><svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg></div><div class="feature-text"><strong>Notification badges</strong> in toolbar</div></div>
  </div>
</div>
</div>

<div class="center" id="device-view" style="display:none">
<div class="container">
  <div class="title">Authorize GitBrowser</div>
  <div class="desc">Go to the link below and enter this code:</div>
  <div class="device-code" id="user-code"></div>
  <div><a class="device-link" id="verify-link" target="_blank"></a></div>
  <div class="status" id="poll-status"><span class="spinner"></span>Waiting for authorization...</div>
</div>
</div>

<div id="profile-view" style="display:none">
<div class="profile-view">
  <div class="profile-header">
    <img class="avatar" id="avatar" src="" alt="" />
    <div class="profile-info">
      <div class="profile-name" id="profile-name"></div>
      <div class="profile-login" id="profile-login"></div>
      <div class="profile-bio" id="profile-bio"></div>
    </div>
  </div>
  <div class="profile-stats" id="profile-stats"></div>
  <div class="quick-actions" id="quick-actions">
    <button class="quick-action" id="qa-new-repo">+ New Repo</button>
    <button class="quick-action" id="qa-new-gist">+ New Gist</button>
    <button class="quick-action" id="qa-profile">View Profile</button>
    <button class="quick-action" id="qa-sync-upload" title="Upload bookmarks to GitHub Gist">⬆ Sync Bookmarks</button>
    <button class="quick-action" id="qa-sync-download" title="Download bookmarks from GitHub Gist">⬇ Import Bookmarks</button>
  </div>
  <div class="tab-bar" id="tab-bar">
    <button class="tab-btn active" data-tab="repos">Repos</button>
    <button class="tab-btn" data-tab="notifications">Notifications <span class="badge badge-accent" id="notif-badge" style="display:none">0</span></button>
    <button class="tab-btn" data-tab="issues">Issues</button>
    <button class="tab-btn" data-tab="prs">Pull Requests</button>
    <button class="tab-btn" data-tab="activity">Activity</button>
  </div>
  <div class="tab-content" id="tab-content"></div>
  <button class="logout-btn" id="btn-logout">Sign out</button>
</div>
</div>
<script>
const gb = window.gitbrowser;
let ghToken = localStorage.getItem('gh_token'), ghClientId = 'Ov23licJwKwUSbHm9XF2';
let currentUser = null, activeTab = 'repos', cachedData = {}, issueFilter = 'assigned', prFilter = 'assigned';

(async () => {
  if (!ghToken && gb && gb.secretGet) { try { const r = await gb.secretGet('github_token'); if (r && r.value) { ghToken = r.value; localStorage.setItem('gh_token', ghToken); } } catch {} }
  init();
})();

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function timeAgo(d) { const s = Math.floor((Date.now() - new Date(d).getTime()) / 1000); if (s < 60) return 'just now'; if (s < 3600) return Math.floor(s/60)+'m ago'; if (s < 86400) return Math.floor(s/3600)+'h ago'; if (s < 2592000) return Math.floor(s/86400)+'d ago'; return new Date(d).toLocaleDateString(); }
async function ghApi(endpoint, token) { if (!gb) return { error: 'No bridge' }; return gb.githubApi({ endpoint, token: token || ghToken }); }
function showView(id) { ['login-view','device-view','profile-view'].forEach(v => { document.getElementById(v).style.display = v === id ? '' : 'none'; }); }
function openGh(path) { const url = path.startsWith('http') ? path : 'https://github.com' + path; if (gb) gb.openUrlNewTab(url); }

document.getElementById('btn-login').onclick = async () => {
  const clientId = ghClientId;
  const res = await gb.githubDeviceLogin({ clientId });
  if (res.error) { alert('Error: ' + res.error); return; }
  document.getElementById('user-code').textContent = res.userCode;
  const link = document.getElementById('verify-link');
  link.textContent = res.verificationUri; link.href = res.verificationUri;
  link.onclick = (e) => { e.preventDefault(); gb.openUrl(res.verificationUri); };
  showView('device-view');
  pollForToken(clientId, res.deviceCode, (res.interval || 5) * 1000);
};

async function pollForToken(clientId, deviceCode, interval) {
  const statusEl = document.getElementById('poll-status');
  const poll = async () => {
    const res = await gb.githubDevicePoll({ clientId, deviceCode });
    if (res.status === 'ok') { ghToken = res.token; localStorage.setItem('gh_token', ghToken); if (gb && gb.secretStore) gb.secretStore('github_token', ghToken).catch(() => {}); loadProfile(ghToken); return; }
    if (res.status === 'expired') { statusEl.innerHTML = 'Code expired. Please try again.'; setTimeout(() => showView('login-view'), 2000); return; }
    if (res.status === 'error') { statusEl.innerHTML = 'Error: ' + esc(res.error); return; }
    setTimeout(poll, res.status === 'slow_down' ? interval + 5000 : interval);
  };
  setTimeout(poll, interval);
}

async function loadProfile(token) {
  showView('profile-view');
  const user = await ghApi('/user', token);
  if (user.error) { localStorage.removeItem('gh_token'); ghToken = null; showView('login-view'); return; }
  currentUser = user;
  document.getElementById('avatar').src = user.avatar_url || '';
  document.getElementById('profile-name').textContent = user.name || user.login;
  document.getElementById('profile-login').textContent = '@' + user.login;
  document.getElementById('profile-bio').textContent = user.bio || '';
  document.getElementById('profile-stats').innerHTML = `<span onclick="openGh('/${esc(user.login)}?tab=followers')"><strong>${user.followers||0}</strong> followers</span><span onclick="openGh('/${esc(user.login)}?tab=following')"><strong>${user.following||0}</strong> following</span><span><strong>${user.public_repos||0}</strong> repos</span>${user.public_gists?`<span><strong>${user.public_gists}</strong> gists</span>`:''}`;
  document.getElementById('qa-new-repo').onclick = () => openGh('/new');
  document.getElementById('qa-new-gist').onclick = () => openGh('https://gist.github.com');
  document.getElementById('qa-profile').onclick = () => openGh('/' + user.login);
  document.getElementById('qa-sync-upload').onclick = async () => { const btn = document.getElementById('qa-sync-upload'); btn.textContent = '⏳ Syncing...'; btn.disabled = true; try { const r = await gb.githubSyncBookmarksUpload({ token: ghToken }); btn.textContent = r.ok ? '✓ Synced' : '✕ Error'; } catch { btn.textContent = '✕ Error'; } setTimeout(() => { btn.textContent = '⬆ Sync Bookmarks'; btn.disabled = false; }, 2000); };
  document.getElementById('qa-sync-download').onclick = async () => { const btn = document.getElementById('qa-sync-download'); btn.textContent = '⏳ Importing...'; btn.disabled = true; try { const r = await gb.githubSyncBookmarksDownload({ token: ghToken }); btn.textContent = r.ok ? '✓ Imported '+(r.imported||0) : '✕ '+(r.error||'Error'); } catch { btn.textContent = '✕ Error'; } setTimeout(() => { btn.textContent = '⬇ Import Bookmarks'; btn.disabled = false; }, 3000); };
  document.querySelectorAll('.tab-btn').forEach(btn => { btn.onclick = () => switchGhTab(btn.dataset.tab); });
  document.getElementById('btn-logout').onclick = () => { localStorage.removeItem('gh_token'); ghToken = null; currentUser = null; cachedData = {}; if (gb && gb.secretDelete) gb.secretDelete('github_token').catch(() => {}); if (gb && gb.githubLogout) gb.githubLogout().catch(() => {}); showView('login-view'); };
  loadTab('repos'); loadNotifCount(token);
}

function switchGhTab(tab) { activeTab = tab; document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab)); loadTab(tab); }

async function loadTab(tab) {
  const content = document.getElementById('tab-content');
  content.innerHTML = '<div class="loading-state"><span class="spinner"></span> Loading...</div>';
  switch (tab) { case 'repos': await loadRepos(content); break; case 'notifications': await loadNotifications(content); break; case 'issues': await loadIssues(content); break; case 'prs': await loadPRs(content); break; case 'activity': await loadActivity(content); break; }
}

async function loadNotifCount(token) {
  const data = await ghApi('/notifications?per_page=1', token);
  if (Array.isArray(data) && data.length > 0) { const all = await ghApi('/notifications?per_page=50', token); const count = Array.isArray(all) ? all.length : 0; const badge = document.getElementById('notif-badge'); badge.textContent = count > 99 ? '99+' : count; badge.style.display = count > 0 ? '' : 'none'; cachedData.notifications = all; }
}

async function loadRepos(el) {
  const data = cachedData.repos || await ghApi('/user/repos?sort=updated&per_page=30');
  if (data.error) { el.innerHTML = '<div class="empty-state">Failed to load repos</div>'; return; }
  cachedData.repos = data;
  if (!data.length) { el.innerHTML = '<div class="empty-state">No repositories</div>'; return; }
  el.innerHTML = data.map(r => `<div class="item-card" onclick="openGh('/${esc(r.full_name)}')"><div style="flex:1"><div class="item-title">${esc(r.full_name)}</div>${r.description?`<div class="item-desc">${esc(r.description)}</div>`:''}<div class="item-meta">${r.language?`<span>${esc(r.language)}</span>`:''}<span><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-1px"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/></svg> ${r.stargazers_count}</span><span><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-1px"><path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 1 1.5 0v.878a2.25 2.25 0 0 1-2.25 2.25h-1.5v2.128a2.251 2.251 0 1 1-1.5 0V8.5h-1.5A2.25 2.25 0 0 1 3.5 6.25v-.878a2.25 2.25 0 1 1 1.5 0ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Zm6.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm-3 8.75a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"/></svg> ${r.forks_count}</span><span>${timeAgo(r.updated_at)}</span>${r.private?'<span style="color:var(--fg-subtle)"><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-1px"><path d="M4 4a4 4 0 0 1 8 0v2h.25c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 12.25 15h-8.5A1.75 1.75 0 0 1 2 13.25v-5.5C2 6.784 2.784 6 3.75 6H4Zm8.25 3.5h-8.5a.25.25 0 0 0-.25.25v5.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25ZM10.5 6V4a2.5 2.5 0 1 0-5 0v2Z"/></svg> Private</span>':''}</div></div></div>`).join('');
}

async function loadNotifications(el) {
  const data = cachedData.notifications || await ghApi('/notifications?per_page=50');
  if (data.error) { el.innerHTML = '<div class="empty-state">Failed to load notifications</div>'; return; }
  cachedData.notifications = data;
  if (!data.length) { el.innerHTML = '<div class="empty-state">No notifications</div>'; return; }
  el.innerHTML = data.map(n => { const unread = n.unread ? ' notif-unread' : ''; const icon = n.subject.type === 'PullRequest' ? '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="color:var(--merged-fg)"><path d="M5.45 5.154A4.25 4.25 0 0 0 9.25 7.5h1.378a2.251 2.251 0 1 1 0 1.5H9.25A5.734 5.734 0 0 1 5 7.123v3.505a2.25 2.25 0 1 1-1.5 0V5.372a2.25 2.25 0 1 1 1.95-.218ZM4.25 13.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm8-8a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5ZM5 3.25a.75.75 0 1 0-1.5 0 .75.75 0 0 0 1.5 0Z"/></svg>' : n.subject.type === 'Issue' ? '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="color:var(--open-fg)"><path d="M8 9.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Z"/></svg>' : '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="color:var(--fg-muted)"><path d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1ZM1.5 2.75v5.5c0 .138.112.25.25.25h1a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h3.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13 2a.25.25 0 0 0-.25-.25h-.5a.75.75 0 0 1 0-1.5h.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 14.25 12H14v1.543a1.458 1.458 0 0 1-2.487 1.03L9.22 12.28a.749.749 0 1 1 1.06-1.06l2.22 2.22v-2.19a.75.75 0 0 1 .75-.75h1a.25.25 0 0 0 .25-.25Z"/></svg>'; const repo = n.repository ? n.repository.full_name : ''; return `<div class="item-card${unread}" onclick="openNotif('${esc(n.subject.url||'')}','${esc(n.subject.type)}')"><div style="font-size:18px;display:flex;align-items:center">${icon}</div><div style="flex:1"><div class="item-title">${esc(n.subject.title)}</div><div class="item-meta"><span>${esc(repo)}</span><span class="notif-reason">${esc(n.reason)}</span><span>${timeAgo(n.updated_at)}</span></div></div></div>`; }).join('');
}

async function openNotif(apiUrl, type) { if (!apiUrl) return; try { const data = await ghApi(apiUrl.replace('https://api.github.com', '')); if (data.html_url) openGh(data.html_url); } catch {} }

async function loadIssues(el) {
  const filterHtml = `<div class="filter-row"><button class="filter-btn${issueFilter==='assigned'?' active':''}" onclick="setIssueFilter('assigned')">Assigned</button><button class="filter-btn${issueFilter==='created'?' active':''}" onclick="setIssueFilter('created')">Created</button><button class="filter-btn${issueFilter==='mentioned'?' active':''}" onclick="setIssueFilter('mentioned')">Mentioned</button></div>`;
  const key = 'issues_' + issueFilter;
  const data = cachedData[key] || await ghApi('/issues?filter=' + issueFilter + '&state=open&per_page=30');
  if (data.error) { el.innerHTML = filterHtml + '<div class="empty-state">Failed to load issues</div>'; return; }
  cachedData[key] = data;
  if (!data.length) { el.innerHTML = filterHtml + '<div class="empty-state">No open issues</div>'; return; }
  el.innerHTML = filterHtml + data.map(i => { const repo = i.repository ? i.repository.full_name : (i.html_url||'').split('/').slice(3,5).join('/'); return `<div class="item-card" onclick="openGh('${esc(i.html_url)}')"><div style="flex:1"><div class="item-title"><span class="state-badge state-open">open</span> ${esc(i.title)}</div><div class="item-meta"><span>${esc(repo)}</span><span>#${i.number}</span><span>${timeAgo(i.created_at)}</span>${i.comments?`<span><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-1px"><path d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1ZM1.5 2.75v5.5c0 .138.112.25.25.25h1a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h3.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Z"/></svg> ${i.comments}</span>`:''}</div></div></div>`; }).join('');
}
function setIssueFilter(f) { issueFilter = f; delete cachedData['issues_'+f]; loadTab('issues'); }

async function loadPRs(el) {
  const filterHtml = `<div class="filter-row"><button class="filter-btn${prFilter==='assigned'?' active':''}" onclick="setPrFilter('assigned')">Assigned</button><button class="filter-btn${prFilter==='created'?' active':''}" onclick="setPrFilter('created')">Created</button><button class="filter-btn${prFilter==='review'?' active':''}" onclick="setPrFilter('review')">Review Requested</button></div>`;
  let endpoint = prFilter === 'review' ? '/search/issues?q=type:pr+state:open+review-requested:'+(currentUser?currentUser.login:'')+'&per_page=30' : '/search/issues?q=type:pr+state:open+'+prFilter+':'+(currentUser?currentUser.login:'')+'&per_page=30';
  const key = 'prs_' + prFilter;
  let data = cachedData[key];
  if (!data) { const res = await ghApi(endpoint); data = res.items || res; if (res.error) { el.innerHTML = filterHtml + '<div class="empty-state">Failed to load PRs</div>'; return; } cachedData[key] = data; }
  if (!data.length) { el.innerHTML = filterHtml + '<div class="empty-state">No open pull requests</div>'; return; }
  el.innerHTML = filterHtml + data.map(pr => { const repo = (pr.html_url||'').split('/').slice(3,5).join('/'); const merged = pr.pull_request && pr.pull_request.merged_at; const sc = merged ? 'state-merged' : pr.state === 'closed' ? 'state-closed' : 'state-open'; const sl = merged ? 'merged' : pr.state; return `<div class="item-card" onclick="openGh('${esc(pr.html_url)}')"><div style="flex:1"><div class="item-title"><span class="state-badge ${sc}">${sl}</span> ${esc(pr.title)}</div><div class="item-meta"><span>${esc(repo)}</span><span>#${pr.number}</span><span>${timeAgo(pr.created_at)}</span>${pr.comments?`<span><svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-1px"><path d="M1.75 1h8.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 10.25 10H7.061l-2.574 2.573A1.458 1.458 0 0 1 2 11.543V10h-.25A1.75 1.75 0 0 1 0 8.25v-5.5C0 1.784.784 1 1.75 1ZM1.5 2.75v5.5c0 .138.112.25.25.25h1a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h3.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Z"/></svg> ${pr.comments}</span>`:''}</div></div></div>`; }).join('');
}
function setPrFilter(f) { prFilter = f; delete cachedData['prs_'+f]; loadTab('prs'); }

async function loadActivity(el) {
  if (!currentUser) { el.innerHTML = '<div class="empty-state">Not logged in</div>'; return; }
  const data = cachedData.activity || await ghApi('/users/'+currentUser.login+'/received_events?per_page=30');
  if (data.error) { el.innerHTML = '<div class="empty-state">Failed to load activity</div>'; return; }
  cachedData.activity = data;
  if (!data.length) { el.innerHTML = '<div class="empty-state">No recent activity</div>'; return; }
  el.innerHTML = data.map(ev => { const repo = ev.repo ? ev.repo.name : ''; const actor = ev.actor ? ev.actor.login : ''; let desc = '';
    switch(ev.type){case 'PushEvent':desc=`pushed ${(ev.payload.commits||[]).length} commit(s)`;break;case 'CreateEvent':desc=`created ${ev.payload.ref_type||'repo'}${ev.payload.ref?' '+ev.payload.ref:''}`;break;case 'WatchEvent':desc='starred';break;case 'ForkEvent':desc='forked';break;case 'IssuesEvent':desc=`${ev.payload.action} issue #${ev.payload.issue?ev.payload.issue.number:''}`;break;case 'PullRequestEvent':desc=`${ev.payload.action} PR #${ev.payload.pull_request?ev.payload.pull_request.number:''}`;break;case 'IssueCommentEvent':desc=`commented on #${ev.payload.issue?ev.payload.issue.number:''}`;break;default:desc=ev.type.replace('Event','').replace(/([A-Z])/g,' $1').trim().toLowerCase()}
    return `<div class="item-card" onclick="openGh('/${esc(repo)}')"><div style="flex:1"><div class="item-title" style="color:var(--fg-default)">${esc(actor)} <span style="color:var(--fg-muted);font-weight:400">${esc(desc)}</span></div><div class="item-meta"><span>${esc(repo)}</span><span>${timeAgo(ev.created_at)}</span></div></div></div>`; }).join('');
}

function applyTheme(t) { document.documentElement.classList.add('theme-transition'); document.documentElement.classList.toggle('light', t === 'Light'); setTimeout(() => document.documentElement.classList.remove('theme-transition'), 300); }
if (gb) { gb.onThemeChanged((d) => applyTheme(d.theme)); gb.getSettings().then(s => { if(s&&s.appearance){let t=s.appearance.theme;if(t==='System')t=window.matchMedia('(prefers-color-scheme:light)').matches?'Light':'Dark';applyTheme(t)} }).catch(()=>{}); }
document.getElementById('client-id').value = ghClientId;
function init() { if (ghToken) loadProfile(ghToken); }
</script>
</body>
</html>