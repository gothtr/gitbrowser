<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="design-tokens.css" />
<link rel="stylesheet" href="components.css" />
<style>
.dl-list { display: flex; flex-direction: column; gap: var(--space-md); }

.dl-card {
  background: var(--glass-bg-solid); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border); border-radius: var(--radius-md);
  padding: var(--space-lg); transition: border-color var(--duration-fast);
  animation: cardIn var(--duration-normal) var(--ease-out) both;
}
.dl-card:hover { border-color: var(--border-default); }
@keyframes cardIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

.dl-top { display: flex; align-items: center; gap: var(--space-md); }
.dl-icon { color: var(--accent-fg); flex-shrink: 0; }
.dl-info { flex: 1; min-width: 0; }
.dl-name { font-size: var(--text-md); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dl-status { font-size: var(--text-sm); color: var(--fg-muted); margin-top: 2px; }
.dl-status.done { color: var(--success-fg); }
.dl-status.error { color: var(--danger-fg); }

.dl-controls { display: flex; gap: var(--space-xs); }
.dl-btn {
  width: 28px; height: 28px; border: 1px solid var(--border-default); background: var(--bg-subtle);
  color: var(--fg-muted); cursor: pointer; border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center; font-size: 12px;
  transition: all var(--duration-fast);
}
.dl-btn:hover { border-color: var(--accent-fg); color: var(--accent-fg); }
.dl-btn.cancel:hover { border-color: var(--danger-fg); color: var(--danger-fg); }

.done-actions { display: flex; gap: var(--space-xs); }
.done-btn {
  padding: 4px 12px; border: 1px solid var(--border-default); border-radius: var(--radius-pill);
  background: none; color: var(--fg-muted); cursor: pointer; font-size: var(--text-xs);
  font-family: var(--font-sans); transition: all var(--duration-fast); white-space: nowrap;
}
.done-btn:hover { border-color: var(--accent-fg); color: var(--accent-fg); }

.progress { height: 4px; background: var(--bg-subtle); border-radius: 2px; margin-top: var(--space-sm); overflow: hidden; }
.progress-bar {
  height: 100%; background: var(--accent-emphasis); border-radius: 2px;
  transition: width 0.3s ease; position: relative; overflow: hidden;
}
.progress-bar::after {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  animation: shimmer 1.5s ease-in-out infinite;
}
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
.progress-bar.done { background: var(--success-fg); }
.progress-bar.done::after, .progress-bar.error::after { display: none; }
.progress-bar.error { background: var(--danger-fg); }

.empty-state svg { width: 48px; height: 48px; }
</style>
</head>
<body>
<div class="page-container">
  <div class="page-header" style="animation:itemSlideIn var(--duration-normal) var(--ease-out)">
    <svg width="28" height="28" viewBox="0 0 16 16" fill="var(--accent-fg)"><path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14ZM7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"/></svg>
    <div class="page-title">Downloads</div>
  </div>
  <div class="page-desc">Your downloaded files</div>
  <div class="dl-list" id="list"></div>
</div>
<script>
const gb = window.gitbrowser, listEl = document.getElementById('list');
let _dl = {};

async function load() {
  let items;
  try { items = await gb.getDownloads(); } catch { items = []; }
  if (!Array.isArray(items) || !items.length) {
    listEl.innerHTML = `<div class="empty-state">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14ZM7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"/></svg>
      <div>${_dl.no_downloads || 'No downloads yet'}</div></div>`;
    return;
  }
  listEl.innerHTML = '';
  items.forEach(dl => renderItem(dl));
}

function renderItem(dl) {
  const div = document.createElement('div'); div.className = 'dl-card'; div.id = 'dl-' + dl.id;
  const pct = dl.totalBytes > 0 ? Math.round((dl.receivedBytes / dl.totalBytes) * 100) : 0;
  const isDone = dl.state === 'completed', isFailed = dl.state === 'cancelled' || dl.state === 'interrupted', isActive = !isDone && !isFailed;
  const speedStr = dl.speed > 0 ? formatBytes(dl.speed) + '/s' : '', etaStr = dl.eta > 0 ? formatEta(dl.eta) : '';
  const statusText = isDone ? (_dl.completed || 'Completed') : isFailed ? (_dl.failed || 'Failed') : (dl.paused ? (_dl.paused || 'Paused') + ' — ' : '') + pct + '%' + (speedStr ? ' — ' + speedStr : '') + (etaStr ? ' — ' + etaStr : '') + ' — ' + formatBytes(dl.receivedBytes) + ' / ' + formatBytes(dl.totalBytes);
  div.innerHTML = `<div class="dl-top">
    <div class="dl-icon"><svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14ZM7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"/></svg></div>
    <div class="dl-info"><div class="dl-name">${esc(dl.filename)}</div><div class="dl-status ${isDone?'done':isFailed?'error':''}">${statusText}</div></div>
    ${isActive ? `<div class="dl-controls"><button class="dl-btn" title="${dl.paused?'Resume':'Pause'}" data-action="${dl.paused?'resume':'pause'}" data-id="${dl.id}">${dl.paused?'\u25B6':'\u23F8'}</button><button class="dl-btn cancel" title="Cancel" data-action="cancel" data-id="${dl.id}">\u2715</button></div>` : ''}
    ${isDone && dl.savePath ? `<div class="done-actions"><button class="done-btn" data-open-file="${esc(dl.savePath)}">${_dl.open_file||'Open'}</button><button class="done-btn" data-show-folder="${esc(dl.savePath)}">${_dl.open_folder||'Show in folder'}</button></div>` : ''}
  </div>
  <div class="progress"><div class="progress-bar${isDone?' done':isFailed?' error':''}" style="width:${isDone?100:pct}%"></div></div>`;
  div.querySelectorAll('.dl-btn').forEach(b => { b.onclick = () => { const a=b.dataset.action,id=b.dataset.id; if(a==='pause')gb.pauseDownload(id);else if(a==='resume')gb.resumeDownload(id);else if(a==='cancel')gb.cancelDownload(id); }; });
  div.querySelectorAll('.done-btn').forEach(b => { b.onclick = () => { if(b.dataset.openFile)gb.openDownloadFile(b.dataset.openFile);else if(b.dataset.showFolder)gb.showDownloadInFolder(b.dataset.showFolder); }; });
  listEl.appendChild(div);
}

gb.onDownloadStarted((dl) => renderItem(dl));
gb.onDownloadProgress((dl) => {
  const el = document.getElementById('dl-' + dl.id); if (!el) return;
  const bar = el.querySelector('.progress-bar'), status = el.querySelector('.dl-status');
  const pct = dl.totalBytes > 0 ? Math.round((dl.receivedBytes / dl.totalBytes) * 100) : 0;
  if (bar) bar.style.width = pct + '%';
  const speedStr = dl.speed > 0 ? formatBytes(dl.speed) + '/s' : '', etaStr = dl.eta > 0 ? formatEta(dl.eta) : '';
  if (status) status.textContent = (dl.paused ? 'Paused — ' : '') + pct + '%' + (speedStr ? ' — ' + speedStr : '') + (etaStr ? ' — ' + etaStr : '') + ' — ' + formatBytes(dl.receivedBytes) + ' / ' + formatBytes(dl.totalBytes);
});
gb.onDownloadDone((dl) => {
  const el = document.getElementById('dl-' + dl.id); if (!el) return;
  const status = el.querySelector('.dl-status'), bar = el.querySelector('.progress-bar'), controls = el.querySelector('.dl-controls');
  if (status) { status.textContent = dl.state === 'completed' ? (_dl.completed||'Completed') : (_dl.failed||'Failed'); status.className = 'dl-status ' + (dl.state === 'completed' ? 'done' : 'error'); }
  if (bar) { bar.style.width = '100%'; bar.className = 'progress-bar ' + (dl.state === 'completed' ? 'done' : 'error'); }
  if (controls) controls.remove();
  if (dl.state === 'completed' && dl.savePath) {
    const top = el.querySelector('.dl-top');
    if (top) { const a = document.createElement('div'); a.className = 'done-actions'; a.innerHTML = `<button class="done-btn" data-open-file="${esc(dl.savePath)}">Open</button><button class="done-btn" data-show-folder="${esc(dl.savePath)}">Show in folder</button>`; a.querySelectorAll('.done-btn').forEach(b => { b.onclick = () => { if(b.dataset.openFile)gb.openDownloadFile(b.dataset.openFile);else if(b.dataset.showFolder)gb.showDownloadInFolder(b.dataset.showFolder); }; }); top.appendChild(a); }
  }
});

function formatBytes(b) { if(!b||b<=0)return '0 B'; if(b<1024)return b+' B'; if(b<1048576)return (b/1024).toFixed(1)+' KB'; if(b<1073741824)return (b/1048576).toFixed(1)+' MB'; return (b/1073741824).toFixed(1)+' GB'; }
function formatEta(s) { if(s<60)return s+'s'; if(s<3600)return Math.floor(s/60)+'m '+s%60+'s'; return Math.floor(s/3600)+'h '+Math.floor(s%3600/60)+'m'; }
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function applyTheme(t) { document.documentElement.classList.add('theme-transition'); document.documentElement.classList.toggle('light', t === 'Light'); setTimeout(() => document.documentElement.classList.remove('theme-transition'), 300); }
if (gb) { gb.onThemeChanged((d) => applyTheme(d.theme)); gb.getSettings().then(s => { if(s&&s.appearance){let t=s.appearance.theme;if(t==='System')t=window.matchMedia('(prefers-color-scheme:light)').matches?'Light':'Dark';applyTheme(t)} }).catch(()=>{}); }
load();
if (gb && gb.getLocaleData) { gb.getLocaleData().then(({data:t}) => { if(t&&t.downloads){_dl=t.downloads;document.querySelector('.page-title').textContent=t.downloads.title||'Downloads';document.querySelector('.page-desc').textContent=t.downloads.desc||'Your downloaded files';load()} }).catch(()=>{}); }
</script>
</body>
</html>