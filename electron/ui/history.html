<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="design-tokens.css" />
<link rel="stylesheet" href="components.css" />
<style>
.top-bar { display: flex; gap: var(--space-sm); margin-bottom: var(--space-xl); animation: fadeUp var(--duration-normal) var(--ease-out) 0.05s both; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.search-wrap { flex: 1; position: relative; }
.search-wrap svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--fg-subtle); }

/* Timeline */
.timeline { position: relative; padding-left: 24px; }
.timeline::before {
  content: ''; position: absolute; left: 7px; top: 0; bottom: 0;
  width: 2px; background: var(--border-muted); border-radius: 1px;
}
.day-group { margin-bottom: var(--space-xl); }
.day-label {
  font-size: var(--text-sm); font-weight: 600; color: var(--fg-muted);
  text-transform: uppercase; letter-spacing: 0.5px;
  padding: var(--space-xs) 0 var(--space-sm);
  position: relative;
}
.day-label::before {
  content: ''; position: absolute; left: -21px; top: 6px;
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--accent-emphasis); border: 2px solid var(--bg-canvas);
}
.h-item {
  display: flex; align-items: center; padding: var(--space-sm) var(--space-md); gap: var(--space-sm);
  border-radius: var(--radius-sm); cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
  animation: itemSlideIn var(--duration-normal) var(--ease-out) both;
}
.h-item:hover { background: var(--bg-subtle); }
.h-favicon { width: 16px; height: 16px; border-radius: 2px; flex-shrink: 0; }
.h-info { flex: 1; min-width: 0; }
.h-title { font-size: var(--text-base); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.h-url { font-size: var(--text-xs); color: var(--fg-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; }
.h-time { font-size: var(--text-xs); color: var(--fg-subtle); white-space: nowrap; flex-shrink: 0; }
.h-del {
  width: 22px; height: 22px; border: none; background: none; color: var(--fg-subtle);
  cursor: pointer; border-radius: var(--radius-sm); display: flex; align-items: center;
  justify-content: center; opacity: 0; transition: all var(--duration-fast); flex-shrink: 0; font-size: 13px;
}
.h-item:hover .h-del { opacity: 1; }
.h-del:hover { background: var(--danger-emphasis); color: #fff; }
</style>
</head>
<body>
<div class="page-container">
  <div class="page-header" style="animation:fadeUp var(--duration-normal) var(--ease-out)">
    <svg width="28" height="28" viewBox="0 0 16 16" fill="var(--accent-fg)"><path d="M1.5 8a6.5 6.5 0 1 1 13 0 6.5 6.5 0 0 1-13 0ZM8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0Zm.5 4.75a.75.75 0 0 0-1.5 0v3.5a.75.75 0 0 0 .37.65l2.5 1.5a.75.75 0 1 0 .76-1.3L8.5 7.96V4.75Z"/></svg>
    <div class="page-title">History</div>
  </div>
  <div class="page-desc">Your browsing history</div>
  <div class="top-bar">
    <div class="search-wrap">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 1 1-1.06 1.06l-3.04-3.04ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"/></svg>
      <input class="input input-glass" id="search" placeholder="Search history..." autofocus style="padding-left:40px" />
    </div>
    <button class="btn btn-danger btn-pill" id="btn-clear">Clear All</button>
  </div>
  <div class="timeline" id="list"></div>
</div>
<script>
const gb = window.gitbrowser, listEl = document.getElementById('list'), searchEl = document.getElementById('search');
let debounce = null, _lt = {};

searchEl.addEventListener('input', () => { clearTimeout(debounce); debounce = setTimeout(() => load(searchEl.value), 200); });
document.getElementById('btn-clear').onclick = () => {
  if (!confirm(_lt.clear_confirm || 'Are you sure you want to clear all history?')) return;
  gb.clearHistory();
  listEl.innerHTML = `<div class="empty-state">${esc(_lt.cleared || 'History cleared')}</div>`;
};

async function load(query) {
  let items;
  try { items = query ? await gb.searchHistory(query) : await gb.getHistory(); } catch { items = []; }
  if (!Array.isArray(items)) items = [];
  if (!items.length) { listEl.innerHTML = `<div class="empty-state"><svg width="48" height="48" viewBox="0 0 16 16" fill="currentColor"><path d="M1.5 8a6.5 6.5 0 1 1 13 0 6.5 6.5 0 0 1-13 0ZM8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0Zm.5 4.75a.75.75 0 0 0-1.5 0v3.5a.75.75 0 0 0 .37.65l2.5 1.5a.75.75 0 1 0 .76-1.3L8.5 7.96V4.75Z"/></svg><div>${esc(_lt.no_history || 'No history yet')}</div></div>`; return; }
  listEl.innerHTML = '';
  const groups = {}, now = new Date(), today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime(), yesterday = today - 86400000;
  items.slice(0, 200).forEach(h => {
    const ts = h.visit_time || 0;
    let label = ts >= today ? (_lt.today || 'Today') : ts >= yesterday ? (_lt.yesterday || 'Yesterday') : new Date(ts).toLocaleDateString([], { month: 'long', day: 'numeric', year: 'numeric' });
    if (!groups[label]) groups[label] = [];
    groups[label].push(h);
  });
  let idx = 0;
  Object.entries(groups).forEach(([label, entries]) => {
    const group = document.createElement('div');
    group.className = 'day-group';
    group.innerHTML = `<div class="day-label">${esc(label)}</div>`;
    entries.forEach(h => {
      const div = document.createElement('div');
      div.className = 'h-item';
      div.style.animationDelay = Math.min(idx++ * 20, 400) + 'ms';
      const time = h.visit_time ? formatTime(h.visit_time) : '';
      const fav = getFaviconUrl(h.url);
      div.innerHTML = `${fav ? `<img class="h-favicon" src="${fav}" onerror="this.style.display='none'" />` : ''}
        <div class="h-info"><div class="h-title">${esc(h.title || h.url)}</div><div class="h-url">${esc(h.url)}</div></div>
        <div class="h-time">${esc(time)}</div><button class="h-del" title="Delete">\u00D7</button>`;
      div.querySelector('.h-info').onclick = () => gb.openUrl(h.url);
      div.querySelector('.h-del').onclick = (e) => { e.stopPropagation(); gb.deleteHistoryEntry(h.id); div.style.cssText='opacity:0;transition:all 0.15s'; setTimeout(() => div.remove(), 150); };
      group.appendChild(div);
    });
    listEl.appendChild(group);
  });
}

function getFaviconUrl(url) { try { return 'https://www.google.com/s2/favicons?sz=16&domain=' + new URL(url).hostname; } catch { return ''; } }
function formatTime(t) { try { const d = new Date(t); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); } catch { return ''; } }
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function applyTheme(t) { document.documentElement.classList.toggle('light', t === 'Light'); }
if (gb) {
  gb.onThemeChanged((d) => applyTheme(d.theme));
  gb.getSettings().then(s => { if (s && s.appearance) { let t = s.appearance.theme; if (t === 'System') t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'Light' : 'Dark'; applyTheme(t); } }).catch(() => {});
}
load('');
if (gb && gb.getLocaleData) {
  gb.getLocaleData().then(({ data: t }) => {
    if (t && t.history) { _lt = t.history; document.querySelector('.page-title').textContent = t.history.title || 'History'; document.querySelector('.page-desc').textContent = t.history.desc || 'Your browsing history'; searchEl.placeholder = t.history.search_placeholder || 'Search history...'; document.getElementById('btn-clear').textContent = t.history.clear_all || 'Clear All'; }
  }).catch(() => {});
}
</script>
</body>
</html>