<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="design-tokens.css" />
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: var(--font-sans);
  font-size: var(--text-md);
  background: transparent;
  color: var(--fg-default);
  user-select: none;
  -webkit-user-select: none;
  overflow: hidden;
  -webkit-app-region: drag;
  height: 48px;
}

/* ─── Nav bar ─── */
#navbar {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 0 6px 14px;
  height: 48px;
  background:
    linear-gradient(180deg, rgba(255,255,255,0.04) 0%, transparent 8%),
    linear-gradient(180deg, #141920 0%, #111720 100%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  -webkit-app-region: drag;
  position: relative;
  box-shadow: var(--glass-inner-glow), 0 1px 3px rgba(0, 0, 0, 0.2);
}
html.light #navbar {
  background:
    linear-gradient(180deg, rgba(255,255,255,0.95) 0%, transparent 8%),
    linear-gradient(180deg, #f0f2f5 0%, #ebeef2 100%);
  border-bottom: 1px solid rgba(0,0,0,0.08);
  box-shadow: var(--glass-inner-glow), 0 1px 3px rgba(0, 0, 0, 0.04);
}

/* ─── Nav buttons ─── */
.nav-btn {
  width: 34px; height: 34px;
  border: none; background: none;
  color: var(--fg-subtle); cursor: pointer;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--duration-fast) var(--ease-out);
  -webkit-app-region: no-drag; flex-shrink: 0;
}
.nav-btn:hover {
  background: var(--glass-bg-active);
  color: var(--fg-default);
}
.nav-btn:active { transform: scale(0.9); }

/* ─── URL bar (glass style) ─── */
#urlbox {
  flex: 1;
  display: flex; align-items: center;
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 0 14px; height: 36px;
  transition: all var(--duration-fast) var(--ease-out);
  -webkit-app-region: no-drag;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.15), var(--glass-inner-glow);
}
html.light #urlbox {
  background: rgba(0,0,0,0.03);
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
}
#urlbox:focus-within {
  border-color: var(--accent-emphasis);
  box-shadow: 0 0 0 3px var(--accent-glow), inset 0 1px 2px rgba(0,0,0,0.1);
  background: rgba(255,255,255,0.06);
}
html.light #urlbox:focus-within {
  background: #fff;
  box-shadow: 0 0 0 3px var(--accent-glow);
}
#lock-icon {
  color: var(--fg-subtle); margin-right: 6px; display: none;
  flex-shrink: 0;
}
#lock-icon.secure { display: flex; color: var(--success-fg); }
#lock-icon.insecure { display: flex; color: var(--danger-fg); }
#url {
  flex: 1; border: none; background: none;
  color: var(--fg-default); font-family: var(--font-sans);
  font-size: var(--text-md); outline: none;
}
#url::placeholder { color: var(--fg-subtle); }

/* ─── Bookmark star in URL bar ─── */
#bmark-inline {
  width: 24px; height: 24px;
  border: none; background: none;
  color: var(--fg-subtle); cursor: pointer;
  border-radius: 4px; display: flex;
  align-items: center; justify-content: center;
  transition: all var(--duration-fast);
  flex-shrink: 0; margin-left: 4px;
}
#bmark-inline:hover { color: var(--accent-fg); }
#bmark-inline.bookmarked { color: var(--accent-fg); }

/* ─── More menu button ─── */
#more-btn {
  width: 34px; height: 34px;
  border: none; background: none;
  color: var(--fg-subtle); cursor: pointer;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  transition: all var(--duration-fast) var(--ease-out);
  -webkit-app-region: no-drag;
}
#more-btn:hover { background: var(--glass-bg-active); color: var(--fg-default); }

/* ─── Window controls ─── */
.win-controls {
  display: flex;
  align-items: center;
  gap: 0;
  margin-left: 4px;
  -webkit-app-region: no-drag;
}
.win-btn {
  width: 46px; height: 34px;
  border: none; background: none;
  color: var(--fg-subtle); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.12s, color 0.12s;
}
.win-btn:hover { background: rgba(255,255,255,0.08); color: var(--fg-default); }
.win-btn.close:hover { background: #e81123; color: #fff; }
html.light .win-btn:hover { background: rgba(0,0,0,0.06); }
html.light .win-btn.close:hover { background: #e81123; color: #fff; }

/* ─── Loading bar ─── */
#loading-bar {
  position: absolute; bottom: 0; left: 0; height: 2px;
  background: linear-gradient(90deg, var(--accent-emphasis), var(--accent-fg));
  width: 0;
  transition: width 0.3s ease; z-index: 10;
  border-radius: 0 1px 0 0;
  box-shadow: 0 0 8px var(--accent-glow);
}
#loading-bar.active { animation: loadProgress 2s ease-in-out; }
@keyframes loadProgress { 0%{width:0} 30%{width:40%} 60%{width:70%} 100%{width:95%} }
#loading-bar.done { width: 100%; transition: width 0.1s, opacity 0.3s 0.2s; opacity: 0; }

/* ─── Toast ─── */
.toast {
  position: fixed; top: 8px; right: 8px;
  padding: 8px 18px;
  background: var(--glass-bg-solid);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-pill);
  color: var(--fg-default); font-size: var(--text-sm);
  box-shadow: var(--glass-shadow), var(--glass-inner-glow);
  z-index: 1000;
  animation: toastIn 0.3s var(--spring);
}
@keyframes toastIn { from { opacity:0; transform:translateX(20px) scale(0.95); } }
</style>
</head>
<body>
<div id="navbar">
  <div style="display:flex;gap:2px;-webkit-app-region:no-drag">
    <button id="back" class="nav-btn" title="Back">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"/></svg>
    </button>
    <button id="fwd" class="nav-btn" title="Forward">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8.22 2.97a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l2.97-2.97H3.75a.75.75 0 0 1 0-1.5h7.44L8.22 4.03a.75.75 0 0 1 0-1.06Z"/></svg>
    </button>
    <button id="rl" class="nav-btn" title="Reload">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"/></svg>
    </button>
  </div>
  <div id="urlbox">
    <span id="lock-icon">
      <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M4 4a4 4 0 0 1 8 0v2h.25c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 12.25 15h-8.5A1.75 1.75 0 0 1 2 13.25v-5.5C2 6.784 2.784 6 3.75 6H4Zm8.25 3.5h-8.5a.25.25 0 0 0-.25.25v5.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25ZM10.5 6V4a2.5 2.5 0 1 0-5 0v2Z"/></svg>
    </span>
    <input id="url" type="text" placeholder="Search or enter URL" spellcheck="false" autocomplete="off" />
    <button id="bmark-inline" title="Bookmark (Ctrl+D)">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M4 0a2 2 0 0 0-2 2v12.5a.5.5 0 0 0 .79.407L8 11.263l5.21 3.644A.5.5 0 0 0 14 14.5V2a2 2 0 0 0-2-2Zm0 1.5h8a.5.5 0 0 1 .5.5v10.72l-4.46-3.12a.75.75 0 0 0-.86.004L3.5 12.72V2a.5.5 0 0 1 .5-.5Z"/></svg>
    </button>
  </div>
  <span id="zoom-indicator"></span>
  <button id="telegram-btn" class="nav-btn" title="Telegram" style="-webkit-app-region:no-drag">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.479.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
  </button>
  <button id="more-btn" title="More">
    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3ZM1.5 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Zm13 0a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z"/></svg>
  </button>
  <div class="win-controls">
    <button class="win-btn" id="win-min" title="Minimize">
      <svg width="10" height="1" viewBox="0 0 10 1"><rect fill="currentColor" width="10" height="1"/></svg>
    </button>
    <button class="win-btn" id="win-max" title="Maximize">
      <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="1"><rect x="0.5" y="0.5" width="9" height="9"/></svg>
    </button>
    <button class="win-btn close" id="win-close" title="Close">
      <svg width="10" height="10" viewBox="0 0 10 10" stroke="currentColor" stroke-width="1.2"><line x1="0" y1="0" x2="10" y2="10"/><line x1="10" y1="0" x2="0" y2="10"/></svg>
    </button>
  </div>
  <div id="loading-bar"></div>
</div>
<!-- Find bar (inline within toolbar height) -->
<div id="findbar" style="display:none;position:absolute;top:8px;right:48px;background:var(--glass-bg-solid);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);border:1px solid var(--glass-border);border-radius:var(--radius-sm);padding:4px 8px;gap:6px;align-items:center;z-index:20;box-shadow:var(--glass-shadow),var(--glass-inner-glow);">
  <input id="find-input" type="text" placeholder="Найти на странице..." style="width:200px;padding:5px 10px;border:1px solid var(--glass-border);border-radius:var(--radius-sm);background:rgba(255,255,255,0.04);color:var(--fg-default);font-family:inherit;font-size:12px;outline:none;transition:all 150ms cubic-bezier(0.16,1,0.3,1);" onfocus="this.style.borderColor='var(--accent-emphasis)';this.style.boxShadow='0 0 0 3px var(--accent-glow)'" onblur="this.style.borderColor='var(--glass-border)';this.style.boxShadow='none'" />
  <button id="find-close" style="width:22px;height:22px;border:none;background:none;color:var(--fg-muted);cursor:pointer;border-radius:6px;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all 150ms;">&times;</button>
</div>

<script>
const gb = window.gitbrowser;
const urlEl = document.getElementById('url');
const lockIcon = document.getElementById('lock-icon');
const loadingBar = document.getElementById('loading-bar');
let currentActiveId = null;
let currentUrl = '';

// ─── Buttons ───
document.getElementById('back').onclick = () => gb.goBack();
document.getElementById('fwd').onclick = () => gb.goForward();
document.getElementById('rl').onclick = () => gb.reload();
document.getElementById('bmark-inline').onclick = () => gb.addBookmark({ url: currentUrl || urlEl.value, title: '' });
document.getElementById('telegram-btn').onclick = () => gb.telegramToggle();
if (gb.onTelegramState) gb.onTelegramState((d) => {
  const btn = document.getElementById('telegram-btn');
  if (btn) btn.style.color = d.visible ? 'var(--accent-fg)' : '';
});
if (gb.onTelegramBtnVisible) gb.onTelegramBtnVisible((d) => {
  const btn = document.getElementById('telegram-btn');
  if (btn) btn.style.display = d.visible ? '' : 'none';
});
// Load initial telegram button visibility from settings
(async () => {
  try {
    const s = await gb.getSettings();
    if (s && s.appearance && s.appearance.show_telegram === false) {
      const btn = document.getElementById('telegram-btn');
      if (btn) btn.style.display = 'none';
    }
  } catch {}
})();
document.getElementById('more-btn').onclick = (e) => {
  const rect = e.target.closest('#more-btn').getBoundingClientRect();
  gb.showMoreMenu(rect.left, rect.bottom);
};

// ─── Window controls ───
document.getElementById('win-min').onclick = () => gb.winMinimize();
document.getElementById('win-max').onclick = () => gb.winMaximize();
document.getElementById('win-close').onclick = () => gb.winClose();

urlEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { gb.navigate(e.target.value); urlEl.blur(); }
  if (e.key === 'Escape') urlEl.blur();
});
urlEl.addEventListener('focus', function() { this.select(); });

// ─── Keyboard shortcuts ───
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 'l') { e.preventDefault(); urlEl.focus(); urlEl.select(); }
  if (e.ctrlKey && e.key === 'd') { e.preventDefault(); gb.addBookmark({ url: currentUrl || urlEl.value, title: '' }); }
  if (e.key === 'F5') { e.preventDefault(); gb.reload(); }
  if (e.ctrlKey && (e.key === '=' || e.key === '+')) { e.preventDefault(); gb.zoomIn(); }
  if (e.ctrlKey && e.key === '-') { e.preventDefault(); gb.zoomOut(); }
  if (e.ctrlKey && e.key === '0') { e.preventDefault(); gb.zoomReset(); }
  if (e.key === 'F11') { e.preventDefault(); gb.toggleFullscreen(); }
  if (e.ctrlKey && e.key === 'f') { e.preventDefault(); toggleFindBar(); }
});

// ─── Lock icon ───
function updateLockIcon(url) {
  lockIcon.className = '';
  if (!url || url.startsWith('gb://') || url.includes('.html')) {
    lockIcon.style.display = 'none';
  } else if (url.startsWith('https://')) {
    lockIcon.className = 'secure'; lockIcon.style.display = 'flex';
  } else if (url.startsWith('http://')) {
    lockIcon.className = 'insecure'; lockIcon.style.display = 'flex';
  } else { lockIcon.style.display = 'none'; }
}

// ─── Tab events (we still listen for URL updates) ───
const loadingTabs = new Set();

gb.onTabsUpdate((data) => {
  currentActiveId = data.activeId;
});

gb.onTabUrlUpdated((data) => {
  if (data.id === currentActiveId && data.url) {
    const isInternal = data.url.includes('.html') || data.url.startsWith('gb://');
    currentUrl = isInternal ? '' : data.url;
    urlEl.value = currentUrl;
    updateLockIcon(currentUrl);
  }
});

gb.onTabLoading((data) => {
  if (data.loading) {
    loadingTabs.add(data.id);
    if (data.id === currentActiveId) { loadingBar.className = 'active'; loadingBar.style.width = ''; }
  } else {
    loadingTabs.delete(data.id);
    if (data.id === currentActiveId) {
      loadingBar.className = 'done';
      setTimeout(() => { loadingBar.className = ''; loadingBar.style.width = '0'; }, 500);
    }
  }
});

gb.onToast((data) => {
  const t = document.createElement('div');
  t.className = 'toast';
  if (data.action === 'save-password' && data.data) {
    t.textContent = data.message + ' ';
    const saveBtn = document.createElement('span');
    saveBtn.textContent = '✓ Save';
    saveBtn.style.cssText = 'cursor:pointer;color:var(--accent-fg);font-weight:600;margin-left:8px;';
    saveBtn.onclick = () => {
      gb.passwordSave({ url: data.data.url, username: data.data.username, password: data.data.password });
      t.remove();
    };
    const dismissBtn = document.createElement('span');
    dismissBtn.textContent = '✕';
    dismissBtn.style.cssText = 'cursor:pointer;color:var(--fg-muted);margin-left:8px;';
    dismissBtn.onclick = () => t.remove();
    t.appendChild(saveBtn);
    t.appendChild(dismissBtn);
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 8000);
  } else if (data.action === 'open-download' && data.data && data.data.savePath) {
    t.textContent = data.message;
    t.style.cursor = 'pointer';
    t.title = 'Click to open file';
    t.onclick = () => { gb.openDownloadFile(data.data.savePath); t.remove(); };
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 4000);
  } else {
    t.textContent = data.message;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 2000);
  }
});

// ─── Find bar ───
const findBar = document.getElementById('findbar');
const findInput = document.getElementById('find-input');
let findOpen = false;

function toggleFindBar() {
  findOpen = !findOpen;
  findBar.style.display = findOpen ? 'flex' : 'none';
  if (findOpen) { findInput.focus(); findInput.select(); }
  else { gb.stopFind(); findInput.value = ''; }
}

findInput.addEventListener('input', () => {
  const text = findInput.value.trim();
  if (text) gb.findInPage(text);
  else gb.stopFind();
});
findInput.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') toggleFindBar();
  if (e.key === 'Enter') { const text = findInput.value.trim(); if (text) gb.findInPage(text); }
});
document.getElementById('find-close').onclick = () => toggleFindBar();

// ─── Zoom indicator ───
const zoomEl = document.getElementById('zoom-indicator');
zoomEl.style.cssText = 'font-size:11px;color:var(--fg-muted);padding:0 4px;display:none;align-items:center;white-space:nowrap;-webkit-app-region:no-drag;';
gb.onZoomChanged((data) => {
  if (data.level === 0) { zoomEl.style.display = 'none'; }
  else { zoomEl.style.display = 'flex'; zoomEl.textContent = Math.round(100 * Math.pow(1.2, data.level)) + '%'; }
});

// Close find bar when switching tabs
gb.onCloseFind(() => {
  if (findOpen) toggleFindBar();
});

// ─── Theme ───
function applyTheme(theme) {
  document.documentElement.classList.add('theme-transition');
  document.documentElement.classList.toggle('light', theme === 'Light');
  setTimeout(() => document.documentElement.classList.remove('theme-transition'), 300);
}
gb.onThemeChanged((data) => applyTheme(data.theme));
if (gb.onAccentChanged) gb.onAccentChanged((d) => {
  if (d.css) { const s = document.createElement('style'); s.textContent = d.css; document.head.appendChild(s); }
});
gb.getSettings().then(s => {
  if (s && s.appearance && s.appearance.theme) {
    let t = s.appearance.theme;
    if (t === 'System') t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'Light' : 'Dark';
    applyTheme(t);
  }
}).catch(() => {});

// ─── Localization ───
async function loadLocale() {
  if (!gb || !gb.getLocaleData) return;
  try {
    const { data: t } = await gb.getLocaleData();
    if (!t) return;
    const tb = t.toolbar || {};
    const ab = t.address_bar || {};
    document.getElementById('back').title = tb.back || 'Back';
    document.getElementById('fwd').title = tb.forward || 'Forward';
    document.getElementById('rl').title = tb.reload || 'Reload';
    document.getElementById('bmark-inline').title = tb.add_bookmark || 'Bookmark (Ctrl+D)';
    urlEl.placeholder = ab.placeholder || 'Search or enter URL';
    findInput.placeholder = tb.find_placeholder || 'Find on page...';
  } catch {}
}
loadLocale();

gb.getTabs();
</script>
</body>
</html>
