<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
:root{--bg-canvas:#0d1117;--bg-default:#161b22;--bg-subtle:#1c2128;--fg-default:#e6edf3;--fg-muted:#7d8590;--fg-subtle:#484f58;--border-default:#30363d;--border-muted:#21262d;--accent-fg:#58a6ff;--accent-emphasis:#1f6feb;--success-fg:#3fb950;--danger-fg:#f85149}
html.light{--bg-canvas:#fff;--bg-default:#f6f8fa;--bg-subtle:#f0f2f5;--fg-default:#24292f;--fg-muted:#57606a;--fg-subtle:#8c959f;--border-default:#d0d7de;--border-muted:#d8dee4;--accent-fg:#0969da;--accent-emphasis:#0969da;--success-fg:#1a7f37;--danger-fg:#cf222e}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;background:var(--bg-canvas);color:var(--fg-default);height:100vh;display:flex;flex-direction:column}
.hdr{padding:10px 16px;border-bottom:1px solid var(--border-default);display:flex;align-items:center;gap:8px;flex-wrap:wrap;flex-shrink:0}
.hdr-title{font-size:16px;font-weight:600}.hdr-spacer{flex:1}
.hs{padding:4px 8px;border:1px solid var(--border-default);border-radius:6px;background:var(--bg-default);color:var(--fg-default);font-family:inherit;font-size:12px}
.hb{padding:4px 10px;border:1px solid var(--border-default);border-radius:6px;background:var(--bg-default);color:var(--fg-muted);cursor:pointer;font-family:inherit;font-size:12px;display:flex;align-items:center;gap:4px}
.hb:hover{border-color:var(--accent-fg);color:var(--accent-fg)}.hb.nk{border-color:var(--danger-fg);color:var(--danger-fg)}
.kd{width:6px;height:6px;border-radius:50%}.kd.ok{background:var(--success-fg)}.kd.ms{background:var(--danger-fg)}
.main{flex:1;display:flex;overflow:hidden}
.sb{width:220px;min-width:220px;border-right:1px solid var(--border-default);display:flex;flex-direction:column;background:var(--bg-default)}
.sb-h{padding:10px 12px;display:flex;align-items:center;border-bottom:1px solid var(--border-muted);font-size:12px;color:var(--fg-muted)}
.sb-h span{flex:1;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.sb-n{background:none;border:none;color:var(--accent-fg);cursor:pointer;font-size:18px;line-height:1;padding:0 2px}
.sb-n:hover{background:var(--bg-subtle);border-radius:4px}
.sb-l{flex:1;overflow-y:auto;padding:4px 0}
.si{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;color:var(--fg-muted);border-left:3px solid transparent}
.si:hover{background:var(--bg-subtle)}.si.act{background:var(--bg-subtle);color:var(--fg-default);border-left-color:var(--accent-fg)}
.si .st{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.si .sd{font-size:10px;color:var(--fg-subtle);white-space:nowrap}
.si .sx{background:none;border:none;color:var(--fg-subtle);cursor:pointer;font-size:13px;padding:0 2px;opacity:0}
.si:hover .sx{opacity:1}.si .sx:hover{color:var(--danger-fg)}
.se{padding:16px 12px;color:var(--fg-subtle);font-size:12px;text-align:center}
.ca{flex:1;display:flex;flex-direction:column;overflow:hidden}
#chat{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:10px}
.msg{max-width:80%;padding:10px 14px;border-radius:12px;font-size:14px;line-height:1.6;word-break:break-word}
.msg.user{align-self:flex-end;background:var(--accent-emphasis);color:#fff;border-bottom-right-radius:4px;white-space:pre-wrap}
.msg.ai{align-self:flex-start;background:var(--bg-default);border:1px solid var(--border-muted);border-bottom-left-radius:4px}
.msg.system{align-self:center;color:var(--fg-muted);font-size:12px;background:none;padding:4px}
/* Markdown in AI messages */
.msg.ai p{margin:0 0 8px 0}.msg.ai p:last-child{margin-bottom:0}
.msg.ai strong{font-weight:600}.msg.ai em{font-style:italic}
.msg.ai code{background:var(--bg-subtle);padding:1px 5px;border-radius:4px;font-family:'SF Mono',Consolas,monospace;font-size:13px}
.msg.ai pre{background:var(--bg-canvas);border:1px solid var(--border-muted);border-radius:8px;padding:12px;margin:8px 0;overflow-x:auto}
.msg.ai pre code{background:none;padding:0;font-size:13px}
.msg.ai ul,.msg.ai ol{margin:6px 0 6px 20px}.msg.ai li{margin:2px 0}
.msg.ai blockquote{border-left:3px solid var(--accent-fg);padding-left:12px;margin:6px 0;color:var(--fg-muted)}
.msg.ai h1,.msg.ai h2,.msg.ai h3{margin:10px 0 4px;font-weight:600}
.msg.ai h1{font-size:18px}.msg.ai h2{font-size:16px}.msg.ai h3{font-size:15px}
.msg.ai a{color:var(--accent-fg);text-decoration:underline}
.msg.ai hr{border:none;border-top:1px solid var(--border-muted);margin:8px 0}
/* Thinking animation */
.thinking{display:flex;align-items:center;gap:6px;color:var(--fg-muted);font-size:13px}
.thinking-dots{display:flex;gap:3px}
.thinking-dots span{width:6px;height:6px;border-radius:50%;background:var(--fg-subtle);animation:tdot 1.4s infinite ease-in-out}
.thinking-dots span:nth-child(2){animation-delay:.2s}
.thinking-dots span:nth-child(3){animation-delay:.4s}
@keyframes tdot{0%,80%,100%{transform:scale(.4);opacity:.4}40%{transform:scale(1);opacity:1}}
/* Input area */
.ia{padding:10px 20px;border-top:1px solid var(--border-default);display:flex;gap:8px;flex-shrink:0}
.ia textarea{flex:1;padding:10px 14px;border:1px solid var(--border-default);border-radius:8px;background:var(--bg-default);color:var(--fg-default);font-family:inherit;font-size:14px;outline:none;resize:none;min-height:40px;max-height:120px}
.ia textarea:focus{border-color:var(--accent-emphasis)}
.snd{padding:10px 16px;border:none;border-radius:8px;background:var(--accent-emphasis);color:#fff;cursor:pointer;font-size:14px;font-weight:500;align-self:flex-end}
.snd:hover{background:#388bfd}.snd:disabled{opacity:.5;cursor:not-allowed}
.ov{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:100}
.dlg{background:var(--bg-subtle);border:1px solid var(--border-default);border-radius:12px;padding:24px;width:420px;max-width:90vw}
.dt{font-size:16px;font-weight:600;margin-bottom:6px}.dd{font-size:13px;color:var(--fg-muted);margin-bottom:14px;line-height:1.5}
.di{width:100%;padding:10px 12px;border:1px solid var(--border-default);border-radius:6px;background:var(--bg-default);color:var(--fg-default);font-size:13px;outline:none;margin-bottom:14px}
.di:focus{border-color:var(--accent-emphasis)}
.da{display:flex;gap:8px;justify-content:flex-end}
.bn{padding:7px 16px;border:none;border-radius:6px;cursor:pointer;font-size:13px}
.bn.p{background:var(--accent-emphasis);color:#fff}.bn.p:hover{background:#388bfd}
.bn.s{background:var(--bg-default);color:var(--fg-muted);border:1px solid var(--border-default)}
.bn.d{background:transparent;color:var(--danger-fg);border:1px solid var(--danger-fg)}.bn.d:hover{background:var(--danger-fg);color:#fff}
</style>
</head>
<body>
<div class="hdr">
  <div class="hdr-title" data-i18n="ai.title">AI Assistant</div><div class="hdr-spacer"></div>
  <select class="hs" id="prov"></select>
  <select class="hs" id="mod"></select>
  <button class="hb" id="mmb" style="display:none" title="Custom models">Models</button>
  <button class="hb" id="kb" title="API Key"><span class="kd" id="kdi"></span><span id="kl">Key</span></button>
</div>
<div class="main">
  <div class="sb">
    <div class="sb-h"><span data-i18n="ai.chats">Chats</span><button class="sb-n" id="nb" title="New chat">+</button></div>
    <div class="sb-l" id="sbl"></div>
  </div>
  <div class="ca">
    <div id="chat"></div>
    <div class="ia" id="ia" style="display:none">
      <textarea id="msg" placeholder="Ask anything..." rows="1" data-i18n-ph="ai.placeholder"></textarea>
      <button class="snd" id="snd" data-i18n="ai.send">Send</button>
    </div>
  </div>
</div>
<div class="ov" id="kov" style="display:none"></div>
<div class="ov" id="cov" style="display:none"></div>
<script>
const gb=window.gitbrowser;
const $=id=>document.getElementById(id);
const chatEl=$('chat'),iaEl=$('ia'),msgEl=$('msg'),sndEl=$('snd'),
  provEl=$('prov'),modEl=$('mod'),mmb=$('mmb'),
  kb=$('kb'),kdi=$('kdi'),kl=$('kl'),kov=$('kov'),cov=$('cov'),
  nb=$('nb'),sbl=$('sbl');

let L={}; // locale strings

// ── Markdown parser ──
function renderMd(src){
  let h=src;
  // Code blocks
  h=h.replace(/```(\w*)\n([\s\S]*?)```/g,(_,lang,code)=>'<pre><code>'+esc(code.trim())+'</code></pre>');
  // Inline code
  h=h.replace(/`([^`]+)`/g,'<code>$1</code>');
  // Headers
  h=h.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  h=h.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  h=h.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  // Bold + italic
  h=h.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>');
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/\*(.+?)\*/g,'<em>$1</em>');
  // Blockquote
  h=h.replace(/^> (.+)$/gm,'<blockquote>$1</blockquote>');
  // HR
  h=h.replace(/^---$/gm,'<hr>');
  // Links
  h=h.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>');
  // Unordered lists
  h=h.replace(/^[\-\*] (.+)$/gm,'<li>$1</li>');
  h=h.replace(/((?:<li>.*<\/li>\n?)+)/g,'<ul>$1</ul>');
  // Ordered lists
  h=h.replace(/^\d+\. (.+)$/gm,'<li>$1</li>');
  // Paragraphs: split by double newline
  h=h.replace(/\n{2,}/g,'</p><p>');
  // Single newlines to <br> (but not inside pre/code)
  h=h.replace(/(?<!\n)\n(?!\n)/g,'<br>');
  if(!h.startsWith('<'))h='<p>'+h+'</p>';
  return h;
}

// ── Chat storage ──
function allC(){try{return JSON.parse(localStorage.getItem('ai_chats')||'[]')}catch{return[]}}
function svC(c){localStorage.setItem('ai_chats',JSON.stringify(c))}
function aId(){return localStorage.getItem('ai_act')||''}
function sId(id){localStorage.setItem('ai_act',id)}
function mkC(){const id='c'+Date.now(),o={id,title:t18('ai.new_chat'),date:new Date().toISOString(),msgs:[]};const a=allC();a.unshift(o);svC(a);return id}
function gC(id){return allC().find(c=>c.id===id)||null}
function uC(id,msgs,title){const a=allC(),c=a.find(x=>x.id===id);if(c){c.msgs=msgs;if(title)c.title=title;svC(a)}}
function dC(id){svC(allC().filter(c=>c.id!==id));if(gb)gb.aiClearHistory(id)}

// Migrate old
(function(){
  const om=localStorage.getItem('ai_chat_msgs'),os=localStorage.getItem('ai_session_id');
  if(om){try{const ms=JSON.parse(om);if(Array.isArray(ms)&&ms.length){
    const id=os||'cmig',fu=ms.find(m=>m.type==='user'),t=fu?fu.text.substring(0,50):'Old chat';
    const a=allC();if(!a.find(c=>c.id===id)){a.unshift({id,title:t,date:new Date().toISOString(),msgs:ms});svC(a)}
  }}catch{}localStorage.removeItem('ai_chat_msgs');localStorage.removeItem('ai_session_id')}
})();

let act=aId();
if(!act||!gC(act)){const a=allC();act=a.length?a[0].id:mkC();sId(act)}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}

function t18(key){
  const parts=key.split('.');
  let v=L;
  for(const p of parts){v=v&&v[p];if(!v)break}
  return v||null;
}

function rSB(){
  const cs=allC();
  if(!cs.length){sbl.innerHTML='<div class="se">'+(t18('ai.no_chats')||'No chats yet')+'</div>';return}
  sbl.innerHTML=cs.map(c=>{
    const d=new Date(c.date),ds=d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
    return '<div class="si'+(c.id===act?' act':'')+'" data-id="'+c.id+'"><div class="st">'+esc(c.title)+'</div><div class="sd">'+ds+'</div><button class="sx" data-d="'+c.id+'" title="Delete">\u2715</button></div>';
  }).join('');
  sbl.querySelectorAll('.si').forEach(el=>{
    el.addEventListener('click',e=>{if(e.target.classList.contains('sx'))return;swC(el.dataset.id)});
  });
  sbl.querySelectorAll('.sx').forEach(b=>{
    b.addEventListener('click',e=>{e.stopPropagation();const id=b.dataset.d;dC(id);
      if(id===act){const r=allC();swC(r.length?r[0].id:mkC())}rSB()});
  });
}

function swC(id){act=id;sId(id);ldUI();rSB()}

function ldUI(){
  chatEl.innerHTML='';const c=gC(act);
  if(c&&c.msgs.length){c.msgs.forEach(m=>{
    const d=document.createElement('div');d.className='msg '+m.type;
    if(m.type==='ai')d.innerHTML=renderMd(m.text);
    else d.textContent=m.text;
    chatEl.appendChild(d);
  })}
  else{smsg(t18('ai.ready')||'AI Assistant ready. Type a message to start.')}
  chatEl.scrollTop=chatEl.scrollHeight;
}
function smsg(t){const d=document.createElement('div');d.className='msg system';d.textContent=t;chatEl.appendChild(d)}

function svCur(){
  const ms=[];chatEl.querySelectorAll('.msg').forEach(el=>{
    const t=el.classList.contains('user')?'user':el.classList.contains('ai')?'ai':'system';
    if(el.classList.contains('thinking-msg'))return;
    const text=t==='ai'?(el.dataset.raw||el.textContent):el.textContent;
    ms.push({type:t,text:text})});
  const fu=ms.find(m=>m.type==='user');
  uC(act,ms,fu?fu.text.substring(0,60):undefined);rSB();
}

nb.onclick=()=>{if(gb)gb.aiClearHistory(act);swC(mkC());msgEl.focus()};

// ── Providers / Models / Keys ──
const PROVS={openai:{n:'OpenAI',ph:'sk-...'},anthropic:{n:'Anthropic',ph:'sk-ant-...'},openrouter:{n:'OpenRouter',ph:'sk-or-...'},deepseek:{n:'DeepSeek',ph:'sk-...'}};
const MODS={
  openai:[{id:'gpt-4o',n:'GPT-4o'},{id:'gpt-4o-mini',n:'GPT-4o Mini'},{id:'gpt-4.1',n:'GPT-4.1'},{id:'gpt-4.1-mini',n:'GPT-4.1 Mini'},{id:'o3-mini',n:'o3-mini'}],
  anthropic:[{id:'claude-sonnet-4-20250514',n:'Claude Sonnet 4'},{id:'claude-3-5-haiku-20241022',n:'Claude 3.5 Haiku'},{id:'claude-3-5-sonnet-20241022',n:'Claude 3.5 Sonnet'}],
  openrouter:[{id:'openai/gpt-4o-mini',n:'GPT-4o Mini'},{id:'openai/gpt-4o',n:'GPT-4o'},{id:'anthropic/claude-sonnet-4',n:'Claude Sonnet 4'},{id:'anthropic/claude-3.5-haiku',n:'Claude 3.5 Haiku'},{id:'google/gemini-2.5-flash',n:'Gemini 2.5 Flash'},{id:'google/gemini-2.5-pro',n:'Gemini 2.5 Pro'},{id:'meta-llama/llama-4-maverick',n:'Llama 4 Maverick'},{id:'deepseek/deepseek-chat-v3-0324',n:'DeepSeek V3'},{id:'deepseek/deepseek-r1',n:'DeepSeek R1'}],
  deepseek:[{id:'deepseek-chat',n:'DeepSeek Chat'},{id:'deepseek-reasoner',n:'DeepSeek Reasoner'}]
};
function gk(p){return localStorage.getItem('ai_key_'+p)||''}
function setk(p,k){localStorage.setItem('ai_key_'+p,k)}
function rmk(p){localStorage.removeItem('ai_key_'+p)}
function hk(p){return!!gk(p)}
(function(){const o=localStorage.getItem('ai_api_key');if(o){const p=localStorage.getItem('ai_provider')||'openai';if(!hk(p))setk(p,o);localStorage.removeItem('ai_api_key')}})();

function bProv(){provEl.innerHTML='';for(const[id,i]of Object.entries(PROVS)){const o=document.createElement('option');o.value=id;o.textContent=i.n+(hk(id)?'':' \u26A0');provEl.appendChild(o)}}
function uKI(){const h=hk(provEl.value);kdi.className='kd '+(h?'ok':'ms');kl.textContent=h?(t18('ai.key')||'Key')+' \u2713':(t18('ai.set_key')||'Set Key');kb.className='hb'+(h?'':' nk')}
function gcm(p){try{return JSON.parse(localStorage.getItem('ai_cm_'+p)||'[]')}catch{return[]}}
function scm(p,m){const l=gcm(p);if(!l.includes(m)){l.push(m);localStorage.setItem('ai_cm_'+p,JSON.stringify(l))}}
function rcm(p,m){localStorage.setItem('ai_cm_'+p,JSON.stringify(gcm(p).filter(x=>x!==m)))}
function uMod(){
  const p=provEl.value,ms=MODS[p]||[],sv=localStorage.getItem('ai_model_'+p);modEl.innerHTML='';
  ms.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.n;if(m.id===sv)o.selected=true;modEl.appendChild(o)});
  gcm(p).forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent='\u2605 '+c;if(c===sv)o.selected=true;modEl.appendChild(o)});
  mmb.style.display=p==='openrouter'?'':'none';
}
provEl.onchange=()=>{localStorage.setItem('ai_provider',provEl.value);uMod();uKI();uIA()};
modEl.onchange=()=>{localStorage.setItem('ai_model_'+provEl.value,modEl.value)};
const sp=localStorage.getItem('ai_provider');bProv();if(sp&&PROVS[sp])provEl.value=sp;uMod();uKI();

// ── Key overlay ──
function showK(){
  const p=provEl.value,i=PROVS[p],cur=gk(p);kov.style.display='flex';
  kov.innerHTML='<div class="dlg"><div class="dt">'+(t18('ai.api_key_title')||'API Key')+' \u2014 '+i.n+'</div><div class="dd">'+(t18('ai.api_key_desc')||'Stored locally. Each provider has its own key.')+'</div><input class="di" id="ki" type="password" placeholder="'+i.ph+'" value="'+cur+'"/><div class="da"><button class="bn s" id="kc">'+(t18('ai.cancel')||'Cancel')+'</button>'+(cur?'<button class="bn d" id="kr">'+(t18('ai.remove')||'Remove')+'</button>':'')+'<button class="bn p" id="ks">'+(t18('ai.save')||'Save')+'</button></div></div>';
  $('kc').onclick=()=>{kov.style.display='none'};
  $('ks').onclick=()=>{const v=$('ki').value.trim();if(v)setk(p,v);kov.style.display='none';bProv();provEl.value=p;uKI();uIA()};
  const rb=$('kr');if(rb)rb.onclick=()=>{rmk(p);kov.style.display='none';bProv();provEl.value=p;uKI();uIA()};
  setTimeout(()=>$('ki').focus(),50);
}
kb.onclick=showK;

// ── Custom models ──
function showCM(){cov.style.display='flex';rCM(provEl.value)}
function rCM(p){
  const cs=gcm(p);
  cov.innerHTML='<div class="dlg" style="width:480px"><div class="dt">'+(t18('ai.custom_models')||'Custom Models')+' \u2014 OpenRouter</div><div class="dd">'+(t18('ai.custom_models_desc')||'Format: vendor/model-name')+'</div><div style="max-height:200px;overflow-y:auto;margin-bottom:12px">'+(cs.length===0?'<div class="se">'+(t18('ai.no_custom_models')||'No custom models yet')+'</div>':cs.map(c=>'<div style="display:flex;align-items:center;gap:8px;padding:6px 8px;font-size:13px"><span style="flex:1;font-family:monospace">'+c+'</span><button class="sx" data-m="'+c+'" style="opacity:1">\u2715</button></div>').join(''))+'</div><div style="display:flex;gap:8px"><input class="di" id="cmi" style="margin:0" placeholder="e.g. mistralai/mistral-large"/><button class="bn p" id="cma">'+(t18('ai.add')||'Add')+'</button></div><div style="margin-top:14px;display:flex;justify-content:flex-end"><button class="bn s" id="cmc">'+(t18('ai.close')||'Close')+'</button></div></div>';
  $('cmc').onclick=()=>{cov.style.display='none';uMod()};
  function da(){const v=$('cmi').value.trim();if(!v||!v.includes('/'))return;scm(p,v);localStorage.setItem('ai_model_'+p,v);rCM(p)}
  $('cma').onclick=da;$('cmi').onkeydown=e=>{if(e.key==='Enter')da()};
  setTimeout(()=>$('cmi').focus(),50);
  cov.querySelectorAll('.sx').forEach(b=>{b.onclick=()=>{rcm(p,b.dataset.m);if(localStorage.getItem('ai_model_'+p)===b.dataset.m)localStorage.removeItem('ai_model_'+p);rCM(p)}});
}
mmb.onclick=showCM;

// ── Input area ──
function uIA(){iaEl.style.display=hk(provEl.value)?'flex':'none'}
uIA();

// ── Thinking indicator ──
function showThinking(){
  const d=document.createElement('div');d.className='msg ai thinking-msg';
  d.innerHTML='<div class="thinking"><div class="thinking-dots"><span></span><span></span><span></span></div><span>'+(t18('ai.thinking')||'Thinking...')+'</span></div>';
  chatEl.appendChild(d);chatEl.scrollTop=chatEl.scrollHeight;return d;
}

// ── Send ──
sndEl.onclick=doSend;
msgEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();doSend()}});
msgEl.addEventListener('input',()=>{msgEl.style.height='auto';msgEl.style.height=Math.min(msgEl.scrollHeight,120)+'px'});

async function doSend(){
  const text=msgEl.value.trim();if(!text)return;
  const p=provEl.value,k=gk(p);if(!k){showK();return}
  addM('user',text);msgEl.value='';msgEl.style.height='auto';sndEl.disabled=true;
  const thinkEl=showThinking();
  try{const r=await gb.aiChat({provider:p,apiKey:k,message:text,sessionId:act,model:modEl.value});
    thinkEl.remove();
    if(r.error)addM('system','Error: '+r.error);else addM('ai',r.text);
  }catch(e){thinkEl.remove();addM('system','Error: '+(e.message||'Unknown'))}
  sndEl.disabled=false;msgEl.focus();
}
function addM(type,text){
  const d=document.createElement('div');d.className='msg '+type;
  if(type==='ai'){d.innerHTML=renderMd(text);d.dataset.raw=text}
  else d.textContent=text;
  chatEl.appendChild(d);chatEl.scrollTop=chatEl.scrollHeight;svCur();
}

// ── Localization ──
async function loadLocale(){
  if(!gb||!gb.getLocaleData)return;
  try{
    const{data:t}=await gb.getLocaleData();
    if(!t)return;L=t;
    // Apply data-i18n attributes
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const v=t18(el.dataset.i18n);if(v)el.textContent=v;
    });
    document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
      const v=t18(el.dataset.i18nPh);if(v)el.placeholder=v;
    });
    // Custom models button text
    mmb.textContent=t18('ai.custom_models')||'Custom Models';
    uKI();
  }catch{}
}

// ── Init ──
ldUI();rSB();
loadLocale().then(()=>{ldUI();rSB()});
if(hk(provEl.value))msgEl.focus();

// ── Theme ──
function applyTheme(t){document.documentElement.classList.toggle('light',t==='Light')}
if(gb){gb.onThemeChanged(d=>applyTheme(d.theme));gb.getSettings().then(s=>{if(s&&s.appearance){let t=s.appearance.theme;if(t==='System')t=window.matchMedia('(prefers-color-scheme:light)').matches?'Light':'Dark';applyTheme(t)}}).catch(()=>{})}
</script>
</body>
</html>