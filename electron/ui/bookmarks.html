<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="design-tokens.css" />
<link rel="stylesheet" href="components.css" />
<style>
.page-container { max-width: 800px; }
.search-row { margin-bottom: var(--space-xl); animation: fadeUp var(--duration-normal) var(--ease-out) 0.05s both; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.search-wrap { position: relative; }
.search-wrap svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--fg-subtle); }
.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: var(--space-md); }
.bm-card {
  background: var(--glass-bg-solid); backdrop-filter: var(--glass-blur); -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border); border-radius: var(--radius-md); padding: var(--space-lg);
  cursor: pointer; transition: all var(--duration-fast) var(--spring); position: relative;
  display: flex; flex-direction: column; gap: var(--space-sm);
  animation: cardIn var(--duration-normal) var(--ease-out) both;
}
.bm-card:hover { border-color: var(--glass-border-hover); transform: translateY(-2px); box-shadow: var(--glass-shadow-lg), var(--glass-inner-glow); }
.bm-card:active { transform: translateY(0) scale(0.98); }
.bm-card-top { display: flex; align-items: center; gap: var(--space-sm); }
.bm-icon {
  width: 32px; height: 32px; border-radius: var(--radius-sm); background: var(--bg-subtle);
  display: flex; align-items: center; justify-content: center; color: var(--accent-fg);
  font-weight: 700; font-size: var(--text-md); flex-shrink: 0; overflow: hidden;
}
.bm-icon img { width: 18px; height: 18px; }
.bm-title { font-size: var(--text-md); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
.bm-url { font-size: var(--text-sm); color: var(--fg-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bm-del {
  position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; border: none;
  background: var(--bg-subtle); color: var(--fg-subtle); cursor: pointer; border-radius: var(--radius-sm);
  display: flex; align-items: center; justify-content: center; opacity: 0;
  transition: all var(--duration-fast); font-size: 14px;
}
.bm-card:hover .bm-del { opacity: 1; }
.bm-del:hover { background: var(--danger-emphasis); color: #fff; }
@keyframes cardIn { from { opacity: 0; transform: scale(0.96) translateY(6px); } to { opacity: 1; transform: scale(1) translateY(0); } }
.empty-state svg { width: 48px; height: 48px; }
</style>
</head>
<body>
<div class="page-container">
  <div class="page-header" style="animation:fadeUp var(--duration-normal) var(--ease-out)">
    <svg width="28" height="28" viewBox="0 0 16 16" fill="var(--accent-fg)"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/></svg>
    <div class="page-title">Bookmarks</div>
  </div>
  <div class="page-desc">Your saved pages</div>
  <div class="search-row"><div class="search-wrap">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 1 1-1.06 1.06l-3.04-3.04ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"/></svg>
    <input class="input input-glass" id="search" placeholder="Search bookmarks..." autofocus style="padding-left:40px" />
  </div></div>
  <div class="grid" id="grid"></div>
</div>
<script>
const gb = window.gitbrowser;
const gridEl = document.getElementById('grid');
const searchEl = document.getElementById('search');
let debounce = null, _bm = {};

searchEl.addEventListener('input', () => { clearTimeout(debounce); debounce = setTimeout(() => load(searchEl.value), 200); });

async function load(query) {
  let items;
  try { items = query ? await gb.searchBookmarks(query) : await gb.getBookmarks(); } catch { items = []; }
  if (!Array.isArray(items)) items = [];
  if (!items.length) {
    gridEl.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
      <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/></svg>
      <div>${query ? (_bm.no_results || 'No bookmarks match your search') : (_bm.no_bookmarks || 'No bookmarks yet. Press Ctrl+D to add one.')}</div>
    </div>`;
    return;
  }
  gridEl.innerHTML = '';
  items.forEach((bm, i) => {
    const div = document.createElement('div');
    div.className = 'bm-card';
    div.style.animationDelay = Math.min(i * 30, 300) + 'ms';
    const letter = (bm.title || bm.url || '?')[0].toUpperCase();
    let fav = '';
    try { const hostname = new URL(bm.url).hostname; fav = 'https://' + hostname + '/favicon.ico'; } catch {}
    const ic = fav ? `<img src="${esc(fav)}" onerror="this.onerror=null;this.src='https://www.google.com/s2/favicons?sz=32&domain=${esc(new URL(bm.url).hostname)}';this.onerror=function(){this.parentElement.textContent='${esc(letter)}'}" />` : esc(letter);
    div.innerHTML = `<div class="bm-card-top"><div class="bm-icon">${ic}</div><div class="bm-title">${esc(bm.title || bm.url)}</div></div>
      <div class="bm-url">${esc(bm.url)}</div><button class="bm-del" title="Remove">\u00D7</button>`;
    div.addEventListener('click', (e) => { if (!e.target.closest('.bm-del')) gb.openUrl(bm.url); });
    div.querySelector('.bm-del').onclick = (e) => {
      e.stopPropagation(); gb.deleteBookmark(bm.id);
      div.style.cssText = 'opacity:0;transform:scale(0.95);transition:all 0.2s';
      setTimeout(() => { div.remove(); if (!gridEl.children.length) load(''); }, 200);
    };
    gridEl.appendChild(div);
  });
}
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function applyTheme(t) { document.documentElement.classList.add('theme-transition'); document.documentElement.classList.toggle('light', t === 'Light'); setTimeout(() => document.documentElement.classList.remove('theme-transition'), 300); }
if (gb) {
  gb.onThemeChanged((d) => applyTheme(d.theme));
  gb.getSettings().then(s => { if (s && s.appearance) { let t = s.appearance.theme; if (t === 'System') t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'Light' : 'Dark'; applyTheme(t); } }).catch(() => {});
}
load('');
if (gb && gb.getLocaleData) {
  gb.getLocaleData().then(({ data: t }) => {
    if (t && t.bookmarks) { _bm = t.bookmarks; document.querySelector('.page-title').textContent = t.bookmarks.title || 'Bookmarks'; document.querySelector('.page-desc').textContent = t.bookmarks.desc || 'Your saved pages'; searchEl.placeholder = t.bookmarks.search_placeholder || 'Search bookmarks...'; load(''); }
  }).catch(() => {});
}
</script>
</body>
</html>