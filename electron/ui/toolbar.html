<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
:root {
  --bg-canvas: #0d1117; --bg-default: #161b22; --bg-subtle: #1c2128;
  --fg-default: #e6edf3; --fg-muted: #7d8590; --fg-subtle: #484f58;
  --border-default: #30363d; --border-muted: #21262d;
  --accent-fg: #58a6ff; --accent-emphasis: #1f6feb;
  --danger-emphasis: #da3633; --success-emphasis: #238636;
}
html.light {
  --bg-canvas: #ffffff; --bg-default: #f6f8fa; --bg-subtle: #f0f2f5;
  --fg-default: #24292f; --fg-muted: #57606a; --fg-subtle: #8c959f;
  --border-default: #d0d7de; --border-muted: #d8dee4;
  --accent-fg: #0969da; --accent-emphasis: #0969da;
  --danger-emphasis: #cf222e; --success-emphasis: #1a7f37;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
  font-size: 13px; background: var(--bg-default); color: var(--fg-default);
  user-select: none; -webkit-user-select: none; overflow: hidden;
  -webkit-app-region: drag;
}

/* ─── Tab bar ─── */
#tabbar {
  display: flex; align-items: flex-end; height: 38px;
  padding: 0 8px; gap: 0;
  background: var(--bg-canvas); border-bottom: 1px solid var(--border-muted);
  -webkit-app-region: drag;
}
#tabs-wrap {
  display: flex; align-items: flex-end; height: 100%;
  flex: 1; overflow: hidden; -webkit-app-region: no-drag;
}
#tabs {
  display: flex; gap: 2px; align-items: flex-end; height: 100%;
  padding-top: 4px; overflow-x: auto; scrollbar-width: none;
}
#tabs::-webkit-scrollbar { display: none; }
.tab {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 10px; height: 30px;
  background: transparent; color: var(--fg-muted);
  border-radius: 6px 6px 0 0; cursor: pointer;
  white-space: nowrap; border: 1px solid transparent; border-bottom: none;
  transition: background 0.15s cubic-bezier(0.33,1,0.68,1), color 0.15s, border-color 0.15s;
  max-width: 200px; min-width: 60px; font-size: 12px;
  position: relative; animation: tabSlideIn 0.2s cubic-bezier(0.33,1,0.68,1);
  will-change: transform, opacity;
}
@keyframes tabSlideIn { from { opacity:0; transform:translateY(4px) scaleX(0.8); } }
.tab:hover { background: var(--bg-subtle); color: var(--fg-default); }
.tab.active { background: var(--bg-default); color: var(--fg-default); border-color: var(--border-default); }
.tab.active::after {
  content: ""; position: absolute; bottom: -1px; left: 0; right: 0;
  height: 2px; background: var(--accent-emphasis); border-radius: 2px 2px 0 0;
}
.tab.loading .tab-title::after {
  content: ""; display: inline-block; width: 8px; height: 8px;
  border: 1.5px solid var(--accent-fg); border-top-color: transparent;
  border-radius: 50%; margin-left: 6px; vertical-align: middle;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.tab-title { overflow: hidden; text-overflow: ellipsis; }
.tab-x {
  width: 16px; height: 16px; border: none; background: none;
  color: var(--fg-subtle); cursor: pointer; border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; line-height: 1; padding: 0;
  opacity: 0; transition: all 0.12s; flex-shrink: 0;
}
.tab:hover .tab-x { opacity: 1; }
.tab-x:hover { background: var(--danger-emphasis); color: #fff; }
.tab.dragging { opacity: 0.4; }
.tab.drag-over { border-left: 2px solid var(--accent-emphasis); }

/* New tab button — right next to tabs */
#newtab {
  width: 28px; height: 28px; border: none; background: none;
  color: var(--fg-muted); cursor: pointer; border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; transition: all 0.12s; flex-shrink: 0;
  margin-left: 2px; margin-bottom: 4px;
  -webkit-app-region: no-drag;
}
#newtab:hover { background: var(--bg-subtle); color: var(--fg-default); }
#newtab:active { transform: scale(0.9); }

/* ─── Nav buttons ─── */
.nav-btn {
  width: 28px; height: 28px; border: none; background: none;
  color: var(--fg-muted); cursor: pointer; border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.12s cubic-bezier(0.33,1,0.68,1);
  -webkit-app-region: no-drag; flex-shrink: 0;
}
.nav-btn:hover { background: var(--bg-subtle); color: var(--fg-default); }
.nav-btn:active { transform: scale(0.9); }

/* ─── Address bar ─── */
#addrbar {
  display: flex; align-items: center; gap: 4px;
  padding: 4px 10px; background: var(--bg-default);
  border-bottom: 1px solid var(--border-default);
  -webkit-app-region: no-drag; position: relative;
}
#nav { display: flex; gap: 2px; }
#urlbox {
  flex: 1; display: flex; align-items: center;
  background: var(--bg-canvas); border: 1px solid var(--border-default);
  border-radius: 8px; padding: 0 10px; height: 30px;
  transition: all 0.15s cubic-bezier(0.33,1,0.68,1);
}
#urlbox:focus-within { border-color: var(--accent-emphasis); box-shadow: 0 0 0 3px rgba(31,111,235,0.3); }
#lock-icon { color: var(--fg-subtle); margin-right: 6px; display: none; }
#lock-icon.secure { display: flex; color: var(--success-emphasis); }
#lock-icon.insecure { display: flex; color: var(--danger-emphasis); }
#url {
  flex: 1; border: none; background: none; color: var(--fg-default);
  font-family: inherit; font-size: 13px; outline: none;
}
#url::placeholder { color: var(--fg-subtle); }
#tools { display: flex; gap: 2px; }

/* ─── Loading bar ─── */
#loading-bar {
  position: absolute; bottom: 0; left: 0; height: 2px;
  background: var(--accent-emphasis); width: 0;
  transition: width 0.3s ease; z-index: 10;
}
#loading-bar.active { animation: loadProgress 2s ease-in-out; }
@keyframes loadProgress { 0%{width:0} 30%{width:40%} 60%{width:70%} 100%{width:95%} }
#loading-bar.done { width: 100%; transition: width 0.1s, opacity 0.3s 0.2s; opacity: 0; }

/* ─── Toast ─── */
.toast {
  position: fixed; bottom: 8px; left: 50%; transform: translateX(-50%);
  padding: 6px 16px; background: var(--bg-canvas); border: 1px solid var(--border-default);
  border-radius: 8px; color: var(--fg-default); font-size: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 1000;
  animation: toastIn 0.2s cubic-bezier(0.33,1,0.68,1);
}
@keyframes toastIn { from { opacity:0; transform:translateX(-50%) translateY(10px); } }

/* ─── Favicon ─── */
.tab-favicon { width: 14px; height: 14px; border-radius: 2px; flex-shrink: 0; }

/* ─── Find bar ─── */
#findbar {
  display: none; position: absolute; top: 0; right: 12px;
  background: var(--bg-default); border: 1px solid var(--border-default);
  border-radius: 0 0 8px 8px; padding: 6px 10px; gap: 6px;
  align-items: center; z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
#findbar.show { display: flex; }
#findbar input {
  width: 200px; padding: 4px 8px; border: 1px solid var(--border-default);
  border-radius: 4px; background: var(--bg-canvas); color: var(--fg-default);
  font-family: inherit; font-size: 12px; outline: none;
}
#findbar input:focus { border-color: var(--accent-emphasis); }
#findbar .find-close {
  width: 20px; height: 20px; border: none; background: none; color: var(--fg-muted);
  cursor: pointer; border-radius: 4px; font-size: 14px; display: flex;
  align-items: center; justify-content: center;
}
#findbar .find-close:hover { background: var(--bg-subtle); }

/* ─── Zoom indicator ─── */
#zoom-indicator {
  font-size: 11px; color: var(--fg-muted); padding: 0 6px;
  display: none; align-items: center; white-space: nowrap;
}
</style>
</head>
<body>
<div id="tabbar">
  <div id="tabs-wrap">
    <div id="tabs"></div>
    <button id="newtab" title="New Tab (Ctrl+T)">+</button>
  </div>
</div>
<div id="addrbar">
  <div id="nav">
    <button id="back" class="nav-btn" title="Back">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M7.78 12.53a.75.75 0 0 1-1.06 0L2.47 8.28a.75.75 0 0 1 0-1.06l4.25-4.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042L4.81 7h7.44a.75.75 0 0 1 0 1.5H4.81l2.97 2.97a.75.75 0 0 1 0 1.06Z"/></svg>
    </button>
    <button id="fwd" class="nav-btn" title="Forward">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8.22 2.97a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042l2.97-2.97H3.75a.75.75 0 0 1 0-1.5h7.44L8.22 4.03a.75.75 0 0 1 0-1.06Z"/></svg>
    </button>
    <button id="rl" class="nav-btn" title="Reload (F5)">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"/></svg>
    </button>
  </div>
  <div id="urlbox">
    <span id="lock-icon">
      <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M4 4a4 4 0 0 1 8 0v2h.25c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0 1 12.25 15h-8.5A1.75 1.75 0 0 1 2 13.25v-5.5C2 6.784 2.784 6 3.75 6H4Zm8.25 3.5h-8.5a.25.25 0 0 0-.25.25v5.5c0 .138.112.25.25.25h8.5a.25.25 0 0 0 .25-.25v-5.5a.25.25 0 0 0-.25-.25ZM10.5 6V4a2.5 2.5 0 1 0-5 0v2Z"/></svg>
    </span>
    <input id="url" type="text" placeholder="Search or enter URL" spellcheck="false" autocomplete="off" />
  </div>
  <span id="zoom-indicator"></span>
  <div id="tools">
    <button id="bmark" class="nav-btn" title="Add Bookmark (Ctrl+D)">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M4 0a2 2 0 0 0-2 2v12.5a.5.5 0 0 0 .79.407L8 11.263l5.21 3.644A.5.5 0 0 0 14 14.5V2a2 2 0 0 0-2-2Zm0 1.5h8a.5.5 0 0 1 .5.5v10.72l-4.46-3.12a.75.75 0 0 0-.86.004L3.5 12.72V2a.5.5 0 0 1 .5-.5Z"/></svg>
    </button>
    <button id="btn-reader" class="nav-btn" title="Reader Mode" style="display:none">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0 1 14.25 16H1.75A1.75 1.75 0 0 1 0 14.25ZM1.75 1.5a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V1.75a.25.25 0 0 0-.25-.25ZM3 4.75A.75.75 0 0 1 3.75 4h8.5a.75.75 0 0 1 0 1.5h-8.5A.75.75 0 0 1 3 4.75Zm0 3A.75.75 0 0 1 3.75 7h8.5a.75.75 0 0 1 0 1.5h-8.5A.75.75 0 0 1 3 7.75Zm0 3a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1-.75-.75Z"/></svg>
    </button>
    <button id="btn-bookmarks" class="nav-btn" title="Bookmarks (Ctrl+B)">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.751.751 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25Z"/></svg>
    </button>
    <button id="btn-history" class="nav-btn" title="History (Ctrl+H)">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M1.5 8a6.5 6.5 0 1 1 13 0 6.5 6.5 0 0 1-13 0ZM8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0Zm.5 4.75a.75.75 0 0 0-1.5 0v3.5a.75.75 0 0 0 .37.65l2.5 1.5a.75.75 0 1 0 .77-1.29L8.5 7.94Z"/></svg>
    </button>
    <button id="btn-downloads" class="nav-btn" title="Downloads (Ctrl+J)">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M2.75 14A1.75 1.75 0 0 1 1 12.25v-2.5a.75.75 0 0 1 1.5 0v2.5c0 .138.112.25.25.25h10.5a.25.25 0 0 0 .25-.25v-2.5a.75.75 0 0 1 1.5 0v2.5A1.75 1.75 0 0 1 13.25 14ZM7.25 7.689V2a.75.75 0 0 1 1.5 0v5.689l1.97-1.969a.749.749 0 1 1 1.06 1.06l-3.25 3.25a.749.749 0 0 1-1.06 0L4.22 6.78a.749.749 0 1 1 1.06-1.06l1.97 1.969Z"/></svg>
    </button>
    <button id="btn-ai" class="nav-btn" title="AI Assistant">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 3.5a2 2 0 1 0 0 4 2 2 0 0 0 0-4ZM2 5.5a3.5 3.5 0 1 1 5.898 2.549 5.508 5.508 0 0 1 3.034 4.084.75.75 0 1 1-1.482.235 4.001 4.001 0 0 0-6.9 0 .75.75 0 0 1-1.482-.236A5.507 5.507 0 0 1 4.6 8.048 3.486 3.486 0 0 1 2 5.5ZM11 4a.75.75 0 1 0 0 1.5 1.5 1.5 0 0 1 .666 2.844.75.75 0 0 0-.416.672v.352a.75.75 0 0 0 .574.73c1.2.289 2.162 1.2 2.522 2.372a.75.75 0 1 0 1.434-.44 5.01 5.01 0 0 0-2.56-3.012A3 3 0 0 0 11 4Z"/></svg>
    </button>
    <button id="btn-github" class="nav-btn" title="GitHub">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>
    </button>
    <button id="settings" class="nav-btn" title="Settings (Ctrl+,)">
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.1-.303c.652-.18 1.34.03 1.73.545a8.042 8.042 0 0 1 1.088 1.89c.238.572.1 1.252-.337 1.71l-.812.804a.395.395 0 0 0-.112.29c.013.26.013.52 0 .78a.394.394 0 0 0 .112.29l.812.804c.436.458.575 1.138.337 1.71a8.04 8.04 0 0 1-1.088 1.89c-.39.515-1.078.725-1.73.545l-1.1-.303a.352.352 0 0 0-.3.071 5.834 5.834 0 0 1-.667.386.35.35 0 0 0-.212.224l-.289 1.106c-.169.646-.715 1.196-1.458 1.26a8.28 8.28 0 0 1-1.402 0c-.743-.064-1.289-.614-1.458-1.26l-.289-1.106a.35.35 0 0 0-.212-.224 5.738 5.738 0 0 1-.668-.386.352.352 0 0 0-.299-.071l-1.1.303c-.652.18-1.34-.03-1.73-.545a8.042 8.042 0 0 1-1.088-1.89c-.238-.572-.1-1.252.337-1.71l.812-.804a.395.395 0 0 0 .112-.29 6.046 6.046 0 0 1 0-.78.394.394 0 0 0-.112-.29l-.812-.804c-.436-.458-.575-1.138-.337-1.71a8.04 8.04 0 0 1 1.088-1.89c.39-.515 1.078-.725 1.73-.545l1.1.303a.352.352 0 0 0 .3-.071c.214-.143.437-.272.667-.386a.35.35 0 0 0 .212-.224l.289-1.106C6.01.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.105c-.147.561-.549.967-.998 1.189-.173.086-.34.183-.5.29-.417.278-.97.423-1.529.27l-1.103-.303c-.109-.03-.175.016-.195.046-.219.29-.411.6-.573.925-.014.028-.042.112.017.182l.812.803c.407.404.63.953.63 1.52s-.223 1.116-.63 1.52l-.812.803c-.059.07-.031.154-.017.182.162.325.354.634.573.925.02.03.086.077.195.046l1.102-.303c.56-.153 1.113-.008 1.53.27.16.107.327.204.5.29.449.222.851.628.998 1.189l.289 1.105c.029.109.101.143.137.146a6.6 6.6 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.105c.147-.561.549-.967.998-1.189.173-.086.34-.183.5-.29.417-.278.97-.423 1.529-.27l1.103.303c.109.03.175-.016.195-.046.219-.29.411-.6.573-.925.014-.028.042-.112-.017-.182l-.812-.803a2.15 2.15 0 0 1-.63-1.52c0-.567.223-1.116.63-1.52l.812-.803c.059-.07.031-.154.017-.182a6.588 6.588 0 0 0-.573-.925c-.02-.03-.086-.077-.195-.046l-1.102.303c-.56.153-1.113.008-1.53-.27a4.44 4.44 0 0 0-.5-.29c-.449-.222-.851-.628-.998-1.189l-.289-1.105c-.029-.11-.101-.143-.137-.146a6.6 6.6 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM9.5 8a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"/></svg>
    </button>
  </div>
  <div id="loading-bar"></div>
  <div id="findbar"><input id="find-input" type="text" placeholder="Find on page..." /><button class="find-close" id="find-close">&times;</button></div>
</div>
<script>
const gb = window.gitbrowser;
const tabsEl = document.getElementById('tabs');
const urlEl = document.getElementById('url');
const lockIcon = document.getElementById('lock-icon');
const loadingBar = document.getElementById('loading-bar');
let currentActiveId = null;
let currentUrl = '';

// ─── Buttons ───
document.getElementById('newtab').onclick = () => gb.newTab();
document.getElementById('back').onclick = () => gb.goBack();
document.getElementById('fwd').onclick = () => gb.goForward();
document.getElementById('rl').onclick = () => gb.reload();
document.getElementById('bmark').onclick = () => gb.addBookmark({ url: currentUrl || urlEl.value, title: '' });
document.getElementById('btn-reader').onclick = async () => {
  const result = await gb.readerExtract();
  if (result && !result.error && result.html) {
    // Open reader view as a data URL in a new tab
    const readerHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>
      :root{--bg:#0d1117;--fg:#e6edf3;--muted:#7d8590}
      body{font-family:Georgia,serif;max-width:700px;margin:40px auto;padding:0 20px;background:var(--bg);color:var(--fg);line-height:1.8;font-size:18px}
      h1{font-size:28px;margin-bottom:8px;line-height:1.3}
      .meta{color:var(--muted);font-size:14px;margin-bottom:24px;font-family:sans-serif}
      img{max-width:100%;height:auto;border-radius:4px}
      a{color:#58a6ff}
      @media(prefers-color-scheme:light){:root{--bg:#fff;--fg:#24292f;--muted:#57606a}a{color:#0969da}}
    </style></head><body><h1>${result.title || ''}</h1><div class="meta">Reader Mode</div>${result.html}</body></html>`;
    const encoded = 'data:text/html;charset=utf-8,' + encodeURIComponent(readerHtml);
    gb.openUrlNewTab(encoded);
  }
};
document.getElementById('settings').onclick = () => gb.openSettings();
document.getElementById('btn-bookmarks').onclick = () => gb.openBookmarks();
document.getElementById('btn-history').onclick = () => gb.openHistory();
document.getElementById('btn-downloads').onclick = () => gb.openDownloads();
document.getElementById('btn-ai').onclick = () => gb.openAI();
document.getElementById('btn-github').onclick = () => gb.openGitHub();

urlEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') { gb.navigate(e.target.value); urlEl.blur(); }
  if (e.key === 'Escape') urlEl.blur();
});
urlEl.addEventListener('focus', function() { this.select(); });

// ─── Keyboard shortcuts ───
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && e.key === 't') { e.preventDefault(); gb.newTab(); }
  if (e.ctrlKey && e.key === 'w') { e.preventDefault(); if (currentActiveId) gb.closeTab(currentActiveId); }
  if (e.ctrlKey && e.key === 'l') { e.preventDefault(); urlEl.focus(); urlEl.select(); }
  if (e.ctrlKey && e.key === ',') { e.preventDefault(); gb.openSettings(); }
  if (e.ctrlKey && e.key === 'd') { e.preventDefault(); gb.addBookmark({ url: currentUrl || urlEl.value, title: '' }); }
  if (e.ctrlKey && e.key === 'b') { e.preventDefault(); gb.openBookmarks(); }
  if (e.ctrlKey && e.key === 'h') { e.preventDefault(); gb.openHistory(); }
  if (e.ctrlKey && e.key === 'j') { e.preventDefault(); gb.openDownloads(); }
  if (e.ctrlKey && e.shiftKey && e.key === 'T') { e.preventDefault(); gb.reopenClosedTab(); }
  if (e.key === 'F5') { e.preventDefault(); gb.reload(); }
  if (e.ctrlKey && (e.key === '=' || e.key === '+')) { e.preventDefault(); gb.zoomIn(); }
  if (e.ctrlKey && e.key === '-') { e.preventDefault(); gb.zoomOut(); }
  if (e.ctrlKey && e.key === '0') { e.preventDefault(); gb.zoomReset(); }
  if (e.key === 'F11') { e.preventDefault(); gb.toggleFullscreen(); }
  if (e.ctrlKey && e.shiftKey && e.key === 'N') { e.preventDefault(); gb.openPrivateWindow(); }
  if (e.ctrlKey && e.key === 'f') { e.preventDefault(); toggleFindBar(); }
});

// ─── Lock icon ───
function updateLockIcon(url) {
  lockIcon.className = '';
  if (!url || url.startsWith('gb://') || url.includes('.html')) {
    lockIcon.style.display = 'none';
  } else if (url.startsWith('https://')) {
    lockIcon.className = 'secure'; lockIcon.style.display = 'flex';
  } else if (url.startsWith('http://')) {
    lockIcon.className = 'insecure'; lockIcon.style.display = 'flex';
  } else { lockIcon.style.display = 'none'; }
}

// ─── Tabs rendering ───
const loadingTabs = new Set();

gb.onTabsUpdate((data) => {
  const { tabs: tabList, activeId } = data;
  currentActiveId = activeId;
  tabsEl.innerHTML = '';
  tabList.forEach((t) => {
    const div = document.createElement('div');
    div.className = 'tab' + (t.id === activeId ? ' active' : '') + (loadingTabs.has(t.id) ? ' loading' : '');
    // Favicon
    if (t.favicon) {
      const img = document.createElement('img');
      img.className = 'tab-favicon'; img.src = t.favicon;
      img.onerror = () => img.remove();
      div.appendChild(img);
    }
    const titleSpan = document.createElement('span');
    titleSpan.className = 'tab-title';
    let title = t.title || 'New Tab';
    if (title.length > 22) title = title.substring(0, 22) + '\u2026';
    titleSpan.textContent = title;
    div.appendChild(titleSpan);
    const xbtn = document.createElement('button');
    xbtn.className = 'tab-x'; xbtn.textContent = '\u00D7';
    div.appendChild(xbtn);
    div.addEventListener('click', (e) => { if (!e.target.closest('.tab-x')) gb.switchTab(t.id); });
    div.addEventListener('contextmenu', (e) => { e.preventDefault(); gb.tabContextMenu(t.id); });
    xbtn.addEventListener('click', (e) => { e.stopPropagation(); gb.closeTab(t.id); });
    // Drag and drop
    div.draggable = true;
    div.dataset.tabId = t.id;
    div.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', t.id); div.classList.add('dragging'); });
    div.addEventListener('dragend', () => { div.classList.remove('dragging'); document.querySelectorAll('.tab.drag-over').forEach(el => el.classList.remove('drag-over')); });
    div.addEventListener('dragover', (e) => { e.preventDefault(); div.classList.add('drag-over'); });
    div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
    div.addEventListener('drop', (e) => {
      e.preventDefault(); div.classList.remove('drag-over');
      const fromId = e.dataTransfer.getData('text/plain');
      const toId = t.id;
      if (fromId && toId && fromId !== toId) gb.reorderTab(fromId, toId);
    });
    tabsEl.appendChild(div);
  });
});

gb.onTabUrlUpdated((data) => {
  if (data.id === currentActiveId && data.url) {
    const isInternal = data.url.includes('.html') || data.url.startsWith('gb://');
    currentUrl = isInternal ? '' : data.url;
    urlEl.value = currentUrl;
    updateLockIcon(currentUrl);
    // Show reader mode button for web pages
    document.getElementById('btn-reader').style.display = (currentUrl.startsWith('http://') || currentUrl.startsWith('https://')) ? '' : 'none';
  }
});

gb.onTabLoading((data) => {
  if (data.loading) {
    loadingTabs.add(data.id);
    if (data.id === currentActiveId) { loadingBar.className = 'active'; loadingBar.style.width = ''; }
  } else {
    loadingTabs.delete(data.id);
    if (data.id === currentActiveId) {
      loadingBar.className = 'done';
      setTimeout(() => { loadingBar.className = ''; loadingBar.style.width = '0'; }, 500);
    }
  }
});

gb.onToast((data) => {
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = data.message;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 2000);
});

// ─── Find bar ───
const findBar = document.getElementById('findbar');
const findInput = document.getElementById('find-input');
let findOpen = false;

function toggleFindBar() {
  findOpen = !findOpen;
  findBar.classList.toggle('show', findOpen);
  if (findOpen) { findInput.focus(); findInput.select(); }
  else { gb.stopFind(); findInput.value = ''; }
}

findInput.addEventListener('input', () => {
  const text = findInput.value.trim();
  if (text) gb.findInPage(text);
  else gb.stopFind();
});
findInput.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') toggleFindBar();
  if (e.key === 'Enter') { const text = findInput.value.trim(); if (text) gb.findInPage(text); }
});
document.getElementById('find-close').onclick = () => toggleFindBar();

// ─── Zoom indicator ───
const zoomEl = document.getElementById('zoom-indicator');
gb.onZoomChanged((data) => {
  if (data.level === 0) { zoomEl.style.display = 'none'; }
  else { zoomEl.style.display = 'flex'; zoomEl.textContent = Math.round(100 * Math.pow(1.2, data.level)) + '%'; }
});

// ─── Theme ───
function applyTheme(theme) {
  document.documentElement.classList.toggle('light', theme === 'Light');
}
gb.onThemeChanged((data) => applyTheme(data.theme));
// Load initial theme
gb.getSettings().then(s => {
  if (s && s.appearance && s.appearance.theme) {
    let t = s.appearance.theme;
    if (t === 'System') t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'Light' : 'Dark';
    applyTheme(t);
  }
}).catch(() => {});

// ─── Localization ───
async function loadLocale() {
  if (!gb || !gb.getLocaleData) return;
  try {
    const { data: t } = await gb.getLocaleData();
    if (!t) return;
    const tb = t.toolbar || {};
    const ab = t.address_bar || {};
    document.getElementById('newtab').title = tb.new_tab_tooltip || 'New Tab (Ctrl+T)';
    document.getElementById('back').title = tb.back || 'Back';
    document.getElementById('fwd').title = tb.forward || 'Forward';
    document.getElementById('rl').title = tb.reload || 'Reload (F5)';
    document.getElementById('bmark').title = tb.add_bookmark || 'Add Bookmark (Ctrl+D)';
    document.getElementById('btn-reader').title = tb.reader_mode || 'Reader Mode';
    document.getElementById('btn-bookmarks').title = tb.bookmarks || 'Bookmarks (Ctrl+B)';
    document.getElementById('btn-history').title = tb.history || 'History (Ctrl+H)';
    document.getElementById('btn-downloads').title = tb.downloads || 'Downloads (Ctrl+J)';
    document.getElementById('btn-ai').title = tb.ai_assistant || 'AI Assistant';
    document.getElementById('btn-github').title = tb.github || 'GitHub';
    document.getElementById('settings').title = tb.settings || 'Settings (Ctrl+,)';
    urlEl.placeholder = ab.placeholder || 'Search or enter URL';
    findInput.placeholder = tb.find_placeholder || 'Find on page...';
  } catch {}
}
loadLocale();

gb.getTabs();
</script>
</body>
</html>
