<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="design-tokens.css" />
<link rel="stylesheet" href="components.css" />
<style>
body { display: flex; height: 100vh; overflow: hidden; }

/* Settings sidebar nav */
.settings-nav {
  width: 200px;
  min-width: 200px;
  padding: var(--space-xl) var(--space-md);
  border-right: 1px solid var(--glass-border);
  background: var(--glass-bg);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  display: flex;
  flex-direction: column;
  gap: var(--space-xs);
  overflow-y: auto;
}

.nav-title {
  font-size: var(--text-xl);
  font-weight: 600;
  padding: 0 var(--space-sm);
  margin-bottom: var(--space-lg);
  letter-spacing: -0.3px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
  padding: var(--space-sm) var(--space-md);
  border-radius: var(--radius-sm);
  color: var(--fg-muted);
  font-size: var(--text-base);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
  border: none;
  background: none;
  font-family: var(--font-sans);
  width: 100%;
  text-align: left;
}

.nav-item:hover { background: var(--glass-bg-hover); color: var(--fg-default); }
.nav-item.active {
  background: var(--accent-emphasis);
  color: #fff;
  box-shadow: 0 2px 12px var(--accent-glow);
}
.nav-item .nav-icon { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

/* Content area */
.settings-content {
  flex: 1;
  overflow-y: auto;
  padding: var(--space-2xl) var(--space-xl);
}

.settings-inner {
  max-width: 600px;
  margin: 0 auto;
}

.section-title {
  font-size: var(--text-2xl);
  font-weight: 600;
  margin-bottom: var(--space-xs);
  letter-spacing: -0.3px;
}

.section-desc {
  color: var(--fg-muted);
  font-size: var(--text-md);
  margin-bottom: var(--space-xl);
}

.settings-section { display: none; }
.settings-section.active { display: block; animation: fadeSection var(--duration-normal) var(--ease-out); }

@keyframes fadeSection {
  from { opacity: 0; transform: translateY(10px) scale(0.99); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

/* Settings card */
.settings-card {
  background: var(--glass-bg-solid);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  overflow: hidden;
  margin-bottom: var(--space-lg);
  box-shadow: var(--glass-shadow), var(--glass-inner-glow);
  transition: border-color var(--duration-fast) var(--ease-out);
}
.settings-card:hover {
  border-color: var(--glass-border-hover);
}

.row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-md) var(--space-lg);
  border-bottom: 1px solid var(--glass-border);
  transition: background var(--duration-fast) var(--ease-out);
  gap: var(--space-md);
}

.row:last-child { border-bottom: none; }
.row:hover { background: var(--glass-bg-hover); }

.row-info { flex: 1; }
.row-label { font-size: var(--text-md); font-weight: 500; }
.row-desc { font-size: var(--text-sm); color: var(--fg-muted); margin-top: 2px; }

select, input[type="number"], input[type="text"], input[type="url"] {
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid var(--glass-border);
  color: var(--fg-default);
  padding: 6px 12px;
  border-radius: var(--radius-md);
  font-family: var(--font-sans);
  font-size: var(--text-base);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
  outline: none;
  box-shadow: var(--glass-inner-glow);
}

select:focus, input[type="number"]:focus, input[type="text"]:focus, input[type="url"]:focus {
  border-color: var(--accent-emphasis);
  box-shadow: 0 0 0 3px var(--accent-glow), var(--glass-inner-glow);
}

html.light select, html.light input[type="number"], html.light input[type="text"], html.light input[type="url"] {
  background: rgba(0, 0, 0, 0.04);
  color: var(--fg-default);
}

html.light .settings-nav { background: rgba(255, 255, 255, 0.7); }
html.light .settings-card { background: rgba(255, 255, 255, 0.85); }
html.light .donate-btn { background: rgba(0, 0, 0, 0.03); }
html.light .donate-custom { background: rgba(0, 0, 0, 0.03); }

.saved-indicator {
  display: inline-block;
  color: var(--success-fg);
  font-size: var(--text-sm);
  margin-left: var(--space-sm);
  opacity: 0;
  transition: opacity var(--duration-fast);
}

.saved-indicator.show { opacity: 1; }

.version {
  color: var(--fg-subtle);
  font-size: var(--text-sm);
  margin-top: var(--space-lg);
  text-align: center;
}

/* Color palette */
.color-palette {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.color-swatch {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
}
.color-swatch:hover, .color-swatch.active {
  border-color: var(--accent-fg);
  transform: scale(1.15);
}
.color-swatch.reset-swatch {
  background: var(--bg-canvas);
  border: 2px dashed var(--border-default);
}

/* About section */
.about-logo {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-md);
  padding: var(--space-xl) 0;
}
.about-logo img { width: 80px; height: 80px; border-radius: var(--radius-md); }
.about-name { font-size: var(--text-2xl); font-weight: 700; letter-spacing: -0.5px; }
.about-version { color: var(--fg-muted); font-size: var(--text-md); }

/* Donate section */
.donate-amounts {
  display: flex;
  gap: var(--space-sm);
  flex-wrap: wrap;
  align-items: center;
}
.donate-btn {
  padding: 8px 18px;
  border-radius: var(--radius-md);
  border: 1px solid var(--glass-border);
  background: rgba(255, 255, 255, 0.04);
  color: var(--fg-default);
  font-family: var(--font-sans);
  font-size: var(--text-base);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
}
.donate-btn:hover, .donate-btn.active {
  background: var(--accent-emphasis);
  color: #fff;
  border-color: var(--accent-emphasis);
  box-shadow: 0 2px 12px var(--accent-glow);
}
.donate-custom {
  width: 80px;
  padding: 8px 12px;
  text-align: center;
}
.donate-submit {
  padding: 10px 24px;
  border-radius: var(--radius-md);
  border: none;
  background: var(--accent-emphasis);
  color: #fff;
  font-family: var(--font-sans);
  font-size: var(--text-md);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
  margin-top: var(--space-md);
  width: 100%;
}
.donate-submit:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 16px var(--accent-glow); }
.donate-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.donate-status { font-size: var(--text-sm); color: var(--fg-muted); margin-top: var(--space-sm); text-align: center; }
.donate-status.error { color: var(--danger-fg); }

.link-row { cursor: pointer; }
.link-row span { color: var(--fg-subtle); font-size: var(--text-base); }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<nav class="settings-nav">
  <div class="nav-title">Settings</div>
  <button class="nav-item active" data-section="general"><span class="nav-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span> General</button>
  <button class="nav-item" data-section="appearance"><span class="nav-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="8" r="1.5" fill="currentColor" stroke="none"/><circle cx="8.5" cy="11.5" r="1.5" fill="currentColor" stroke="none"/><circle cx="10" cy="15.5" r="1.5" fill="currentColor" stroke="none"/><circle cx="15.5" cy="11.5" r="1.5" fill="currentColor" stroke="none"/></svg></span> Appearance</button>
  <button class="nav-item" data-section="privacy"><span class="nav-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></span> Privacy</button>
  <button class="nav-item" data-section="account"><span class="nav-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg></span> Account</button>
  <button class="nav-item" data-section="advanced"><span class="nav-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg></span> Advanced</button>
  <button class="nav-item" data-section="about"><span class="nav-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></span> About</button>
</nav>

<div class="settings-content">
  <div class="settings-inner">
    <span class="saved-indicator" id="saved">Saved</span>

    <!-- General -->
    <div class="settings-section active" id="sec-general">
      <div class="section-title" data-i18n="settings.general">General</div>
      <div class="section-desc" data-i18n="settings.general_desc">Basic browser preferences</div>
      <div class="settings-card">
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.language_label">Language</div><div class="row-desc" data-i18n="settings.language_desc">Interface language</div></div>
          <select id="s-language"><option value="en">English</option><option value="ru">–†—É—Å—Å–∫–∏–π</option></select>
        </div>
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.startup_behavior">On Startup</div><div class="row-desc" data-i18n="settings.startup_desc">What to show when browser starts</div></div>
          <select id="s-startup"><option value="Restore" data-i18n="settings.startup_restore">Restore session</option><option value="NewTab" data-i18n="settings.startup_new_tab">New tab</option></select>
        </div>
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.search_engine">Search Engine</div><div class="row-desc" data-i18n="settings.search_engine_desc">Default search provider</div></div>
          <select id="s-search-engine"><option value="google">Google</option><option value="duckduckgo">DuckDuckGo</option><option value="bing">Bing</option><option value="yandex">Yandex</option></select>
        </div>
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.homepage">Homepage</div><div class="row-desc" data-i18n="settings.homepage_desc">Page to open as homepage</div></div>
          <input type="url" id="s-homepage" placeholder="https://..." style="width:180px" />
        </div>
      </div>
    </div>

    <!-- Appearance -->
    <div class="settings-section" id="sec-appearance">
      <div class="section-title" data-i18n="settings.appearance">Appearance</div>
      <div class="section-desc" data-i18n="settings.appearance_desc">Customize how GitBrowser looks</div>
      <div class="settings-card">
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.theme">Theme</div></div>
          <select id="s-theme"><option value="Dark" data-i18n="settings.theme_dark">Dark</option><option value="Light" data-i18n="settings.theme_light">Light</option><option value="System" data-i18n="settings.theme_system">System</option></select></div>
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.font_size">Font Size</div></div>
          <input type="number" id="s-fontsize" value="14" min="10" max="24" style="width:60px" /></div>
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.newtab_bg">New Tab Background</div><div class="row-desc" data-i18n="settings.newtab_bg_desc">Background color for new tab page</div></div>
        </div>
        <div class="row">
          <div class="color-palette" id="bg-palette"></div>
        </div>
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.accent_color">Accent Color</div><div class="row-desc" data-i18n="settings.accent_color_desc">Interface accent color</div></div>
        </div>
        <div class="row">
          <div class="color-palette" id="accent-palette"></div>
        </div>
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.show_telegram">Show Telegram Button</div><div class="row-desc" data-i18n="settings.show_telegram_desc">Show Telegram widget button in toolbar</div></div>
          <div class="toggle on" id="s-show-telegram" data-key="appearance.show_telegram"></div></div>
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.show_github">Show GitHub Button</div><div class="row-desc" data-i18n="settings.show_github_desc">Show GitHub quick-access button in toolbar</div></div>
          <div class="toggle on" id="s-show-github" data-key="appearance.show_github"></div></div>
      </div>
    </div>

    <!-- Privacy -->
    <div class="settings-section" id="sec-privacy">
      <div class="section-title" data-i18n="settings.privacy">Privacy & Security</div>
      <div class="section-desc" data-i18n="settings.privacy_desc">Control tracking, encryption, and data</div>
      <div class="settings-card">
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.tracker_blocking">Block Trackers</div><div class="row-desc" data-i18n="settings.tracker_desc">Prevent tracking scripts</div></div>
          <div class="toggle on" id="s-trackers" data-key="privacy.tracker_blocking"></div></div>
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.ad_blocking">Block Ads</div><div class="row-desc" data-i18n="settings.ad_desc">Remove advertisements</div></div>
          <div class="toggle on" id="s-ads" data-key="privacy.ad_blocking"></div></div>
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.https_enforcement">Force HTTPS</div><div class="row-desc" data-i18n="settings.https_desc">Upgrade insecure connections</div></div>
          <div class="toggle on" id="s-https" data-key="privacy.https_enforcement"></div></div>
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.dns_over_https">DNS over HTTPS</div><div class="row-desc" data-i18n="settings.dns_desc">Encrypt DNS queries</div></div>
          <div class="toggle on" id="s-doh" data-key="privacy.dns_over_https"></div></div>
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.anti_fingerprinting">Anti-Fingerprinting</div><div class="row-desc" data-i18n="settings.fingerprint_desc">Protect against browser fingerprinting</div></div>
          <div class="toggle on" id="s-fingerprint" data-key="privacy.anti_fingerprinting"></div></div>
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.clear_data_on_exit">Clear Data on Exit</div><div class="row-desc" data-i18n="settings.clear_exit_desc">Remove browsing data when closing</div></div>
          <div class="toggle" id="s-clear-exit" data-key="privacy.clear_data_on_exit"></div></div>
        <div class="row"><div class="row-info"><div class="row-label" data-i18n="settings.telemetry_consent">Help Improve GitBrowser</div><div class="row-desc" data-i18n="settings.telemetry_desc">Send usage data via your GitHub account (requires login)</div></div>
          <div class="toggle" id="s-telemetry" data-key="privacy.telemetry_consent"></div></div>
      </div>
      <div class="settings-card">
        <div class="row link-row" id="open-passwords">
          <div class="row-info"><div class="row-label"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px;margin-right:6px"><path d="M6.5 5.5a4 4 0 1 1 2.731 3.795l-1.96 1.96a.25.25 0 0 1-.177.073H6.5v.75a.75.75 0 0 1-.75.75h-.75v.75a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1-.75-.75v-2.086a.75.75 0 0 1 .22-.53l3.435-3.437A4.001 4.001 0 0 1 6.5 5.5ZM10.5 3a1 1 0 1 0 0 2 1 1 0 0 0 0-2Z"/></svg><span data-i18n="passwords.title">Password Manager</span></div><div class="row-desc" data-i18n="passwords.desc">Manage saved credentials</div></div>
          <span>‚Üí</span>
        </div>
      </div>
    </div>

    <!-- Account (GitHub) -->
    <div class="settings-section" id="sec-account">
      <div class="section-title" data-i18n="settings.account">Account</div>
      <div class="section-desc" data-i18n="settings.account_desc">GitHub integration and sync</div>

      <!-- Not logged in state -->
      <div class="settings-card" id="gh-login-card">
        <div class="row" style="flex-direction:column;align-items:center;padding:var(--space-xl);">
          <svg width="48" height="48" viewBox="0 0 16 16" fill="var(--fg-subtle)" style="margin-bottom:var(--space-md)"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>
          <div class="row-label" style="font-size:var(--text-lg);margin-bottom:4px;" data-i18n="settings.account_not_logged">Not signed in</div>
          <div class="row-desc" style="text-align:center;margin-bottom:var(--space-md);" data-i18n="settings.account_login_hint">Sign in to sync bookmarks, access repos, and more</div>
          <button class="donate-submit" id="gh-login-btn" style="max-width:260px;" data-i18n="github.login">Sign in with GitHub</button>
        </div>
      </div>

      <!-- Device code verification state -->
      <div class="settings-card" id="gh-device-card" style="display:none;">
        <div class="row" style="flex-direction:column;align-items:center;padding:var(--space-xl);">
          <div class="row-label" style="font-size:var(--text-lg);margin-bottom:var(--space-sm);" data-i18n="github.authorize_title">Authorize GitBrowser</div>
          <div class="row-desc" style="text-align:center;margin-bottom:var(--space-md);" data-i18n="github.authorize_desc">Go to the link below and enter this code:</div>
          <div id="gh-user-code" style="font-size:28px;font-weight:700;letter-spacing:4px;color:var(--accent-fg);margin-bottom:var(--space-md);cursor:pointer;user-select:all;" title="Click to copy"></div>
          <a id="gh-verify-link" style="color:var(--accent-fg);text-decoration:underline;cursor:pointer;font-size:var(--text-md);margin-bottom:var(--space-md);"></a>
          <div id="gh-poll-status" style="color:var(--fg-muted);font-size:var(--text-sm);"><span style="display:inline-block;width:14px;height:14px;border:2px solid var(--fg-subtle);border-top-color:var(--accent-fg);border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle;margin-right:6px;"></span><span data-i18n="github.waiting">Waiting for authorization...</span></div>
        </div>
      </div>

      <!-- Logged in: profile -->
      <div class="settings-card" id="gh-profile-card" style="display:none;">
        <div class="row" style="gap:var(--space-md);">
          <img id="gh-avatar" src="" alt="" style="width:48px;height:48px;border-radius:50%;border:2px solid var(--glass-border);" />
          <div class="row-info">
            <div class="row-label" id="gh-username" style="font-size:var(--text-lg);"></div>
            <div class="row-desc" id="gh-bio"></div>
          </div>
        </div>
      </div>

      <!-- Logged in: actions -->
      <div id="gh-actions-card" style="display:none;">
        <div class="settings-card">
          <div class="row link-row" id="gh-action-repos">
            <div class="row-info"><div class="row-label"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px;margin-right:6px"><path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z"/></svg><span data-i18n="github.repositories">Repositories</span></div></div>
            <span>‚Üí</span>
          </div>
          <div class="row link-row" id="gh-action-notif">
            <div class="row-info"><div class="row-label"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px;margin-right:6px"><path d="M8 16a2 2 0 0 0 1.985-1.75c.017-.137-.097-.25-.235-.25h-3.5c-.138 0-.252.113-.235.25A2 2 0 0 0 8 16ZM3 5a5 5 0 0 1 10 0v2.947c0 .05.015.098.042.139l1.703 2.555A1.519 1.519 0 0 1 13.482 13H2.518a1.516 1.516 0 0 1-1.263-2.36l1.703-2.554A.255.255 0 0 0 3 7.947Zm5-3.5A3.5 3.5 0 0 0 4.5 5v2.947c0 .346-.102.683-.294.97l-1.703 2.556a.017.017 0 0 0-.003.01l.001.006c0 .002.002.004.004.006l.006.004.007.001h10.964l.007-.001.006-.004.004-.006.001-.007a.017.017 0 0 0-.003-.01l-1.703-2.554a1.745 1.745 0 0 1-.294-.97V5A3.5 3.5 0 0 0 8 1.5Z"/></svg><span data-i18n="github.notifications">Notifications</span></div></div>
            <span>‚Üí</span>
          </div>
          <div class="row link-row" id="gh-action-sync">
            <div class="row-info"><div class="row-label"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px;margin-right:6px"><path d="M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z"/></svg><span data-i18n="settings.account_sync">Sync Bookmarks</span></div><div class="row-desc" data-i18n="settings.account_sync_desc">Upload or download bookmarks via GitHub Gist</div></div>
            <span>‚Üí</span>
          </div>
          <div class="row link-row" id="gh-action-github-page">
            <div class="row-info"><div class="row-label"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px;margin-right:6px"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg><span data-i18n="settings.account_full_page">Open GitHub Dashboard</span></div><div class="row-desc" data-i18n="settings.account_full_page_desc">Full GitHub integration page with repos, PRs, issues</div></div>
            <span>‚Üí</span>
          </div>
        </div>
        <div class="settings-card">
          <div class="row">
            <div class="row-info"><div class="row-label" data-i18n="github.logout">Sign out</div><div class="row-desc" data-i18n="settings.account_logout_desc">Disconnect your GitHub account</div></div>
            <button class="btn btn-danger btn-pill" id="gh-logout-btn" data-i18n="github.logout">Sign out</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Advanced -->
    <div class="settings-section" id="sec-advanced">
      <div class="section-title" data-i18n="settings.advanced">Advanced</div>
      <div class="section-desc" data-i18n="settings.advanced_desc">Reset and cleanup options</div>
      <div class="settings-card">
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.reset">Reset All Settings</div><div class="row-desc" data-i18n="settings.reset_desc">Restore all settings to their default values</div></div>
          <button class="btn btn-danger btn-pill" id="btn-reset" data-i18n="settings.reset_btn">Reset</button>
        </div>
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.clear_cache">Clear Cache</div><div class="row-desc" data-i18n="settings.clear_cache_desc">Remove cached files and data</div></div>
          <button class="btn btn-pill" id="btn-clear-cache" data-i18n="settings.clear_btn">Clear</button>
        </div>
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.clear_history">Clear History</div><div class="row-desc" data-i18n="settings.clear_history_desc">Remove all browsing history</div></div>
          <button class="btn btn-pill" id="btn-clear-history" data-i18n="settings.clear_btn">Clear</button>
        </div>
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.clear_cookies">Clear Cookies</div><div class="row-desc" data-i18n="settings.clear_cookies_desc">Remove all cookies and site data</div></div>
          <button class="btn btn-pill" id="btn-clear-cookies" data-i18n="settings.clear_btn">Clear</button>
        </div>
      </div>
    </div>

    <!-- About -->
    <div class="settings-section" id="sec-about">
      <div class="section-title" data-i18n="settings.about">About</div>
      <div class="section-desc" data-i18n="settings.about_desc">About GitBrowser</div>
      <div class="settings-card">
        <div class="about-logo">
          <img src="../../resources/icons/logo-icon.png" alt="GitBrowser" />
          <div class="about-name">GitBrowser</div>
          <div class="about-version" id="about-version">v0.3.0</div>
        </div>
      </div>
      <div class="settings-card">
        <div class="row">
          <div class="row-info">
            <div class="row-label" data-i18n="settings.check_update">Check for Updates</div>
            <div class="row-desc" id="update-status" data-i18n="settings.check_update_desc">Check if a newer version is available</div>
          </div>
          <button class="btn btn-pill" id="btn-check-update" style="background:var(--accent-emphasis);color:#fff;border:none;" data-i18n="settings.check_update_btn">Check</button>
        </div>
        <div class="row" id="update-progress-row" style="display:none;">
          <div style="width:100%;">
            <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
              <span class="row-label" id="update-progress-label" data-i18n="settings.downloading_update">Downloading update...</span>
              <span class="row-desc" id="update-progress-pct"></span>
            </div>
            <div style="height:4px;background:var(--glass-border);border-radius:2px;overflow:hidden;">
              <div id="update-progress-bar" style="height:100%;background:var(--accent-emphasis);border-radius:2px;width:0%;transition:width 0.3s;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="settings-card">
        <div class="row">
          <div class="row-info">
            <div class="row-label" data-i18n="settings.report_bug">Report a Problem</div>
            <div class="row-desc" data-i18n="settings.report_bug_desc">Describe the issue and send it to developers</div>
          </div>
          <button class="btn btn-pill" id="btn-report-bug" style="background:var(--accent-emphasis);color:#fff;border:none;" data-i18n="settings.report_bug_btn">Report</button>
        </div>
        <div class="row" id="bug-report-form" style="display:none;flex-direction:column;gap:var(--space-sm);">
          <textarea id="bug-report-text" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É..." style="width:100%;resize:vertical;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);color:var(--fg-default);padding:10px;border-radius:var(--radius-md);font-family:var(--font-sans);font-size:var(--text-base);outline:none;"></textarea>
          <div style="display:flex;gap:var(--space-sm);justify-content:flex-end;">
            <button class="btn btn-pill" id="bug-report-cancel" data-i18n="settings.cancel">Cancel</button>
            <button class="btn btn-pill" id="bug-report-send" style="background:var(--accent-emphasis);color:#fff;border:none;" data-i18n="settings.send">Send</button>
          </div>
          <div class="row-desc" id="bug-report-status"></div>
        </div>
      </div>
      <div class="settings-card" id="test-telemetry-card" style="display:none;">
        <div class="row">
          <div class="row-info">
            <div class="row-label">Test Telemetry</div>
            <div class="row-desc" id="telemetry-test-status">Send a test event to GitHub Issues</div>
          </div>
          <button class="btn btn-pill" id="btn-test-telemetry" style="background:var(--accent-emphasis);color:#fff;border:none;">Send Test</button>
        </div>
      </div>
      <div class="settings-card">
        <div class="row link-row" id="open-github">
          <div class="row-info"><div class="row-label"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px;margin-right:6px"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"/></svg>GitHub</div><div class="row-desc">https://github.com/gothtr/gitbrowser</div></div>
          <span>‚Üí</span>
        </div>
        <div class="row">
          <div class="row-info"><div class="row-label" data-i18n="settings.license">License</div><div class="row-desc">MIT License</div></div>
        </div>
      </div>

      <!-- Donate -->
      <div class="settings-card" id="donate-card">
        <div class="row" style="flex-direction:column;align-items:stretch;">
          <div class="row-label" style="margin-bottom:var(--space-sm);font-size:var(--text-lg);" data-i18n="settings.donate_title">üíú Support the Project</div>
          <div class="row-desc" style="margin-bottom:var(--space-md);" data-i18n="settings.donate_desc">Help us keep GitBrowser free and open-source</div>
          <div class="donate-amounts">
            <button class="donate-btn" data-amount="1">$1</button>
            <button class="donate-btn active" data-amount="5">$5</button>
            <button class="donate-btn" data-amount="10">$10</button>
            <input type="number" class="donate-custom" id="donate-custom" placeholder="$..." min="1" max="1000" />
          </div>
          <button class="donate-submit" id="btn-donate" data-i18n="settings.donate_btn">Donate via CryptoBot</button>
          <div class="donate-status" id="donate-status"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const gb = window.gitbrowser;
const savedEl = document.getElementById('saved');

// Nav switching
document.querySelectorAll('.nav-item').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('sec-' + btn.dataset.section).classList.add('active');
  };
});

function showSaved() {
  savedEl.classList.add('show');
  setTimeout(() => savedEl.classList.remove('show'), 1500);
}

async function loadSettings() {
  if (!gb) return;
  try {
    const s = await gb.getSettings();
    if (!s) return;
    if (s.general) {
      setVal('s-language', s.general.language);
      setVal('s-startup', s.general.startup_behavior);
      setVal('s-search-engine', s.general.default_search_engine);
      if (s.general.homepage) document.getElementById('s-homepage').value = s.general.homepage;
    }
    if (s.privacy) {
      setToggle('s-trackers', s.privacy.tracker_blocking);
      setToggle('s-ads', s.privacy.ad_blocking);
      setToggle('s-https', s.privacy.https_enforcement);
      setToggle('s-doh', s.privacy.dns_over_https);
      setToggle('s-fingerprint', s.privacy.anti_fingerprinting);
      setToggle('s-clear-exit', s.privacy.clear_data_on_exit);
      setToggle('s-telemetry', s.privacy.telemetry_consent);
    }
    if (s.appearance) {
      setVal('s-theme', s.appearance.theme);
      document.getElementById('s-fontsize').value = s.appearance.font_size || 14;
      if (s.appearance.show_telegram === false) setToggle('s-show-telegram', false);
      else setToggle('s-show-telegram', true);
      if (s.appearance.show_github === false) setToggle('s-show-github', false);
      else setToggle('s-show-github', true);
      let t = s.appearance.theme;
      if (t === 'System') t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'Light' : 'Dark';
      applyTheme(t);
    }
  } catch (e) { console.error('Failed to load settings:', e); }
}

function setVal(id, val) { const el = document.getElementById(id); if (el && val !== undefined) el.value = val; }
function setToggle(id, val) { const el = document.getElementById(id); if (el) { if (val) el.classList.add('on'); else el.classList.remove('on'); } }

async function saveSetting(key, value) {
  if (!gb) return;
  try {
    const result = await gb.setSetting(key, value);
    if (result && result.error) return;
    showSaved();
    if (key === 'appearance.theme') {
      let t = value;
      if (t === 'System') t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'Light' : 'Dark';
      applyTheme(t);
    }
  } catch (e) { console.error('Failed to save setting:', e); }
}

function applyTheme(theme) {
  document.documentElement.classList.add('theme-transition');
  document.documentElement.classList.toggle('light', theme === 'Light');
  setTimeout(() => document.documentElement.classList.remove('theme-transition'), 300);
  renderBgPalette();
}
if (gb && gb.onThemeChanged) gb.onThemeChanged((data) => applyTheme(data.theme));

// Wire up selects
document.getElementById('s-language').onchange = function() { saveSetting('general.language', this.value); };
document.getElementById('s-startup').onchange = function() { saveSetting('general.startup_behavior', this.value); };
document.getElementById('s-search-engine').onchange = function() { saveSetting('general.default_search_engine', this.value); };
document.getElementById('s-theme').onchange = function() { saveSetting('appearance.theme', this.value); };
document.getElementById('s-fontsize').onchange = function() { saveSetting('appearance.font_size', parseInt(this.value)); };
document.getElementById('s-homepage').onchange = function() { saveSetting('general.homepage', this.value); };

// Wire up toggles
document.querySelectorAll('.toggle').forEach(t => {
  t.onclick = function() {
    this.classList.toggle('on');
    const key = this.dataset.key;
    const isOn = this.classList.contains('on');
    if (key) saveSetting(key, isOn);
    // Direct telegram button visibility control
    if (key === 'appearance.show_telegram' && gb.telegramBtnVisible) {
      gb.telegramBtnVisible(isOn);
    }
  };
});

document.getElementById('open-passwords').onclick = () => { if (gb) gb.openPasswords(); };
document.getElementById('open-github').onclick = () => { if (gb) gb.openUrlNewTab('https://github.com/gothtr/gitbrowser'); };

// Report bug
document.getElementById('btn-report-bug').onclick = () => {
  const form = document.getElementById('bug-report-form');
  form.style.display = form.style.display === 'none' ? 'flex' : 'none';
  document.getElementById('bug-report-text').value = '';
  document.getElementById('bug-report-status').textContent = '';
};
document.getElementById('bug-report-cancel').onclick = () => {
  document.getElementById('bug-report-form').style.display = 'none';
};
document.getElementById('bug-report-send').onclick = async () => {
  const text = document.getElementById('bug-report-text').value.trim();
  const status = document.getElementById('bug-report-status');
  if (!text) { status.textContent = 'Please describe the problem'; status.style.color = 'var(--warning-fg)'; return; }
  const sendBtn = document.getElementById('bug-report-send');
  sendBtn.disabled = true;
  sendBtn.textContent = 'Sending...';
  try {
    const result = await gb.sendBugReport(text);
    if (result && result.ok) {
      status.textContent = 'Report sent! Thank you.';
      status.style.color = 'var(--success-fg)';
      setTimeout(() => { document.getElementById('bug-report-form').style.display = 'none'; }, 2000);
    } else {
      status.textContent = 'Failed: ' + (result.reason || 'unknown') + (result.status ? ' (' + result.status + ')' : '');
      status.style.color = 'var(--danger-fg)';
    }
  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = 'var(--danger-fg)';
  }
  sendBtn.disabled = false;
  sendBtn.textContent = 'Send';
};

// Test telemetry (dev mode only)
if (location.protocol === 'file:' || location.hostname === 'localhost') {
  const ttCard = document.getElementById('test-telemetry-card');
  if (ttCard) ttCard.style.display = '';
}
const ttBtn = document.getElementById('btn-test-telemetry');
if (ttBtn) ttBtn.onclick = async () => {
  const btn = document.getElementById('btn-test-telemetry');
  const status = document.getElementById('telemetry-test-status');
  btn.disabled = true;
  btn.textContent = 'Sending...';
  try {
    const result = await gb.sendTelemetry('test_event', { source: 'settings_page', test: true });
    if (result && result.ok) {
      status.textContent = 'Sent! Check Issues on GitHub.';
      status.style.color = 'var(--success-fg)';
    } else {
      status.textContent = 'Failed: ' + (result.reason || 'unknown') + (result.status ? ' (' + result.status + ')' : '') + (result.detail ? ' ‚Äî ' + result.detail.slice(0, 120) : '');
      status.style.color = 'var(--danger-fg)';
    }
  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = 'var(--danger-fg)';
  }
  btn.disabled = false;
  btn.textContent = 'Send Test';
};

// Check for updates
document.getElementById('btn-check-update').onclick = async () => {
  if (!gb || !gb.checkForUpdate) return;
  const btn = document.getElementById('btn-check-update');
  const statusEl = document.getElementById('update-status');
  btn.disabled = true;
  btn.textContent = '...';
  statusEl.textContent = '';
  try {
    const res = await gb.checkForUpdate();
    if (res.error) {
      statusEl.textContent = 'Error: ' + res.error;
      statusEl.style.color = 'var(--danger-fg)';
      btn.textContent = 'Check';
      btn.disabled = false;
      return;
    }
    if (res.upToDate) {
      statusEl.textContent = '‚úì ' + (res.version || '') + ' ‚Äî up to date';
      statusEl.style.color = 'var(--success-fg)';
      btn.textContent = 'Check';
      btn.disabled = false;
      return;
    }
    if (res.updateAvailable) {
      statusEl.textContent = 'v' + res.latestVersion + ' available';
      statusEl.style.color = 'var(--accent-fg)';
      if (res.downloadUrl) {
        btn.textContent = 'Install';
        btn.disabled = false;
        btn.onclick = () => installUpdate(res.downloadUrl, res.latestVersion);
      } else {
        btn.textContent = 'Open';
        btn.disabled = false;
        btn.onclick = () => { gb.openUrlNewTab('https://github.com/gothtr/gitbrowser/releases/latest'); };
      }
    }
  } catch (err) {
    statusEl.textContent = 'Error';
    statusEl.style.color = 'var(--danger-fg)';
    btn.textContent = 'Check';
    btn.disabled = false;
  }
};

async function installUpdate(downloadUrl, version) {
  const btn = document.getElementById('btn-check-update');
  const statusEl = document.getElementById('update-status');
  const progressRow = document.getElementById('update-progress-row');
  const progressBar = document.getElementById('update-progress-bar');
  const progressLabel = document.getElementById('update-progress-label');
  btn.disabled = true;
  btn.textContent = '...';
  progressRow.style.display = '';
  progressBar.style.width = '30%';
  statusEl.textContent = 'Downloading v' + version + '...';
  statusEl.style.color = 'var(--fg-muted)';
  try {
    progressBar.style.width = '60%';
    const res = await gb.downloadAndInstallUpdate({ downloadUrl });
    if (res.ok) {
      progressBar.style.width = '100%';
      progressLabel.textContent = 'Installing... browser will restart';
      statusEl.textContent = 'Installing...';
    } else {
      progressRow.style.display = 'none';
      statusEl.textContent = 'Error: ' + (res.error || 'Unknown');
      statusEl.style.color = 'var(--danger-fg)';
      btn.textContent = 'Retry';
      btn.disabled = false;
    }
  } catch {
    progressRow.style.display = 'none';
    statusEl.textContent = 'Download failed';
    statusEl.style.color = 'var(--danger-fg)';
    btn.textContent = 'Retry';
    btn.disabled = false;
  }
}

// Background color palette
const BG_COLORS_DARK = [null, '#1a1a2e', '#16213e', '#0f3460', '#1b1b2f', '#2d132c', '#1c1c1c', '#212121', '#263238', '#1b262c', '#0a1931', '#2c3333', '#3c1642'];
const BG_COLORS_LIGHT = [null, '#f0f4f8', '#e8eaf6', '#e3f2fd', '#fce4ec', '#f3e5f5', '#e0f2f1', '#fff8e1', '#efebe9', '#eceff1', '#f1f8e9', '#e8f5e9', '#fafafa'];

function renderBgPalette() {
  const palette = document.getElementById('bg-palette');
  if (!palette) return;
  palette.innerHTML = '';
  const isLight = document.documentElement.classList.contains('light');
  const colors = isLight ? BG_COLORS_LIGHT : BG_COLORS_DARK;
  const saved = localStorage.getItem('newtab_bg');
  colors.forEach((c, i) => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch' + (i === 0 ? ' reset-swatch' : '') + ((c === saved || (i === 0 && !saved)) ? ' active' : '');
    if (c) sw.style.background = c;
    sw.title = i === 0 ? 'Default' : c;
    sw.onclick = () => {
      if (c) localStorage.setItem('newtab_bg', c);
      else localStorage.removeItem('newtab_bg');
      palette.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
      sw.classList.add('active');
      saveSetting('appearance.newtab_bg', c || '');
    };
    palette.appendChild(sw);
  });
}

// Accent color palette
const ACCENT_COLORS = ['#60a5fa', '#818cf8', '#a78bfa', '#c084fc', '#f472b6', '#fb7185', '#f97316', '#facc15', '#4ade80', '#2dd4bf', '#22d3ee', '#38bdf8'];

function renderAccentPalette() {
  const palette = document.getElementById('accent-palette');
  if (!palette) return;
  palette.innerHTML = '';
  const saved = localStorage.getItem('accent_color') || '#60a5fa';
  ACCENT_COLORS.forEach(c => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch' + (c === saved ? ' active' : '');
    sw.style.background = c;
    sw.title = c;
    sw.onclick = () => {
      localStorage.setItem('accent_color', c);
      palette.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
      sw.classList.add('active');
      saveSetting('appearance.accent_color', c);
    };
    palette.appendChild(sw);
  });
}

renderBgPalette();
renderAccentPalette();

// Advanced: Reset
document.getElementById('btn-reset').onclick = async () => {
  if (!gb) return;
  await gb.setSetting('general.language', 'en');
  await gb.setSetting('general.startup_behavior', 'Restore');
  await gb.setSetting('general.default_search_engine', 'google');
  await gb.setSetting('general.homepage', '');
  await gb.setSetting('privacy.tracker_blocking', true);
  await gb.setSetting('privacy.ad_blocking', true);
  await gb.setSetting('privacy.https_enforcement', true);
  await gb.setSetting('privacy.dns_over_https', true);
  await gb.setSetting('privacy.anti_fingerprinting', true);
  await gb.setSetting('privacy.clear_data_on_exit', false);
  await gb.setSetting('privacy.telemetry_consent', false);
  await gb.setSetting('appearance.theme', 'System');
  await gb.setSetting('appearance.font_size', 14);
  await gb.setSetting('appearance.show_telegram', true);
  await gb.setSetting('appearance.show_github', true);
  localStorage.removeItem('newtab_bg');
  localStorage.removeItem('accent_color');
  loadSettings();
  renderBgPalette();
  renderAccentPalette();
  showSaved();
};

// Advanced: Clear cache/history/cookies
document.getElementById('btn-clear-cache').onclick = async () => {
  if (!gb || !gb.clearCache) return;
  try { await gb.clearCache(); showSaved(); } catch {}
};
document.getElementById('btn-clear-history').onclick = async () => {
  if (!gb) return;
  try { gb.clearHistory(); showSaved(); } catch {}
};
document.getElementById('btn-clear-cookies').onclick = async () => {
  if (!gb || !gb.clearCookies) return;
  try { await gb.clearCookies(); showSaved(); } catch {}
};

// Donate
let selectedAmount = 5;
document.querySelectorAll('.donate-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.donate-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedAmount = parseFloat(btn.dataset.amount);
    document.getElementById('donate-custom').value = '';
  };
});
document.getElementById('donate-custom').oninput = function() {
  if (this.value) {
    document.querySelectorAll('.donate-btn').forEach(b => b.classList.remove('active'));
    selectedAmount = parseFloat(this.value) || 5;
  }
};

document.getElementById('btn-donate').onclick = async () => {
  if (!gb || !gb.createDonateInvoice) return;
  const amount = selectedAmount;
  if (!amount || amount < 1) return;
  const statusEl = document.getElementById('donate-status');
  const btn = document.getElementById('btn-donate');
  btn.disabled = true;
  statusEl.textContent = '...';
  statusEl.className = 'donate-status';
  try {
    const result = await gb.createDonateInvoice(amount);
    if (result && result.bot_invoice_url) {
      gb.openUrlNewTab(result.bot_invoice_url);
      statusEl.textContent = '‚úì';
    } else if (result && result.error) {
      statusEl.textContent = result.error;
      statusEl.className = 'donate-status error';
    }
  } catch (e) {
    statusEl.textContent = 'Error';
    statusEl.className = 'donate-status error';
  }
  btn.disabled = false;
};

loadSettings();

// GitHub Account section logic
function ghShowState(state) {
  document.getElementById('gh-login-card').style.display = state === 'login' ? '' : 'none';
  document.getElementById('gh-device-card').style.display = state === 'device' ? '' : 'none';
  document.getElementById('gh-profile-card').style.display = state === 'profile' ? '' : 'none';
  document.getElementById('gh-actions-card').style.display = state === 'profile' ? '' : 'none';
}

async function loadGitHubAccount() {
  if (!gb || !gb.githubApi) return;
  try {
    const user = await gb.githubApi({ endpoint: '/user' });
    if (user && user.login && !user.error) {
      ghShowState('profile');
      document.getElementById('gh-avatar').src = user.avatar_url || '';
      document.getElementById('gh-username').textContent = user.name || user.login;
      document.getElementById('gh-bio').textContent = user.bio || ('@' + user.login);
    } else {
      ghShowState('login');
    }
  } catch {
    ghShowState('login');
  }
}

// Login button ‚Äî start Device Flow
document.getElementById('gh-login-btn').onclick = async () => {
  if (!gb) return;
  const btn = document.getElementById('gh-login-btn');
  btn.disabled = true;
  btn.textContent = '...';
  try {
    const res = await gb.githubDeviceLogin();
    if (res.error) {
      btn.textContent = 'Error: ' + res.error;
      btn.disabled = false;
      return;
    }
    // Show device code view
    ghShowState('device');
    document.getElementById('gh-user-code').textContent = res.userCode;
    const link = document.getElementById('gh-verify-link');
    link.textContent = res.verificationUri;
    link.href = res.verificationUri;
    link.onclick = (e) => { e.preventDefault(); gb.openUrlNewTab(res.verificationUri); };
    // Copy code on click
    document.getElementById('gh-user-code').onclick = () => {
      navigator.clipboard.writeText(res.userCode).catch(() => {});
    };
    // Open verification URL automatically
    gb.openUrlNewTab(res.verificationUri);
    // Start polling
    ghPollForToken(res.deviceCode, (res.interval || 5) * 1000);
  } catch (err) {
    btn.textContent = 'Error';
    btn.disabled = false;
  }
};

async function ghPollForToken(deviceCode, interval) {
  const statusEl = document.getElementById('gh-poll-status');
  const poll = async () => {
    try {
      const res = await gb.githubDevicePoll({ deviceCode });
      if (res.status === 'ok') {
        statusEl.innerHTML = '<span style="color:var(--success-fg)">‚úì</span> Authorized!';
        setTimeout(() => loadGitHubAccount(), 500);
        return;
      }
      if (res.status === 'expired') {
        statusEl.innerHTML = 'Code expired.';
        setTimeout(() => {
          ghShowState('login');
          const btn = document.getElementById('gh-login-btn');
          btn.disabled = false;
          btn.textContent = 'Sign in with GitHub';
        }, 2000);
        return;
      }
      if (res.status === 'error') {
        statusEl.innerHTML = 'Error: ' + (res.error || 'Unknown');
        return;
      }
      setTimeout(poll, res.status === 'slow_down' ? interval + 5000 : interval);
    } catch {
      statusEl.innerHTML = 'Network error';
    }
  };
  setTimeout(poll, interval);
}

// Action buttons
document.getElementById('gh-action-repos').onclick = () => { if (gb) gb.openUrlNewTab('https://github.com'); };
document.getElementById('gh-action-notif').onclick = () => { if (gb) gb.openUrlNewTab('https://github.com/notifications'); };
document.getElementById('gh-action-github-page').onclick = () => { if (gb) gb.openGitHub(); };
document.getElementById('gh-action-sync').onclick = async () => {
  if (!gb) return;
  const row = document.getElementById('gh-action-sync');
  const origText = row.querySelector('span[data-i18n]').textContent;
  row.querySelector('span[data-i18n]').textContent = '‚è≥ ...';
  try {
    const r = await gb.githubSyncBookmarksUpload({});
    row.querySelector('span[data-i18n]').textContent = r.ok ? '‚úì Synced' : '‚úï ' + (r.error || 'Error');
  } catch {
    row.querySelector('span[data-i18n]').textContent = '‚úï Error';
  }
  setTimeout(() => { row.querySelector('span[data-i18n]').textContent = origText; }, 2000);
};
document.getElementById('gh-logout-btn').onclick = async () => {
  if (!gb) return;
  try { await gb.githubLogout(); } catch {}
  ghShowState('login');
  const btn = document.getElementById('gh-login-btn');
  btn.disabled = false;
  btn.textContent = 'Sign in with GitHub';
};

loadGitHubAccount();

// Localization
async function loadLocale() {
  if (!gb || !gb.getLocaleData) return;
  try {
    const { data: t } = await gb.getLocaleData();
    if (!t) return;
    // Apply all data-i18n attributes
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      const parts = key.split('.');
      let val = t;
      for (const p of parts) { val = val && val[p]; }
      if (val) el.textContent = val;
    });
    // Nav items (have icons + text)
    const navItems = document.querySelectorAll('.nav-item');
    const navKeys = ['general', 'appearance', 'privacy', 'account', 'advanced', 'about'];
    navItems.forEach((item, i) => {
      if (t.settings && t.settings[navKeys[i]]) {
        const textNode = item.childNodes[item.childNodes.length - 1];
        if (textNode) textNode.textContent = ' ' + t.settings[navKeys[i]];
      }
    });
    // Saved indicator
    if (t.settings && t.settings.saved) document.getElementById('saved').textContent = t.settings.saved;
  } catch {}
}
loadLocale();
</script>
</body>
</html>
