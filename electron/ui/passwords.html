<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
:root {
  --bg-canvas: #0d1117; --bg-default: #161b22; --bg-subtle: #1c2128;
  --fg-default: #e6edf3; --fg-muted: #7d8590; --fg-subtle: #484f58;
  --border-default: #30363d; --border-muted: #21262d;
  --accent-fg: #58a6ff; --accent-emphasis: #1f6feb;
  --success-fg: #3fb950; --danger-fg: #f85149;
}
html.light {
  --bg-canvas: #ffffff; --bg-default: #f6f8fa; --bg-subtle: #f0f2f5;
  --fg-default: #24292f; --fg-muted: #57606a; --fg-subtle: #8c959f;
  --border-default: #d0d7de; --border-muted: #d8dee4;
  --accent-fg: #0969da; --accent-emphasis: #0969da;
  --success-fg: #1a7f37; --danger-fg: #cf222e;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
  background: var(--bg-canvas); color: var(--fg-default);
  height: 100vh; overflow-y: auto;
}
.page { max-width: 640px; margin: 0 auto; padding: 32px 24px; }
.page-title { font-size: 22px; font-weight: 600; margin-bottom: 4px; animation: fadeIn 0.4s; }
.page-desc { color: var(--fg-muted); font-size: 14px; margin-bottom: 24px; animation: fadeIn 0.4s 0.05s both; }
@keyframes fadeIn { from { opacity:0; transform:translateY(6px); } }
</style>
</head>
<body>
<!-- Unlock View -->
<div id="unlock-view" class="page" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh">
<style>
.lock-icon { font-size: 48px; margin-bottom: 16px; animation: fadeIn 0.4s; }
.unlock-title { font-size: 22px; font-weight: 600; margin-bottom: 8px; animation: fadeIn 0.4s 0.05s both; }
.unlock-desc { color: var(--fg-muted); font-size: 14px; margin-bottom: 24px; text-align: center; animation: fadeIn 0.4s 0.1s both; }
.unlock-input {
  width: 320px; padding: 12px 16px; border: 1px solid var(--border-default); border-radius: 8px;
  background: var(--bg-default); color: var(--fg-default); font-family: inherit; font-size: 14px;
  outline: none; text-align: center; margin-bottom: 12px;
}
.unlock-input:focus { border-color: var(--accent-emphasis); box-shadow: 0 0 0 3px rgba(31,111,235,0.2); }
.unlock-btn {
  padding: 10px 32px; border: none; border-radius: 8px; background: var(--accent-emphasis);
  color: #fff; font-family: inherit; font-size: 14px; font-weight: 500; cursor: pointer;
  transition: all 0.15s;
}
.unlock-btn:hover { filter: brightness(1.1); }
.unlock-error { color: var(--danger-fg); font-size: 13px; margin-top: 8px; min-height: 20px; }
</style>
<div class="lock-icon">üîí</div>
<div class="unlock-title">Password Manager</div>
<div class="unlock-desc">Enter your master password to unlock saved credentials.<br>First time? This will set your master password.</div>
<input id="master-pw" class="unlock-input" type="password" placeholder="Master password..." autofocus />
<button class="unlock-btn" id="btn-unlock">Unlock</button>
<div class="unlock-error" id="unlock-error"></div>
</div>

<!-- Main View -->
<div id="main-view" style="display:none">
<style>
.toolbar-row {
  display: flex; gap: 8px; margin-bottom: 16px; align-items: center;
  animation: fadeIn 0.4s 0.1s both;
}
.search-input {
  flex: 1; padding: 10px 14px; border: 1px solid var(--border-default); border-radius: 8px;
  background: var(--bg-default); color: var(--fg-default); font-family: inherit; font-size: 13px; outline: none;
}
.search-input:focus { border-color: var(--accent-emphasis); }
.tb-btn {
  padding: 8px 16px; border: 1px solid var(--border-default); border-radius: 8px;
  background: var(--bg-default); color: var(--fg-default); cursor: pointer;
  font-family: inherit; font-size: 13px; white-space: nowrap; transition: all 0.12s;
}
.tb-btn:hover { border-color: var(--accent-emphasis); color: var(--accent-fg); }
.tb-btn.primary { background: var(--accent-emphasis); color: #fff; border-color: var(--accent-emphasis); }
.tb-btn.danger { color: var(--danger-fg); }
.tb-btn.danger:hover { border-color: var(--danger-fg); }
.cred-list { animation: fadeIn 0.4s 0.15s both; }
.cred-card {
  display: flex; align-items: center; padding: 14px; background: var(--bg-default);
  border: 1px solid var(--border-muted); border-radius: 8px; margin-bottom: 6px;
  transition: all 0.12s; gap: 12px;
}
.cred-card:hover { border-color: var(--accent-fg); background: var(--bg-subtle); }
.cred-icon { width: 32px; height: 32px; border-radius: 6px; background: var(--bg-subtle);
  display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; overflow: hidden; }
.cred-icon img { width: 18px; height: 18px; }
.cred-info { flex: 1; min-width: 0; }
.cred-url { font-size: 13px; font-weight: 500; color: var(--accent-fg); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cred-user { font-size: 12px; color: var(--fg-muted); margin-top: 2px; }
.cred-actions { display: flex; gap: 4px; }
.cred-btn {
  padding: 4px 10px; border: 1px solid var(--border-muted); border-radius: 6px;
  background: none; color: var(--fg-muted); cursor: pointer; font-size: 11px;
  font-family: inherit; transition: all 0.12s;
}
.cred-btn:hover { border-color: var(--accent-fg); color: var(--accent-fg); }
.cred-btn.del:hover { border-color: var(--danger-fg); color: var(--danger-fg); }
.empty-state { text-align: center; padding: 48px 16px; color: var(--fg-muted); font-size: 14px; }
/* Dialog */
.dialog-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex;
  align-items: center; justify-content: center; z-index: 100; animation: fadeIn 0.15s;
}
.dialog {
  background: var(--bg-default); border: 1px solid var(--border-default);
  border-radius: 12px; padding: 24px; width: 400px;
}
.dialog h3 { font-size: 16px; margin-bottom: 16px; }
.dialog label { display: block; font-size: 12px; color: var(--fg-muted); margin-bottom: 4px; }
.dialog input {
  width: 100%; padding: 8px 12px; border: 1px solid var(--border-default);
  border-radius: 6px; background: var(--bg-canvas); color: var(--fg-default);
  font-family: inherit; font-size: 13px; outline: none; margin-bottom: 10px;
}
.dialog input:focus { border-color: var(--accent-emphasis); }
.dialog-btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px; }
.dialog-btns button {
  padding: 6px 16px; border-radius: 6px; border: 1px solid var(--border-default);
  background: var(--bg-subtle); color: var(--fg-default); cursor: pointer;
  font-family: inherit; font-size: 13px;
}
.dialog-btns .primary { background: var(--accent-emphasis); color: #fff; border-color: var(--accent-emphasis); }
.gen-row { display: flex; gap: 6px; align-items: center; margin-bottom: 10px; }
.gen-row input[type="text"] { flex: 1; margin-bottom: 0; }
.gen-btn { padding: 8px 12px; border: 1px solid var(--border-default); border-radius: 6px;
  background: var(--bg-subtle); color: var(--fg-muted); cursor: pointer; font-size: 12px; font-family: inherit; }
.gen-btn:hover { color: var(--accent-fg); border-color: var(--accent-fg); }
</style>
<div class="page">
  <div class="page-title">üîë Password Manager</div>
  <div class="page-desc">Manage your saved credentials securely.</div>
  <div class="toolbar-row">
    <input class="search-input" id="pw-search" type="text" placeholder="Search by URL..." />
    <button class="tb-btn primary" id="btn-add">+ Add</button>
    <button class="tb-btn" id="btn-gen">Generate</button>
    <button class="tb-btn danger" id="btn-lock">Lock</button>
  </div>
  <div class="cred-list" id="cred-list"></div>
</div>
</div>

<script>
const gb = window.gitbrowser;
let allCreds = [];

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

// ‚îÄ‚îÄ‚îÄ Unlock ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-unlock').onclick = doUnlock;
document.getElementById('master-pw').addEventListener('keydown', (e) => { if (e.key === 'Enter') doUnlock(); });

async function doUnlock() {
  const pw = document.getElementById('master-pw').value;
  if (!pw) return;
  const errEl = document.getElementById('unlock-error');
  errEl.textContent = '';
  const res = await gb.passwordUnlock({ masterPassword: pw });
  if (res && res.error) { errEl.textContent = res.error; return; }
  if (res && res.ok === false) { errEl.textContent = 'Wrong master password'; return; }
  document.getElementById('unlock-view').style.display = 'none';
  document.getElementById('main-view').style.display = '';
  loadCredentials();
}

// Check if already unlocked
gb.passwordIsUnlocked().then(res => {
  if (res && res.unlocked) {
    document.getElementById('unlock-view').style.display = 'none';
    document.getElementById('main-view').style.display = '';
    loadCredentials();
  }
}).catch(() => {});

// ‚îÄ‚îÄ‚îÄ Credentials ‚îÄ‚îÄ‚îÄ
async function loadCredentials(query) {
  const res = await gb.passwordList({ url: query || '' });
  if (res && res.error) { document.getElementById('cred-list').innerHTML = '<div class="empty-state">Error: ' + esc(res.error) + '</div>'; return; }
  allCreds = Array.isArray(res) ? res : [];
  renderCreds(allCreds);
}

function renderCreds(creds) {
  const el = document.getElementById('cred-list');
  if (!creds.length) { el.innerHTML = '<div class="empty-state">No saved passwords</div>'; return; }
  el.innerHTML = creds.map((c, i) => {
    let favicon = '';
    try { favicon = 'https://www.google.com/s2/favicons?sz=32&domain=' + new URL(c.url).hostname; } catch {}
    const iconHtml = favicon
      ? `<img src="${esc(favicon)}" onerror="this.parentElement.textContent='üîë'" />`
      : 'üîë';
    return `<div class="cred-card">
      <div class="cred-icon">${iconHtml}</div>
      <div class="cred-info">
        <div class="cred-url">${esc(c.url)}</div>
        <div class="cred-user">${esc(c.username)}</div>
      </div>
      <div class="cred-actions">
        <button class="cred-btn" onclick="copyPw(${i})" title="Copy password">üìã</button>
        <button class="cred-btn" onclick="editCred(${i})" title="Edit">‚úèÔ∏è</button>
        <button class="cred-btn del" onclick="deleteCred('${esc(c.id)}')" title="Delete">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

async function copyPw(idx) {
  const c = allCreds[idx];
  if (c && c.password) {
    try { await navigator.clipboard.writeText(c.password); } catch {}
  }
}

async function deleteCred(id) {
  await gb.passwordDelete({ id });
  loadCredentials(document.getElementById('pw-search').value.trim());
}

// ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ
let searchTimer;
document.getElementById('pw-search').addEventListener('input', (e) => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => loadCredentials(e.target.value.trim()), 300);
});

// ‚îÄ‚îÄ‚îÄ Lock ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-lock').onclick = async () => {
  await gb.passwordLock();
  document.getElementById('main-view').style.display = 'none';
  document.getElementById('unlock-view').style.display = '';
  document.getElementById('master-pw').value = '';
  document.getElementById('unlock-error').textContent = '';
};

// ‚îÄ‚îÄ‚îÄ Add / Edit Dialog ‚îÄ‚îÄ‚îÄ
function showCredDialog(title, defaults, onSave) {
  const overlay = document.createElement('div');
  overlay.className = 'dialog-overlay';
  overlay.innerHTML = `<div class="dialog">
    <h3>${esc(title)}</h3>
    <label>URL</label><input id="d-url" value="${esc(defaults.url || '')}" placeholder="https://..." />
    <label>Username</label><input id="d-user" value="${esc(defaults.username || '')}" placeholder="user@example.com" />
    <label>Password</label>
    <div class="gen-row">
      <input id="d-pw" type="text" value="${esc(defaults.password || '')}" placeholder="password" />
      <button class="gen-btn" id="d-gen">üé≤</button>
    </div>
    <div class="dialog-btns">
      <button id="d-cancel">Cancel</button>
      <button id="d-save" class="primary">Save</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('#d-cancel').onclick = () => overlay.remove();
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
  overlay.querySelector('#d-gen').onclick = async () => {
    const res = await gb.passwordGenerate({ length: 20, uppercase: true, lowercase: true, numbers: true, symbols: true });
    if (res && res.password) overlay.querySelector('#d-pw').value = res.password;
  };
  overlay.querySelector('#d-save').onclick = () => {
    const url = overlay.querySelector('#d-url').value.trim();
    const username = overlay.querySelector('#d-user').value.trim();
    const password = overlay.querySelector('#d-pw').value;
    if (!url || !username || !password) return;
    onSave({ url, username, password });
    overlay.remove();
  };
  overlay.querySelector('#d-url').focus();
}

document.getElementById('btn-add').onclick = () => {
  showCredDialog('Add Credential', {}, async (data) => {
    await gb.passwordSave(data);
    loadCredentials(document.getElementById('pw-search').value.trim());
  });
};

function editCred(idx) {
  const c = allCreds[idx];
  if (!c) return;
  showCredDialog('Edit Credential', c, async (data) => {
    await gb.passwordUpdate({ id: c.id, username: data.username, password: data.password });
    loadCredentials(document.getElementById('pw-search').value.trim());
  });
}

// ‚îÄ‚îÄ‚îÄ Generate standalone ‚îÄ‚îÄ‚îÄ
document.getElementById('btn-gen').onclick = async () => {
  const res = await gb.passwordGenerate({ length: 20, uppercase: true, lowercase: true, numbers: true, symbols: true });
  if (res && res.password) {
    try { await navigator.clipboard.writeText(res.password); } catch {}
    alert('Generated password copied to clipboard:\n' + res.password);
  }
};

// ‚îÄ‚îÄ‚îÄ Theme ‚îÄ‚îÄ‚îÄ
function applyTheme(t) { document.documentElement.classList.toggle('light', t === 'Light'); }
if (gb) {
  gb.onThemeChanged((d) => applyTheme(d.theme));
  gb.getSettings().then(s => {
    if (s && s.appearance) {
      let t = s.appearance.theme;
      if (t === 'System') t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'Light' : 'Dark';
      applyTheme(t);
    }
  }).catch(() => {});
}
</script>
</body>
</html>
