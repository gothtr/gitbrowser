<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<link rel="stylesheet" href="design-tokens.css" />
<link rel="stylesheet" href="components.css" />
<style>
body {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--space-2xl);
  user-select: none;
  transition: background var(--duration-normal) var(--ease-out);
}

.hero {
  text-align: center;
  margin-bottom: var(--space-3xl);
  animation: heroIn var(--duration-slow) var(--ease-out);
}

@keyframes heroIn {
  from { opacity: 0; transform: translateY(-12px); }
  to { opacity: 1; transform: translateY(0); }
}

.greeting {
  font-size: var(--text-3xl);
  font-weight: 600;
  letter-spacing: -0.5px;
  color: var(--fg-default);
  margin-bottom: var(--space-xs);
}

.brand {
  font-size: var(--text-sm);
  font-weight: 500;
  letter-spacing: 1px;
  color: var(--fg-default);
  margin-bottom: var(--space-xs);
}

.subtitle {
  color: var(--fg-muted);
  font-size: var(--text-md);
}

.search {
  width: 100%;
  max-width: 560px;
  position: relative;
  margin-bottom: var(--space-2xl);
  animation: fadeUp var(--duration-slow) var(--ease-out) 0.1s both;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.search input {
  width: 100%;
  padding: 14px 20px 14px 44px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  color: var(--fg-default);
  font-size: var(--text-md);
  font-family: var(--font-sans);
  outline: none;
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  transition: all var(--duration-fast) var(--ease-out);
}

.search input:focus {
  border-color: var(--accent-emphasis);
  box-shadow: 0 0 0 3px var(--accent-glow), 0 4px 20px rgba(0, 0, 0, 0.15);
  background: rgba(255, 255, 255, 0.08);
}

.search input::placeholder { color: var(--fg-subtle); }

.search svg {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--fg-subtle);
}

.quick-links {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--space-md);
  max-width: 560px;
  width: 100%;
  animation: fadeUp var(--duration-slow) var(--ease-out) 0.2s both;
}

@media (max-width: 560px) {
  .quick-links { grid-template-columns: repeat(2, 1fr); }
}

.quick-link {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--space-sm);
  padding: var(--space-lg) var(--space-md);
  background: var(--glass-bg-solid);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--duration-fast) var(--spring);
  color: var(--fg-default);
  font-size: var(--text-sm);
  position: relative;
  box-shadow: var(--glass-shadow), var(--glass-inner-glow);
}

.quick-link:hover {
  border-color: var(--glass-border-hover);
  transform: translateY(-3px);
  box-shadow: var(--glass-shadow-lg), var(--glass-inner-glow);
}

.quick-link:active { transform: translateY(0) scale(0.97); }

.quick-link .ql-del {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 18px;
  height: 18px;
  border: none;
  background: var(--bg-subtle);
  color: var(--fg-subtle);
  border-radius: 50%;
  cursor: pointer;
  font-size: 12px;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all var(--duration-fast);
}

.quick-link:hover .ql-del { opacity: 1; }
.quick-link .ql-del:hover { background: var(--danger-emphasis); color: #fff; }

.quick-link-icon {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-sm);
  background: var(--bg-subtle);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: var(--text-lg);
  font-weight: 700;
  color: var(--accent-fg);
  transition: all var(--duration-fast);
  overflow: hidden;
}

.quick-link-icon img { width: 22px; height: 22px; }

.quick-link:hover .quick-link-icon {
  background: var(--accent-emphasis);
  color: white;
}

.quick-link-add {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: var(--space-xs);
  padding: var(--space-lg) var(--space-md);
  background: transparent;
  border: 2px dashed var(--glass-border);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-out);
  color: var(--fg-subtle);
  font-size: var(--text-sm);
}

.quick-link-add:hover {
  border-color: var(--accent-fg);
  color: var(--accent-fg);
  background: rgba(96, 165, 250, 0.04);
}

.quick-link-add .plus { font-size: 24px; font-weight: 300; }

/* Background picker */
.bg-picker {
  position: fixed;
  bottom: 16px;
  right: 16px;
  display: flex;
  gap: 6px;
  align-items: center;
  padding: 6px 10px;
  background: var(--glass-bg-solid);
  backdrop-filter: var(--glass-blur);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-sm);
  opacity: 0.3;
  transition: opacity var(--duration-fast);
  z-index: 10;
}

.bg-picker:hover { opacity: 1; }

.bg-swatch {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all var(--duration-fast);
}

.bg-swatch:hover, .bg-swatch.active {
  border-color: var(--accent-fg);
  transform: scale(1.2);
}

.bg-swatch.reset {
  background: var(--bg-canvas);
  border: 2px dashed var(--border-default);
}

/* Add dialog uses components.css classes */
</style>
</head>
<body>

<div class="hero">
  <div class="greeting" id="greeting">Good evening</div>
  <div class="brand">GitBrowser</div>
  <div class="subtitle">Fast. Private. Open.</div>
</div>

<div class="search">
  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M10.68 11.74a6 6 0 0 1-7.922-8.982 6 6 0 0 1 8.982 7.922l3.04 3.04a.749.749 0 1 1-1.06 1.06l-3.04-3.04ZM11.5 7a4.499 4.499 0 1 0-8.997 0A4.499 4.499 0 0 0 11.5 7Z"/></svg>
  <input id="search" type="text" placeholder="Search the web or enter URL..." autofocus />
</div>

<div class="quick-links" id="quick-links"></div>

<script>
const DEFAULT_LINKS = [
  { name: 'GitHub', url: 'https://github.com' },
  { name: 'Google', url: 'https://google.com' },
  { name: 'YouTube', url: 'https://youtube.com' },
  { name: 'Reddit', url: 'https://reddit.com' },
  { name: 'Stack Overflow', url: 'https://stackoverflow.com' },
  { name: 'Wikipedia', url: 'https://wikipedia.org' },
  { name: 'X / Twitter', url: 'https://twitter.com' },
];

function getLinks() {
  try { const s = localStorage.getItem('quick_links'); if (s) return JSON.parse(s); } catch {}
  return DEFAULT_LINKS;
}
function saveLinks(links) { localStorage.setItem('quick_links', JSON.stringify(links)); }

function renderLinks() {
  const container = document.getElementById('quick-links');
  container.innerHTML = '';
  const links = getLinks();
  links.forEach((l, i) => {
    const div = document.createElement('div');
    div.className = 'quick-link';
    const letter = (l.name || l.url || '?')[0].toUpperCase();
    let faviconUrl = '';
    try {
      const hostname = new URL(l.url).hostname;
      // Use the site's own favicon first, with Google API as fallback
      faviconUrl = 'https://' + hostname + '/favicon.ico';
    } catch {}
    const iconContent = faviconUrl
      ? `<img src="${esc(faviconUrl)}" onerror="this.onerror=null;this.src='https://www.google.com/s2/favicons?sz=32&domain=${esc(new URL(l.url).hostname)}';this.onerror=function(){this.parentElement.textContent='${esc(letter)}'}" />`
      : esc(letter);
    div.innerHTML = `<div class="quick-link-icon">${iconContent}</div>${esc(l.name)}<button class="ql-del" title="Remove">\u00D7</button>`;
    div.addEventListener('click', (e) => {
      if (e.target.closest('.ql-del')) return;
      const gb = window.gitbrowser;
      if (gb) gb.navigate(l.url);
      else document.title = '__gb_navigate:' + l.url;
    });
    div.querySelector('.ql-del').addEventListener('click', (e) => {
      e.stopPropagation();
      const arr = getLinks(); arr.splice(i, 1); saveLinks(arr); renderLinks();
    });
    container.appendChild(div);
  });
  const addBtn = document.createElement('div');
  addBtn.className = 'quick-link-add';
  addBtn.innerHTML = '<div class="plus">+</div>Add';
  addBtn.onclick = showAddDialog;
  container.appendChild(addBtn);
}

function showAddDialog() {
  const overlay = document.createElement('div');
  overlay.className = 'dialog-overlay';
  overlay.innerHTML = `<div class="dialog" style="animation:scaleIn var(--duration-normal) var(--spring)">
    <h3>Add Quick Link</h3>
    <input class="input" id="ql-name" placeholder="Name" style="margin-bottom:10px" />
    <input class="input" id="ql-url" placeholder="URL (https://...)" />
    <div class="dialog-actions">
      <button class="btn btn-ghost" id="ql-cancel">Cancel</button>
      <button class="btn btn-primary btn-pill" id="ql-save">Add</button>
    </div>
  </div>`;
  document.body.appendChild(overlay);
  overlay.querySelector('#ql-cancel').onclick = () => overlay.remove();
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
  overlay.querySelector('#ql-save').onclick = () => {
    const name = overlay.querySelector('#ql-name').value.trim();
    let url = overlay.querySelector('#ql-url').value.trim();
    if (!name || !url) return;
    if (!url.startsWith('http')) url = 'https://' + url;
    const arr = getLinks(); arr.push({ name, url }); saveLinks(arr);
    overlay.remove(); renderLinks();
  };
  overlay.querySelector('#ql-name').focus();
  overlay.querySelector('#ql-url').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') overlay.querySelector('#ql-save').click();
  });
}

function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

renderLinks();

document.getElementById('search').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && e.target.value.trim()) {
    const gb = window.gitbrowser;
    if (gb) gb.navigate(e.target.value.trim());
    else document.title = '__gb_navigate:' + e.target.value.trim();
  }
});

// Theme
const gb = window.gitbrowser;
function applyTheme(t) { document.documentElement.classList.add('theme-transition'); document.documentElement.classList.toggle('light', t === 'Light'); setTimeout(() => document.documentElement.classList.remove('theme-transition'), 300); }
if (gb) {
  gb.onThemeChanged((d) => applyTheme(d.theme));
  gb.getSettings().then(s => {
    if (s && s.appearance) {
      let t = s.appearance.theme;
      if (t === 'System') t = window.matchMedia('(prefers-color-scheme: light)').matches ? 'Light' : 'Dark';
      applyTheme(t);
    }
  }).catch(() => {});
}

// Localization
let _nt = {};
if (gb && gb.getLocaleData) {
  gb.getLocaleData().then(({ data: t }) => {
    if (!t || !t.newtab) return;
    _nt = t.newtab;
    const sub = document.querySelector('.subtitle');
    if (sub && _nt.subtitle) sub.textContent = _nt.subtitle;
    const si = document.getElementById('search');
    if (si && _nt.search_placeholder) si.placeholder = _nt.search_placeholder;
    updateGreeting();
  }).catch(() => {});
}

// Greeting (no clock per redesign plan)
function updateGreeting() {
  const h = new Date().getHours();
  const greetEl = document.getElementById('greeting');
  if (!greetEl) return;
  let g;
  if (h >= 5 && h < 12) g = _nt.good_morning || 'Good morning';
  else if (h >= 12 && h < 18) g = _nt.good_afternoon || 'Good afternoon';
  else g = _nt.good_evening || 'Good evening';
  greetEl.textContent = g;
}
updateGreeting();

// Background color picker
const BG_COLORS = [null, '#1a1a2e', '#16213e', '#0f3460', '#1b1b2f', '#2d132c', '#1c1c1c', '#212121', '#263238', '#1b262c', '#0a1931', '#2c3333', '#3c1642'];
const LIGHT_BG_COLORS = [null, '#f0f4f8', '#e8eaf6', '#e3f2fd', '#fce4ec', '#f3e5f5', '#e0f2f1', '#fff8e1', '#efebe9', '#eceff1', '#f1f8e9', '#e8f5e9', '#fafafa'];

function getBgColors() {
  return document.documentElement.classList.contains('light') ? LIGHT_BG_COLORS : BG_COLORS;
}

function renderBgPicker() {
  let picker = document.getElementById('bg-picker');
  if (!picker) {
    picker = document.createElement('div');
    picker.className = 'bg-picker';
    picker.id = 'bg-picker';
    document.body.appendChild(picker);
  }
  picker.innerHTML = '';
  const saved = localStorage.getItem('newtab_bg');
  const colors = getBgColors();
  colors.forEach((c, i) => {
    const sw = document.createElement('div');
    sw.className = 'bg-swatch' + (i === 0 ? ' reset' : '') + ((c === saved || (i === 0 && !saved)) ? ' active' : '');
    if (c) sw.style.background = c;
    sw.title = i === 0 ? 'Default' : c;
    sw.onclick = () => {
      if (c) { localStorage.setItem('newtab_bg', c); document.body.style.background = c; }
      else { localStorage.removeItem('newtab_bg'); document.body.style.background = ''; }
      picker.querySelectorAll('.bg-swatch').forEach(s => s.classList.remove('active'));
      sw.classList.add('active');
    };
    picker.appendChild(sw);
  });
}

const savedBg = localStorage.getItem('newtab_bg');
if (savedBg) document.body.style.background = savedBg;
renderBgPicker();
</script>
</body>
</html>