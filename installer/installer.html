<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{
  width:480px;height:520px;overflow:hidden;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans',Helvetica,Arial,sans-serif;
  background:#0a0e14;color:#e2e8f0;
  user-select:none;-webkit-user-select:none;
  -webkit-font-smoothing:antialiased;
}
body{display:flex;flex-direction:column;position:relative}

/* ─── Ambient background ─── */
.bg{position:absolute;inset:0;pointer-events:none;overflow:hidden}
.bg::before{
  content:'';position:absolute;top:-40%;left:-20%;width:140%;height:140%;
  background:radial-gradient(ellipse at 35% 25%,rgba(96,165,250,0.06) 0%,transparent 55%),
             radial-gradient(ellipse at 65% 75%,rgba(96,165,250,0.03) 0%,transparent 50%);
  animation:drift 16s ease-in-out infinite alternate;
}
@keyframes drift{0%{transform:translate(0,0)}100%{transform:translate(10px,-8px)}}

/* ─── Title bar ─── */
.titlebar{
  position:relative;z-index:10;height:36px;flex-shrink:0;
  -webkit-app-region:drag;
  display:flex;align-items:center;justify-content:flex-end;padding:0 8px;
}
.tb-close{
  -webkit-app-region:no-drag;
  width:28px;height:28px;border:none;background:none;
  color:rgba(255,255,255,0.2);cursor:pointer;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  transition:all 150ms;
}
.tb-close:hover{background:rgba(220,38,38,0.12);color:#f87171}

/* ─── Content ─── */
.content{
  flex:1;display:flex;flex-direction:column;align-items:center;
  justify-content:center;position:relative;z-index:1;
  padding:0 40px 28px;gap:0;
}

/* Logo */
.logo-area{
  position:relative;margin-bottom:8px;
  animation:logoIn 0.7s cubic-bezier(0.16,1,0.3,1) both;
}
.logo-area img{height:72px;width:auto;position:relative;z-index:2;filter:drop-shadow(0 0 24px rgba(96,165,250,0.15))}
.logo-glow{
  position:absolute;inset:-24px;border-radius:50%;
  background:radial-gradient(circle,rgba(96,165,250,0.12) 0%,transparent 70%);
  animation:pulse 3s ease-in-out infinite;
}
@keyframes logoIn{from{opacity:0;transform:scale(0.8) translateY(12px)}to{opacity:1;transform:none}}
@keyframes pulse{0%,100%{opacity:0.5;transform:scale(1)}50%{opacity:1;transform:scale(1.08)}}

/* Version pill */
.ver-pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:3px 12px;border-radius:99px;
  background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);
  font-size:11px;color:rgba(255,255,255,0.35);font-weight:500;
  margin-bottom:24px;
  animation:fadeUp 0.5s 0.1s cubic-bezier(0.16,1,0.3,1) both;
}
.ver-pill .dot{width:5px;height:5px;border-radius:50%;background:#60a5fa}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* Steps */
.steps{
  display:flex;align-items:center;gap:0;margin-bottom:24px;
  animation:fadeUp 0.5s 0.15s cubic-bezier(0.16,1,0.3,1) both;
}
.step{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:500;color:rgba(255,255,255,0.15);transition:color 0.4s}
.step.active{color:rgba(255,255,255,0.5)}
.step.done{color:#34d399}
.step-num{
  width:24px;height:24px;border-radius:50%;
  border:1.5px solid rgba(255,255,255,0.06);
  display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:700;
  transition:all 0.4s cubic-bezier(0.16,1,0.3,1);
}
.step.active .step-num{border-color:rgba(96,165,250,0.3);color:#60a5fa;box-shadow:0 0 12px rgba(96,165,250,0.12)}
.step.done .step-num{border-color:rgba(52,211,153,0.3);color:#34d399;background:rgba(52,211,153,0.06)}
.step-line{width:32px;height:1px;background:rgba(255,255,255,0.04);margin:0 6px;position:relative;overflow:hidden}
.step-line::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,#60a5fa,#34d399);
  transform:scaleX(0);transform-origin:left;
  transition:transform 0.6s cubic-bezier(0.16,1,0.3,1);
}
.step-line.filled::after{transform:scaleX(1)}

/* Status */
.status{text-align:center;margin-bottom:16px;min-height:36px;animation:fadeUp 0.5s 0.2s cubic-bezier(0.16,1,0.3,1) both}
.status-main{font-size:14px;color:rgba(255,255,255,0.5);font-weight:500;transition:color 0.3s}
.status-sub{font-size:11px;color:rgba(255,255,255,0.2);margin-top:4px;transition:color 0.3s}

/* Progress */
.progress-area{width:100%;max-width:260px;margin-bottom:20px;animation:fadeUp 0.5s 0.25s cubic-bezier(0.16,1,0.3,1) both}
.progress-track{
  width:100%;height:3px;background:rgba(255,255,255,0.03);border-radius:3px;overflow:hidden;
  opacity:0;transition:opacity 0.3s;
}
.progress-track.visible{opacity:1}
.progress-fill{
  height:100%;width:0%;border-radius:3px;
  background:linear-gradient(90deg,#3b82f6,#60a5fa);
  transition:width 0.4s cubic-bezier(0.16,1,0.3,1);
  box-shadow:0 0 8px rgba(96,165,250,0.2);
}
.progress-fill.indeterminate{
  width:30%;
  animation:indeterminate 1.6s cubic-bezier(0.4,0,0.6,1) infinite;
}
@keyframes indeterminate{0%{transform:translateX(-100%)}100%{transform:translateX(433%)}}
.progress-fill.success{background:linear-gradient(90deg,#059669,#34d399);box-shadow:0 0 8px rgba(52,211,153,0.2)}
.progress-fill.error{background:linear-gradient(90deg,#dc2626,#f87171);box-shadow:0 0 8px rgba(220,38,38,0.2)}
.progress-pct{text-align:right;font-size:10px;color:rgba(255,255,255,0.15);margin-top:4px;height:14px}

/* Button */
.btn{
  width:200px;height:42px;border:none;border-radius:12px;
  font-family:inherit;font-size:13px;font-weight:600;
  cursor:pointer;letter-spacing:0.3px;
  position:relative;overflow:hidden;
  transition:all 250ms cubic-bezier(0.16,1,0.3,1);
  animation:fadeUp 0.5s 0.3s cubic-bezier(0.16,1,0.3,1) both;
  -webkit-app-region:no-drag;
  background:rgba(96,165,250,0.1);
  border:1px solid rgba(96,165,250,0.15);
  color:#60a5fa;
}
.btn:hover:not(:disabled){
  background:rgba(96,165,250,0.15);
  border-color:rgba(96,165,250,0.3);
  box-shadow:0 4px 24px rgba(96,165,250,0.1);
  transform:translateY(-1px);
}
.btn:active:not(:disabled){transform:translateY(0) scale(0.98)}
.btn:disabled{opacity:0.25;cursor:default;transform:none}
.btn.success{background:rgba(52,211,153,0.1);border-color:rgba(52,211,153,0.2);color:#34d399}
.btn.success:hover{background:rgba(52,211,153,0.15);border-color:rgba(52,211,153,0.3);box-shadow:0 4px 24px rgba(52,211,153,0.1)}

/* Path */
.install-path{
  position:absolute;bottom:12px;left:0;right:0;text-align:center;
  font-size:9px;color:rgba(255,255,255,0.06);padding:0 20px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}

/* Error */
.error-box{
  margin-top:8px;padding:8px 14px;
  background:rgba(220,38,38,0.05);border:1px solid rgba(220,38,38,0.1);
  border-radius:10px;font-size:11px;color:#f87171;
  max-width:280px;word-break:break-word;text-align:center;
}

/* Check animation */
@keyframes checkDraw{from{stroke-dashoffset:16}to{stroke-dashoffset:0}}
</style>
</head>
<body>
<div class="bg"></div>
<div class="titlebar">
  <button class="tb-close" id="x">
    <svg width="10" height="10" viewBox="0 0 10 10" stroke="currentColor" stroke-width="1.3" fill="none">
      <line x1="1.5" y1="1.5" x2="8.5" y2="8.5"/><line x1="8.5" y1="1.5" x2="1.5" y2="8.5"/>
    </svg>
  </button>
</div>
<div class="content">
  <div class="logo-area">
    <div class="logo-glow"></div>
    <img id="logo" src="" alt="GitBrowser" />
  </div>
  <div class="ver-pill"><span class="dot"></span><span id="ver">v0.3.0</span></div>

  <div class="steps">
    <div class="step active" id="s1"><div class="step-num">1</div><span id="s1l">Check</span></div>
    <div class="step-line" id="ln1"></div>
    <div class="step" id="s2"><div class="step-num">2</div><span id="s2l">Install</span></div>
    <div class="step-line" id="ln2"></div>
    <div class="step" id="s3"><div class="step-num">3</div><span id="s3l">Done</span></div>
  </div>

  <div class="status">
    <div class="status-main" id="st">Checking for updates…</div>
    <div class="status-sub" id="sub"></div>
  </div>

  <div class="progress-area">
    <div class="progress-track" id="track"><div class="progress-fill" id="bar"></div></div>
    <div class="progress-pct" id="pct"></div>
  </div>

  <button class="btn" id="btn" disabled>Install</button>
</div>
<div class="install-path" id="pathEl"></div>

<script>
const api = window.installer;
const $ = id => document.getElementById(id);

/* ─── Localization ─── */
const L = {
  en: {
    s1: 'Check', s2: 'Install', s3: 'Done',
    checking: 'Checking for updates…',
    ready: 'Ready to install',
    readySub: 'GitBrowser will be installed on your computer',
    installing: 'Installing…',
    downloading: 'Downloading…',
    extracting: 'Extracting files…',
    shortcuts: 'Creating shortcuts…',
    done: 'Installation complete',
    doneSub: 'GitBrowser is ready to use',
    launch: 'Launch GitBrowser',
    install: 'Install',
    noUpdate: 'Already up to date',
    noUpdateSub: 'You have the latest version',
    errTitle: 'Installation failed',
    errCheck: 'Could not check for updates',
  },
  ru: {
    s1: 'Проверка', s2: 'Установка', s3: 'Готово',
    checking: 'Проверка обновлений…',
    ready: 'Готов к установке',
    readySub: 'GitBrowser будет установлен на ваш компьютер',
    installing: 'Установка…',
    downloading: 'Загрузка…',
    extracting: 'Извлечение файлов…',
    shortcuts: 'Создание ярлыков…',
    done: 'Установка завершена',
    doneSub: 'GitBrowser готов к использованию',
    launch: 'Запустить GitBrowser',
    install: 'Установить',
    noUpdate: 'Обновлений нет',
    noUpdateSub: 'У вас последняя версия',
    errTitle: 'Ошибка установки',
    errCheck: 'Не удалось проверить обновления',
  }
};
const lang = (navigator.language || '').startsWith('ru') ? 'ru' : 'en';
const t = key => L[lang][key] || L.en[key] || key;

/* ─── Step management ─── */
function setStep(n) {
  [1,2,3].forEach(i => {
    const el = $('s' + i);
    el.classList.toggle('active', i === n);
    if (i < n) el.classList.add('done');
  });
  if (n >= 2) $('ln1').classList.add('filled');
  if (n >= 3) $('ln2').classList.add('filled');
}

function setStepDone(n) {
  const el = $('s' + n);
  el.classList.remove('active');
  el.classList.add('done');
}

/* ─── Progress helpers ─── */
function showProgress(mode) {
  const track = $('track');
  const bar = $('bar');
  track.classList.add('visible');
  bar.classList.remove('indeterminate', 'success', 'error');
  if (mode === 'indeterminate') {
    bar.style.width = '';
    bar.classList.add('indeterminate');
    $('pct').textContent = '';
  }
}

function setProgress(pct) {
  const bar = $('bar');
  bar.classList.remove('indeterminate');
  bar.style.width = pct + '%';
  $('pct').textContent = Math.round(pct) + '%';
}

function hideProgress() {
  $('track').classList.remove('visible');
  $('pct').textContent = '';
}

/* ─── Animated progress ─── */
let animFrame = null;
function anim(from, to, duration, cb) {
  if (animFrame) cancelAnimationFrame(animFrame);
  const start = performance.now();
  const tick = (now) => {
    const p = Math.min((now - start) / duration, 1);
    const ease = 1 - Math.pow(1 - p, 3); // easeOutCubic
    const val = from + (to - from) * ease;
    setProgress(val);
    if (p < 1) animFrame = requestAnimationFrame(tick);
    else if (cb) cb();
  };
  animFrame = requestAnimationFrame(tick);
}

/* ─── Error display ─── */
function showError(msg) {
  let box = document.querySelector('.error-box');
  if (!box) {
    box = document.createElement('div');
    box.className = 'error-box';
    $('btn').parentElement.insertBefore(box, $('btn'));
  }
  box.textContent = msg;
  $('bar').classList.add('error');
}

/* ─── Init ─── */
let downloadUrl = null;

async function init() {
  // Set labels
  $('s1l').textContent = t('s1');
  $('s2l').textContent = t('s2');
  $('s3l').textContent = t('s3');
  $('st').textContent = t('checking');

  // Load logo
  try {
    const iconPath = await api.getIconPath();
    $('logo').src = iconPath;
  } catch {}

  // Load info
  try {
    const info = await api.getInfo();
    $('ver').textContent = 'v' + info.version;
    $('pathEl').textContent = info.installDir;
  } catch {}

  // Check for updates
  showProgress('indeterminate');
  try {
    const result = await api.checkUpdate();
    hideProgress();
    setStepDone(1);

    if (result.download) {
      downloadUrl = result.download;
      $('st').textContent = t('ready');
      $('sub').textContent = t('readySub');
      $('btn').textContent = t('install');
      $('btn').disabled = false;
    } else {
      $('st').textContent = t('noUpdate');
      $('sub').textContent = t('noUpdateSub');
      $('btn').textContent = t('launch');
      $('btn').disabled = false;
      $('btn').classList.add('success');
      setStep(3);
    }
  } catch (e) {
    hideProgress();
    $('st').textContent = t('errCheck');
    showError(e.message || String(e));
    // Still allow install attempt
    $('btn').textContent = t('install');
    $('btn').disabled = false;
  }
}

/* ─── Install flow ─── */
async function doInstall() {
  const btn = $('btn');
  btn.disabled = true;
  setStep(2);

  // Phase 1: Download (0-60%)
  $('st').textContent = t('downloading');
  $('sub').textContent = '';
  showProgress('indeterminate');
  anim(0, 55, 3000);

  try {
    const result = await api.install({ downloadUrl });
    if (!result.ok) throw new Error(result.error);

    // Phase 2: Shortcuts (60-90%)
    $('st').textContent = t('shortcuts');
    anim(55, 85, 1500);
    await api.createShortcuts();

    // Phase 3: Done (90-100%)
    anim(85, 100, 600, () => {
      $('bar').classList.add('success');
    });
    setStepDone(2);
    setStep(3);

    $('st').textContent = t('done');
    $('sub').textContent = t('doneSub');
    btn.textContent = t('launch');
    btn.classList.add('success');
    btn.disabled = false;
    btn.onclick = async () => {
      btn.disabled = true;
      await api.launchApp();
    };
  } catch (e) {
    $('st').textContent = t('errTitle');
    showError(e.message || String(e));
    setProgress(100);
    $('bar').classList.add('error');
    btn.textContent = t('install');
    btn.disabled = false;
  }
}

/* ─── Button handler ─── */
$('btn').addEventListener('click', () => {
  if ($('btn').classList.contains('success')) {
    // Launch mode
    $('btn').disabled = true;
    api.launchApp();
    return;
  }
  doInstall();
});

/* ─── Close button ─── */
$('x').addEventListener('click', () => api.close());

/* ─── Start ─── */
init();
</script>
</body>
</html>
